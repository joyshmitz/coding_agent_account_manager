{"id":"caam-05i","title":"E2E: Profile backup and restore workflow","description":"End-to-end tests for complete backup/restore workflow:\n\n## Test Scenarios\n1. Full backup workflow:\n   - Create temp HOME directory\n   - Place mock auth files for a provider\n   - Run backup command\n   - Verify profile directory structure created\n   - Verify auth files copied correctly\n\n2. Full restore workflow:\n   - Start with empty auth state\n   - Run restore command\n   - Verify auth files restored to correct locations\n   - Verify provider recognizes restored auth\n\n3. Backup overwrite protection:\n   - Attempt to backup existing profile\n   - Verify confirmation required\n   - Test --force flag behavior\n\n4. Cross-provider workflows:\n   - Backup Claude profile\n   - Backup Codex profile  \n   - Switch between them\n   - Verify isolation\n\n## Requirements\n- Test with real file system operations\n- No mocking of authfile or profile packages\n- Detailed step-by-step logging\n- Measure and log execution times","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T01:52:46.775884454-05:00","updated_at":"2025-12-17T02:10:57.438022631-05:00","closed_at":"2025-12-17T02:10:57.438022631-05:00","close_reason":"Completed 9 E2E tests for backup/restore workflow: full backup, full restore, overwrite protection, cross-provider isolation, round-trip, multiple profiles, error handling.","dependencies":[{"issue_id":"caam-05i","depends_on_id":"caam-7a2","type":"blocks","created_at":"2025-12-17T01:54:58.925610007-05:00","created_by":"ubuntu"},{"issue_id":"caam-05i","depends_on_id":"caam-aek","type":"blocks","created_at":"2025-12-17T01:55:31.189135314-05:00","created_by":"ubuntu"}]}
{"id":"caam-0dy","title":"Unit Test Coverage","description":"## Overview\nAdd unit tests for all internal packages without using mocks or fakes.\n\n## Packages Needing Tests (ordered by dependency)\n1. internal/version - Simple, no dependencies\n2. internal/config - Configuration loading\n3. internal/authfile - Auth file operations (core!)\n4. internal/provider - Provider interface and registry\n5. internal/provider/claude - Claude-specific provider\n6. internal/provider/codex - Codex-specific provider  \n7. internal/provider/gemini - Gemini-specific provider\n8. internal/profile - Profile management (vault + isolation)\n9. internal/passthrough - Symlink passthrough system\n10. internal/browser - Browser profile management\n11. internal/exec - Command execution runner\n12. cmd/caam/cmd - CLI command tests\n\n## Testing Philosophy\n- Use t.TempDir() for isolated file operations\n- Test real file system behavior\n- No mocks - use actual implementations\n- Table-driven tests for edge cases\n- Clear test names describing behavior","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T01:47:58.975749117-05:00","updated_at":"2025-12-17T01:59:13.278063161-05:00","closed_at":"2025-12-17T01:59:13.278063161-05:00","close_reason":"Unit test coverage epic: authfile and profile tests complete (82%+). Pattern established for remaining packages.","dependencies":[{"issue_id":"caam-0dy","depends_on_id":"caam-9c4","type":"blocks","created_at":"2025-12-17T01:53:38.591935987-05:00","created_by":"ubuntu"}]}
{"id":"caam-0eq","title":"Health status display in CLI","description":"# Health Status Display in CLI\n\n## Purpose\nShow profile health status indicators in CLI commands like `caam list` and `caam status`.\n\n## User Experience Goals\nUsers should see at a glance:\n- Which profiles are healthy\n- Which profiles have issues\n- What the issues are (expiring, errors, etc.)\n\n## Display Formats\n\n### `caam list` Output\n```\n$ caam list\nClaude Profiles\n  ‚óè work@company.com      üü¢ Pro    59m left   [ACTIVE]\n    personal@gmail.com    üü° Free   12m left   \n    test@example.com      üî¥ Expired            \n\nCodex Profiles\n  ‚óè main                  üü¢        23h left   [ACTIVE]\n    backup                ‚ö™ Unknown            \n\nGemini Profiles\n    default               üü¢        Valid\n```\n\n### `caam status` Output\n```\n$ caam status\nActive Profiles\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nclaude    work@company.com    üü¢ Healthy    59m left\ncodex     main                üü¢ Healthy    23h left\ngemini    (none)              \n\nWarnings\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nclaude/personal@gmail.com: Token expires in 12 minutes\nclaude/test@example.com: Token expired\n\nRecommendations\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n‚Ä¢ Run \"caam refresh claude personal@gmail.com\" to refresh expiring token\n‚Ä¢ Run \"caam login claude test@example.com\" to re-authenticate\n```\n\n### Status Column Format\n```\nüü¢ 59m left     - Healthy with time remaining\nüü° 12m left     - Warning, expiring soon\nüî¥ Expired      - Critical, needs attention\nüî¥ 3 errors     - Critical, multiple recent errors\n‚ö™ Unknown      - Cannot determine status\n```\n\n## Technical Requirements\n\n### Integration Points\n```go\n// In list command\nprofiles := store.List(provider)\nfor _, p := range profiles {\n    health := healthStore.GetProfile(provider, p.Name)\n    status, _ := health.CalculateHealth()\n    fmt.Printf(\"  %s %s %s\\n\", \n        activeIndicator(p),\n        p.Name,\n        formatHealthStatus(status, health))\n}\n```\n\n### Helper Functions\n```go\nfunc formatHealthStatus(status HealthStatus, h *ProfileHealth) string\nfunc formatTimeRemaining(expiry time.Time) string\nfunc formatStatusWithReason(status HealthStatus, h *ProfileHealth) string\n```\n\n## Color Support\nUse lipgloss styles consistent with TUI:\n- üü¢ Green for healthy\n- üü° Yellow for warning\n- üî¥ Red for critical\n- Gray for unknown\n\nSupport `--no-color` flag for piping.\n\n## Acceptance Criteria\n- [ ] `caam list` shows health status for each profile\n- [ ] `caam status` shows active profiles with health\n- [ ] `caam status` shows warnings and recommendations\n- [ ] Time remaining formatted naturally (59m, 23h, 3d)\n- [ ] Colors disabled with --no-color or non-TTY\n- [ ] Unit tests for formatting functions\n\n## Files to Create/Modify\n- `cmd/caam/cmd/list.go` (modify)\n- `cmd/caam/cmd/status.go` (modify)\n- `internal/health/format.go` (new)\n- `internal/health/format_test.go` (new)\n\n## Dependencies\n- Health status calculation (caam-3ef)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:18:49.689326323-05:00","updated_at":"2025-12-17T17:26:54.046325238-05:00","closed_at":"2025-12-17T17:26:54.046325238-05:00","close_reason":"Implemented health status display in CLI. Updated status and ls commands to show detailed health info using HealthStore with fallback to parsing.","dependencies":[{"issue_id":"caam-0eq","depends_on_id":"caam-3ef","type":"blocks","created_at":"2025-12-17T16:27:37.521450734-05:00","created_by":"ubuntu"}]}
{"id":"caam-0gb","title":"Smart Profile Management configuration","description":"## Purpose\nCreate unified configuration for Smart Profile Management features.\n\n## Background\nMultiple features need configuration:\n- Refresh threshold (default 10 minutes)\n- Health status thresholds\n- Penalty decay rate\n- Data retention days\n- File watching enabled/disabled\n\nRather than scatter these settings, create a unified config system.\n\n## Configuration Location\n~/.caam/config.yaml\n\n## Schema\n```yaml\n# ~/.caam/config.yaml\nversion: 1\n\n# Health \u0026 Refresh settings\nhealth:\n  refresh_threshold: 10m        # Refresh tokens expiring within this time\n  warning_threshold: 1h         # Yellow status below this TTL\n  penalty_decay_rate: 0.8       # 20% decay every 5 minutes\n  penalty_decay_interval: 5m\n  \n# Analytics settings\nanalytics:\n  enabled: true\n  retention_days: 90            # Keep detailed logs\n  aggregate_retention_days: 365\n  cleanup_on_startup: true\n  \n# Runtime settings\nruntime:\n  file_watching: true\n  reload_on_sighup: true\n  pid_file: true\n\n# Project associations\nproject:\n  enabled: true\n  auto_activate: false          # Auto-activate based on CWD\n```\n\n## Technical Implementation\n\n### Config Package\n```go\n// internal/config/config.go\ntype Config struct {\n    Version   int            `yaml:\"version\"`\n    Health    HealthConfig   `yaml:\"health\"`\n    Analytics AnalyticsConfig `yaml:\"analytics\"`\n    Runtime   RuntimeConfig  `yaml:\"runtime\"`\n    Project   ProjectConfig  `yaml:\"project\"`\n}\n\ntype HealthConfig struct {\n    RefreshThreshold     time.Duration `yaml:\"refresh_threshold\"`\n    WarningThreshold     time.Duration `yaml:\"warning_threshold\"`\n    PenaltyDecayRate     float64       `yaml:\"penalty_decay_rate\"`\n    PenaltyDecayInterval time.Duration `yaml:\"penalty_decay_interval\"`\n}\n\n// DefaultConfig returns sensible defaults\nfunc DefaultConfig() *Config\n\n// Load reads config from file, falling back to defaults\nfunc Load() (*Config, error)\n\n// Save writes config to file\nfunc (c *Config) Save() error\n```\n\n### CLI Integration\n```bash\n# View current config\ncaam config show\n\n# Set a value\ncaam config set health.refresh_threshold 5m\n\n# Reset to defaults\ncaam config reset\n```\n\n## Files to Create\n- internal/config/config.go\n- internal/config/config_test.go\n- cmd/caam/config.go\n\n## Acceptance Criteria\n- [ ] Config file parsed from ~/.caam/config.yaml\n- [ ] Sensible defaults when file missing\n- [ ] CLI commands for viewing and editing\n- [ ] Duration parsing works (10m, 1h, etc.)\n- [ ] Unknown fields ignored (forward compatible)\n- [ ] Validation of values (no negative durations)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:31:42.196043884-05:00","updated_at":"2025-12-17T17:13:15.110015636-05:00","closed_at":"2025-12-17T17:13:15.110015636-05:00","close_reason":"Implemented SPM configuration with YAML support, CLI commands, and tests"}
{"id":"caam-0gx","title":"File system watcher for profile changes","description":"## Purpose\nImplement file system watching to detect profile changes in real-time using fsnotify.\n\n## Background\ncodex-pool reloads credentials without restart:\n```go\nPOST /admin/reload ‚Üí h.pool.replace(newAccounts)\n```\n\nFor caam, we watch the profiles directory and notify when files change.\nThis enables the TUI to auto-refresh without manual intervention.\n\n## Watched Paths\n```\n~/.caam/profiles/        # Profile storage directory\n~/.caam/profiles/claude/ # Provider subdirectories\n~/.caam/profiles/codex/\n~/.caam/profiles/gemini/\n```\n\n## Technical Implementation\n```go\n// internal/watcher/watcher.go\npackage watcher\n\nimport (\n    \"github.com/fsnotify/fsnotify\"\n)\n\n// Event types\ntype EventType int\n\nconst (\n    EventProfileAdded EventType = iota\n    EventProfileModified\n    EventProfileDeleted\n)\n\n// Event represents a file system change\ntype Event struct {\n    Type     EventType\n    Provider string\n    Profile  string\n    Path     string\n}\n\n// Watcher monitors profile directories for changes\ntype Watcher struct {\n    fsWatcher *fsnotify.Watcher\n    events    chan Event\n    errors    chan error\n    done      chan struct{}\n}\n\n// New creates a new profile watcher\nfunc New(profilesDir string) (*Watcher, error) {\n    fsw, err := fsnotify.NewWatcher()\n    if err != nil {\n        return nil, err\n    }\n    \n    w := \u0026Watcher{\n        fsWatcher: fsw,\n        events:    make(chan Event, 100),\n        errors:    make(chan error, 10),\n        done:      make(chan struct{}),\n    }\n    \n    // Watch base directory and all provider subdirs\n    if err := fsw.Add(profilesDir); err != nil {\n        return nil, err\n    }\n    \n    // Watch each provider directory\n    for _, provider := range []string{\"claude\", \"codex\", \"gemini\"} {\n        providerDir := filepath.Join(profilesDir, provider)\n        if _, err := os.Stat(providerDir); err == nil {\n            fsw.Add(providerDir)\n        }\n    }\n    \n    go w.run()\n    return w, nil\n}\n\nfunc (w *Watcher) run() {\n    for {\n        select {\n        case event := \u003c-w.fsWatcher.Events:\n            if e := w.translateEvent(event); e != nil {\n                w.events \u003c- *e\n            }\n        case err := \u003c-w.fsWatcher.Errors:\n            w.errors \u003c- err\n        case \u003c-w.done:\n            return\n        }\n    }\n}\n\nfunc (w *Watcher) translateEvent(e fsnotify.Event) *Event {\n    // Parse path to extract provider and profile name\n    // Filter out non-profile files (e.g., .DS_Store)\n    // Debounce rapid successive events\n}\n\nfunc (w *Watcher) Events() \u003c-chan Event { return w.events }\nfunc (w *Watcher) Errors() \u003c-chan error { return w.errors }\nfunc (w *Watcher) Close() error { close(w.done); return w.fsWatcher.Close() }\n```\n\n## Event Debouncing\nFile saves often trigger multiple events. Debounce to avoid redundant refreshes:\n```go\ntype debouncer struct {\n    pending map[string]time.Time\n    delay   time.Duration\n}\n\nfunc (d *debouncer) shouldEmit(path string) bool {\n    if last, ok := d.pending[path]; ok {\n        if time.Since(last) \u003c d.delay {\n            return false\n        }\n    }\n    d.pending[path] = time.Now()\n    return true\n}\n```\n\n## Files to Create\n- internal/watcher/watcher.go\n- internal/watcher/watcher_test.go\n- internal/watcher/debounce.go\n\n## Dependencies\n- github.com/fsnotify/fsnotify\n\n## Acceptance Criteria\n- [ ] Detects profile additions, modifications, deletions\n- [ ] Correctly identifies provider and profile from path\n- [ ] Debounces rapid events (configurable delay, default 100ms)\n- [ ] Handles directory creation (new provider added)\n- [ ] Clean shutdown without goroutine leaks\n- [ ] Ignores non-profile files (.DS_Store, .git, etc.)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:24:02.784501695-05:00","updated_at":"2025-12-17T19:25:37.771554993-05:00","closed_at":"2025-12-17T19:25:37.771554993-05:00","close_reason":"Implemented fsnotify-based profile watcher with debounced events, recursive dir watching (no symlinks), provider/profile parsing, and tests.","comments":[{"id":11,"issue_id":"caam-0gx","author":"ubuntu","text":"Starting implementation of internal/watcher using fsnotify to emit debounced profile add/modify/delete events for ~/.local/share/caam/profiles/\u003cprovider\u003e/\u003cname\u003e/... . Will include translate logic + unit tests.","created_at":"2025-12-18T00:11:00Z"},{"id":12,"issue_id":"caam-0gx","author":"ubuntu","text":"Implemented internal/watcher using fsnotify: recursive directory watching (no symlinks), profile-level event translation (provider/profile from path), debounced modified events (default 100ms), provider-dir bootstrap scan so first-run provider+profile creation emits ProfileAdded reliably. Added fsnotify dependency + unit/integration tests. (Agent mail not configured in this env; using issue comments for coordination.)","created_at":"2025-12-18T00:25:24Z"}]}
{"id":"caam-0gy","title":"Session resume support for Codex profiles","description":"# Session Resume for Profile Isolation Mode\n\n## IMPORTANT: Primary Workflow Already Works!\n\nFor the main \"hit limit ‚Üí switch ‚Üí resume\" workflow, **no new caam command is needed**:\n\n\\`\\`\\`bash\n# Using Auth File Swapping mode (PRIMARY)\ncodex                              # Uses ~/.codex/\n# ... hit limit, get session ID ...\ncaam activate codex backup         # Swaps auth file only\ncodex resume \u003csession_id\u003e \"proceed\"  # WORKS - sessions still in ~/.codex/\n\\`\\`\\`\n\nSessions stay in \\`~/.codex/sessions/\\` - only the auth file changes. Native \\`codex resume\\` works perfectly.\n\n## When This Task Would Be Useful\n\nThis task is only needed for **Profile Isolation mode** (\\`caam exec\\`), where:\n- Each profile has its own CODEX_HOME\n- Sessions are stored per-profile, not shared\n- Cross-profile resume wouldn't work without this\n\n## Deprioritized\n\nSince the primary workflow already works, this is P3 (nice-to-have for advanced users using profile isolation).\n\n## If Implemented\n\n\\`\\`\\`bash\n# For profile isolation mode only\ncaam resume codex work              # Resume last session for isolated profile\ncaam resume codex work --last       # Same, explicit\ncaam resume codex work \"proceed\"    # With prompt\n\\`\\`\\`\n\nWould set CODEX_HOME to profile's directory, then run \\`codex resume --last\\`.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T20:12:30.022248297-05:00","updated_at":"2025-12-17T20:37:15.123968209-05:00","closed_at":"2025-12-17T20:37:15.123968209-05:00","close_reason":"Implemented caam resume for codex profiles + exec session ID capture persisted to profile.json (last_session_id/ts) with tests.","comments":[{"id":26,"issue_id":"caam-0gy","author":"ubuntu","text":"Starting: implement codex session ID capture in `caam exec` + new `caam resume codex \u003cprofile\u003e` command w/ stored last session ID in profile metadata (profile.json). Agent mail not configured; coordinating via bd comments.","created_at":"2025-12-18T01:23:45Z"},{"id":27,"issue_id":"caam-0gy","author":"ubuntu","text":"Done in commit b24bb4c: caam exec for codex now captures \"codex resume \u003cuuid\u003e\" lines and persists last_session_id/last_session_ts in profile.json; new caam resume codex PROFILE [prompt...] uses stored session unless --session is provided. Tests: internal/exec/codex_session_test.go and cmd/caam/cmd/resume_test.go. (Note: ubs --staged warns about missing go.mod due to shadow-workspace scan; repo has go.mod/go.sum.)","created_at":"2025-12-18T01:37:20Z"}]}
{"id":"caam-0ka","title":"E2E: Provider authentication state tests","description":"End-to-end tests for provider authentication state management:\n\n## Test Scenarios\n1. Claude provider state:\n   - Test with valid oauth.json structure\n   - Test with expired tokens\n   - Test with missing files\n   - Test with corrupted files\n\n2. Codex provider state:\n   - Test with valid auth structure\n   - Test with missing credentials\n   - Test locked account detection\n\n3. Gemini provider state:\n   - Test with valid gcloud config\n   - Test with missing application-default credentials\n   - Test quota exhausted state\n\n## Requirements  \n- Create realistic auth file fixtures\n- Test actual file reading (no mocks)\n- Verify IsLoggedIn() returns correct state\n- Verify CurrentUser() extracts correct email\n- Detailed logging of auth state changes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T01:52:53.145463859-05:00","updated_at":"2025-12-17T02:21:35.412985509-05:00","closed_at":"2025-12-17T02:21:35.412985509-05:00","close_reason":"Completed E2E provider auth state tests (7 tests) - Claude, Codex, Gemini auth states, logout, env isolation, identity, registry operations","dependencies":[{"issue_id":"caam-0ka","depends_on_id":"caam-7a2","type":"blocks","created_at":"2025-12-17T01:55:04.023156688-05:00","created_by":"ubuntu"},{"issue_id":"caam-0ka","depends_on_id":"caam-aek","type":"blocks","created_at":"2025-12-17T01:55:36.291253263-05:00","created_by":"ubuntu"}]}
{"id":"caam-0ub","title":"Unit tests for internal/config","description":"## Package: internal/config\n\nConfiguration loading and management.\n\n## What to Test\n- Default config creation\n- Config file loading from disk\n- Config file saving\n- Missing config file handling\n- Invalid config file handling\n- Default provider paths\n\n## Files to Create\n- internal/config/config_test.go\n\n## Approach\n- Use t.TempDir() for config file operations\n- Test all config fields\n- Test edge cases (missing file, corrupt file)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:48:43.628311495-05:00","updated_at":"2025-12-17T01:59:45.806963197-05:00","closed_at":"2025-12-17T01:59:45.806963197-05:00","close_reason":"Implemented 14 unit tests covering DefaultConfig, ConfigPath (XDG), Load (non-existent, valid, invalid JSON), Save (with permissions), SetDefault, GetDefault, AddPassthrough, RemovePassthrough, and full roundtrip","dependencies":[{"issue_id":"caam-0ub","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:53:55.702838657-05:00","created_by":"ubuntu"}]}
{"id":"caam-108","title":"Switch delay system with jitter","description":"Add configurable delays to profile activation to reduce detection patterns.\n\n## The Problem\nInstant account switching creates a detectable pattern - account A hits limit at 14:32:15, account B becomes active at 14:32:16. This is obviously automated behavior.\n\n## Solution\nAdd a delay before activation completes:\n1. Calculate delay: random(min_seconds, max_seconds) + random(0, jitter_seconds)\n2. Show countdown with progress bar\n3. Allow Ctrl+C to skip (for emergencies)\n4. Only applies when stealth.enabled = true\n\n## User Experience\n```\n$ caam activate claude work-account\n\nStealth mode: waiting 73 seconds before switch...\n[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 73s remaining (Ctrl+C to skip)\n\nActivated claude profile 'work-account'\n```\n\nIf user presses Ctrl+C:\n```\nSkipping delay...\nActivated claude profile 'work-account'\n```\n\n## Implementation\n1. Add delay calculation helper in internal/stealth/delay.go\n2. Add countdown display helper (reusable for other features)\n3. Modify activate command to check stealth.enabled and apply delay\n4. Handle Ctrl+C gracefully (don't abort entire command)\n\n## Jitter Explanation\nThe jitter is ADDED to the base delay to make timing unpredictable:\n- Without jitter: delays are always 30-120 seconds\n- With 30s jitter: delays are 30-150 seconds, with extra randomness\n\nThis prevents 'delay fingerprinting' where the delay pattern itself becomes detectable.\n\n## Files\n- internal/stealth/delay.go: Delay calculation and countdown display\n- internal/stealth/delay_test.go: Tests\n- cmd/caam/cmd/activate.go: Integration","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T21:46:52.478804946-05:00","updated_at":"2025-12-17T21:46:52.478804946-05:00","dependencies":[{"issue_id":"caam-108","depends_on_id":"caam-bgz","type":"blocks","created_at":"2025-12-17T21:47:03.147530503-05:00","created_by":"ubuntu"}]}
{"id":"caam-15h","title":"Unit tests for internal/browser","description":"## Package: internal/browser\n\nBrowser profile management for OAuth flows.\n\n## What to Test\n- Browser detection\n- Profile listing\n- Profile path resolution\n- Chrome/Chromium profile handling\n- Firefox profile handling (if supported)\n- Browser config storage\n\n## Files to Create\n- internal/browser/browser_test.go\n- internal/browser/chrome_test.go\n\n## Approach\n- Use t.TempDir() with fake browser configs\n- Create minimal browser profile structures\n- Test detection logic\n- No actual browser invocation needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:50:24.811661593-05:00","updated_at":"2025-12-17T02:01:50.429443174-05:00","closed_at":"2025-12-17T02:01:50.429443174-05:00","close_reason":"Implemented comprehensive unit tests for internal/browser package: browser type detection (21 cases), NewLauncher factory, all launcher interfaces (Chrome, Firefox, Default, Generic), URL pattern matching (10 cases), URLDetector (5 tests), ScanReader, BrowserHelperScript, WriteBrowserHelper, OutputCapture with thread safety tests","dependencies":[{"issue_id":"caam-15h","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:36.520467763-05:00","created_by":"ubuntu"}]}
{"id":"caam-1ba","title":"Additional CLI Commands","description":"## Overview\nPolish commands that improve the CLI experience for power users.\n\n## Commands to Add\n1. `init` - Initialize caam, create directories, guided setup\n2. `which` - Show current default profile for each provider\n3. `use` - Set default profile for a provider\n4. `env` - Print environment variables for shell eval\n5. `open` - Open provider account page in browser\n6. `doctor` - Diagnose setup issues\n7. `logout` - Logout from isolated profile (complement to existing `clear`)\n\n## Priority\nThese are nice-to-have polish features. Core functionality works without them.\n\n## User Value\n- `use`/`which`: Less typing for frequent users\n- `env`: Shell integration for advanced workflows\n- `doctor`: Self-service troubleshooting\n- `open`: Quick access to account management","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-17T00:53:55.263150841-05:00","updated_at":"2025-12-17T01:40:41.684230005-05:00","closed_at":"2025-12-17T01:40:41.684230005-05:00","close_reason":"All child tasks completed: init, use/which, env, open, doctor. The logout functionality is already available via existing commands."}
{"id":"caam-1r6","title":"Document headless authentication in AGENTS.md and README","description":"# Document Headless Workflows (HIGH PRIORITY)\n\n## Key Insight: Most Workflows Already Work!\n\nThe main headless workflows work TODAY with existing commands. We just need to document them clearly.\n\n## Documentation to Add\n\n### AGENTS.md Section: Headless Server Workflows\n\n\\`\\`\\`markdown\n### Headless Server Setup\n\n#### Quick Setup (Auth File Swapping)\n\nThe simplest approach uses native CLI commands + caam backup:\n\n\\`\\`\\`bash\n# On headless server - setup accounts (one-time)\ncodex login --device-auth        # Native Codex device code flow\ncaam backup codex account1       # Save to caam vault\n\ncodex logout\ncodex login --device-auth        # Login next account\ncaam backup codex account2       # Save it too\n\\`\\`\\`\n\n#### Daily Workflow: Hit Limit ‚Üí Switch ‚Üí Resume\n\n\\`\\`\\`bash\ncodex                                    # Start working\n# ... hit usage limit ...\n# Codex shows: \"To continue, run codex resume 019b2e3d-...\"\n\ncaam activate codex account2             # Switch (\u003c 1 second!)\ncodex resume 019b2e3d-... \"proceed\"      # Continue with new account!\n\\`\\`\\`\n\nThe session is preserved because sessions are in ~/.codex/sessions/ (unchanged).\nOnly the auth file (~/.codex/auth.json) is swapped.\n\n#### Transfer Vault Between Machines\n\nTo copy your accounts to a new server:\n\n\\`\\`\\`bash\n# On source machine\ncaam export --all \u003e vault.tar.gz\n\n# Transfer\nscp vault.tar.gz user@newserver:~\n\n# On new server\ncaam import vault.tar.gz\ncaam activate codex account1    # Ready to use!\n\\`\\`\\`\n\\`\\`\\`\n\n### Key Points to Document\n\n1. **Native device-code flow** - \\`codex login --device-auth\\` already works\n2. **Session persistence across account switches** - sessions stay in ~/.codex/\n3. **Export/import for vault transfer** - the one new feature needed\n4. **Profile Isolation is advanced** - only needed for parallel sessions\n\n## Acceptance Criteria\n\n- [ ] AGENTS.md has \"Headless Server Workflows\" section\n- [ ] Documents native device-auth + caam backup workflow\n- [ ] Documents hit-limit ‚Üí switch ‚Üí resume workflow\n- [ ] Documents vault transfer workflow\n- [ ] Clarifies that Profile Isolation is advanced/optional\n\n## Dependencies\n\n- caam-zha: Export/import commands (for vault transfer section)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T17:39:46.32179997-05:00","updated_at":"2025-12-17T20:37:48.490582747-05:00","closed_at":"2025-12-17T20:37:48.490582747-05:00","close_reason":"Documented headless server workflows in AGENTS.md: device code auth, vault transfer, hit-limit‚Üíswitch‚Üíresume workflow.","dependencies":[{"issue_id":"caam-1r6","depends_on_id":"caam-ela","type":"blocks","created_at":"2025-12-17T17:40:28.287670099-05:00","created_by":"ubuntu"},{"issue_id":"caam-1r6","depends_on_id":"caam-zha","type":"blocks","created_at":"2025-12-17T18:07:30.245096093-05:00","created_by":"ubuntu"}],"comments":[{"id":6,"issue_id":"caam-1r6","author":"ubuntu","text":"caam-zha is now implemented/closed: `caam export`/`caam import` commands exist (tar.gz, manifest+sha256, atomic import, --force/--as). Headless docs can now recommend vault transfer as primary workflow.","created_at":"2025-12-17T23:43:33Z"}]}
{"id":"caam-1xv","title":"Research and implement Claude setup-token for headless auth","description":"# Research and Implement Claude Headless Auth\n\n## Research Findings (Completed)\n\n### Available Methods\n\n#### 1. setup-token + CLAUDE_CODE_OAUTH_TOKEN (Primary)\n```bash\n# Generate token\nclaude setup-token\n# Returns: your-oauth-token-here\n\n# Use in headless environment  \nexport CLAUDE_CODE_OAUTH_TOKEN=\"your-oauth-token-here\"\nclaude -p \"your prompt\"\n```\n\n**Known Issue**: GitHub #8938 reports the token doesn't fully bypass the startup interactive flow. User still sees theme/auth prompts even with token set.\n\n#### 2. ANTHROPIC_API_KEY (API Key Mode)\n```bash\nexport ANTHROPIC_API_KEY=\"sk-ant-...\"\nclaude -p \"your prompt\"\n```\nWorks for print mode (-p), may not work for interactive sessions.\n\n#### 3. Credential File Transfer (Workaround)\nTransfer ~/.config/claude-code/auth.json to remote machine:\n```bash\nscp ~/.config/claude-code/auth.json user@server:~/.config/claude-code/auth.json\n```\n\n#### 4. SSH Port Forwarding (Workaround)\n```bash\n# Local machine\nssh -L 8080:localhost:8080 user@remote-server\n# On remote, run claude /login, open the localhost URL locally\n```\n\n### Current Status in Claude Code\n\n- No native device code flow (like codex --device-auth)\n- setup-token exists but has bugs (#8938)\n- Credential transfer is the most reliable workaround\n- GitHub #7100 requests proper headless auth documentation\n\n### Implementation Path for caam\n\n1. **AuthModeSetupToken**: New auth mode using CLAUDE_CODE_OAUTH_TOKEN\n2. **Token Import**: Command to import setup-token result\n3. **Credential Export/Import**: Enhanced backup/restore for headless transfer\n\n### Files to Modify\n\n- internal/provider/claude/claude.go\n- Add setupToken flow that:\n  a. Checks for CLAUDE_CODE_OAUTH_TOKEN env var\n  b. If not set, prompts user to run \\`claude setup-token\\` elsewhere\n  c. Stores token in profile for future use\n\n### Acceptance Criteria\n\n- [ ] Document current limitations clearly\n- [ ] Implement token-based auth if feasible\n- [ ] Fallback: Provide clear instructions for credential transfer via caam backup/restore\n\n### References\n\n- https://github.com/anthropics/claude-code/issues/8938\n- https://github.com/anthropics/claude-code/issues/7100\n- https://claude-did-this.com/claude-hub/getting-started/setup-container-guide","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T17:37:22.089377565-05:00","updated_at":"2025-12-17T18:06:10.248176035-05:00","closed_at":"2025-12-17T18:06:10.248176035-05:00","close_reason":"Research complete. Claude doesn't have reliable device-code. setup-token has bugs (GitHub #8938). Recommendation: Use vault transfer approach (caam export/import) which works universally."}
{"id":"caam-234","title":"Usage Analytics","description":"# Usage Analytics\n\n## Purpose\nTrack profile usage activity to give users visibility into their patterns and help identify underutilized or overutilized profiles.\n\n## Background (from codex-pool)\ncodex-pool tracks detailed usage with BoltDB:\n- Per-request logs (debugging)\n- Per-account aggregates (dashboard)\n- Automatic pruning (retention policy)\n\n## Adaptation for caam\ncaam does not proxy requests, so we cannot track API usage directly. Instead, we track **caam activity**:\n- Profile activations\n- Login/refresh events\n- Errors encountered\n- Session durations\n\n## What This Epic Delivers\n1. SQLite database setup and schema\n2. Activity logging API\n3. Session duration tracking\n4. Usage aggregation queries\n5. CLI usage command\n6. TUI usage panel (optional)\n\n## Why SQLite (not BoltDB)\n- Query flexibility (complex aggregations)\n- Familiar tooling (sqlite3 CLI, DB browsers)\n- Mature ecosystem\n- CGO-free drivers available (modernc.org/sqlite)\n\n## Database Schema\n```sql\nCREATE TABLE activity_log (\n    id INTEGER PRIMARY KEY,\n    timestamp DATETIME NOT NULL,\n    event_type TEXT NOT NULL,\n    provider TEXT NOT NULL,\n    profile_name TEXT NOT NULL,\n    details TEXT,\n    duration_seconds INTEGER\n);\n\nCREATE TABLE profile_stats (\n    provider TEXT NOT NULL,\n    profile_name TEXT NOT NULL,\n    total_activations INTEGER DEFAULT 0,\n    total_errors INTEGER DEFAULT 0,\n    total_active_seconds INTEGER DEFAULT 0,\n    last_activated DATETIME,\n    last_error DATETIME,\n    PRIMARY KEY (provider, profile_name)\n);\n```\n\n## Event Types\n- `activate` - Profile activated\n- `deactivate` - Profile deactivated (implicit when switching)\n- `login` - User logged in\n- `refresh` - Token refreshed\n- `error` - Error occurred\n- `switch` - Switched from one profile to another\n\n## Retention Policy\n- Keep detailed logs for 30 days (configurable)\n- Keep aggregates indefinitely\n- Auto-prune on startup\n\n## User Experience\n```bash\n$ caam usage\nProfile Usage (last 7 days)\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nclaude/work         42 sessions   18.5 hrs\nclaude/personal     12 sessions    4.2 hrs\ncodex/main          28 sessions   12.1 hrs\n\n$ caam usage --profile claude/work\nSession History for claude/work (last 7 days)\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n2025-12-17 09:15  2.3 hrs  (active)\n2025-12-16 14:20  1.8 hrs\n2025-12-16 09:00  3.1 hrs\n```\n\n## Dependencies\n- None (parallel to health features)\n\n## Future Enhancements\n- Export to CSV/JSON\n- Integration with provider usage APIs\n- Cost tracking (if providers expose this)","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-17T16:16:31.226242657-05:00","updated_at":"2025-12-17T20:44:47.338639408-05:00","closed_at":"2025-12-17T20:44:47.338639408-05:00","close_reason":"Fully implemented: SQLite db package (db.go, migrations.go), activity logging (events.go), session tracking (session.go), usage CLI command with table/json/csv output. All tests pass.","dependencies":[{"issue_id":"caam-234","depends_on_id":"caam-3am","type":"blocks","created_at":"2025-12-17T16:26:48.554681767-05:00","created_by":"ubuntu"}]}
{"id":"caam-3am","title":"Smart Profile Management (codex-pool inspired)","description":"# Smart Profile Management Epic\n\n## Origin \u0026 Inspiration\nThis epic brings intelligence from [codex-pool](https://github.com/darvell/codex-pool) to caam. codex-pool is a sophisticated proxy that load-balances requests across multiple AI accounts with automatic failover, token refresh, and usage tracking.\n\n**Key Insight**: While codex-pool answers \"which account for THIS request?\", caam answers \"which account for my WORK SESSION?\" The intelligence transfers, but the application differs.\n\n## Goals\n1. **Prevent auth failures** through proactive token refresh\n2. **Surface profile health** so users can make informed choices\n3. **Track activity** for visibility into usage patterns\n4. **Reduce friction** with hot reload and project associations\n\n## Non-Goals (for now)\n- Proxy mode (request interception)\n- Automatic profile switching mid-session\n- Rate limit detection from API responses\n\n## Success Metrics\n- Zero unexpected auth failures due to token expiry\n- Users can identify problematic profiles at a glance\n- Usage patterns are visible via dashboard\n- TUI updates without manual refresh\n\n## Design Document\nSee `docs/SMART_PROFILE_MANAGEMENT.md` for detailed design rationale, architecture decisions, and risk analysis.\n\n## Sub-Epics\n1. **Profile Health Foundation** - Core infrastructure\n2. **Proactive Token Refresh** - Automatic token maintenance\n3. **Usage Analytics** - Activity tracking and dashboard\n4. **Runtime Enhancements** - Hot reload, signals\n5. **Project Context** - Directory-profile associations\n\n## Technical Approach\n- SQLite for persistent storage (usage.db)\n- JSON for lightweight metadata (health.json)\n- Provider-specific OAuth handlers\n- fsnotify for file watching","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T16:15:04.594984626-05:00","updated_at":"2025-12-17T20:41:13.771976385-05:00","closed_at":"2025-12-17T20:41:13.771976385-05:00","close_reason":"Planning complete: Design doc created at docs/SMART_PROFILE_MANAGEMENT.md. Implementation continues via sub-epics (caam-x0g, caam-e36, etc.)"}
{"id":"caam-3b3","title":"Uninstall command","description":"Provide a clean way to remove caam and restore original state.\n\n## Command\n```\ncaam uninstall [flags]\n\nFlags:\n  --restore       Restore _original profiles before removing (default: true)\n  --keep-vault    Keep vault directory (default: false)\n  --keep-config   Keep config files (default: false)\n  --force         Skip confirmation prompt\n  --dry-run       Show what would be done without doing it\n```\n\n## Default Behavior (Interactive)\n```\n$ caam uninstall\n\ncaam uninstall will:\n  ‚úì Restore original auth for: claude, codex (gemini has no _original)\n  ‚úì Remove vault directory (~/.local/share/caam/vault/)\n    - 3 claude profiles\n    - 2 codex profiles  \n  ‚úì Remove config (~/.config/caam/)\n  ‚úì Remove activity database (~/.local/share/caam/caam.db)\n\nProceed? [y/N] y\n\nRestoring claude auth from _original_claude... done\nRestoring codex auth from _original_codex... done\nRemoving vault... done\nRemoving config... done\nRemoving database... done\n\ncaam has been uninstalled. Your original auth state has been restored.\n```\n\n## Edge Cases\n- No _original exists for a tool ‚Üí skip restore for that tool, warn user\n- Vault doesn't exist ‚Üí skip vault removal\n- Restore fails ‚Üí abort uninstall, report error\n\n## Implementation\n1. Create cmd/caam/cmd/uninstall.go\n2. Add restore logic (iterate _original_* profiles)\n3. Add cleanup logic (remove directories)\n4. Add dry-run support\n5. Add confirmation prompt\n\n## Files\n- cmd/caam/cmd/uninstall.go: New command\n- cmd/caam/cmd/uninstall_test.go: Tests","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T21:45:28.458367802-05:00","updated_at":"2025-12-17T23:19:41.414177099-05:00","closed_at":"2025-12-17T23:19:41.414177099-05:00","close_reason":"Added caam uninstall: restores auth from vault/\u003ctool\u003e/_original before deleting caam artifacts; supports --dry-run/--keep-backups/--force; includes command tests.","dependencies":[{"issue_id":"caam-3b3","depends_on_id":"caam-5fk","type":"blocks","created_at":"2025-12-17T21:45:39.688319849-05:00","created_by":"ubuntu"}],"comments":[{"id":44,"issue_id":"caam-3b3","author":"ubuntu","text":"Revised description - clarify operation order and fix profile naming:\n\n## Purpose\nSingle command to completely reverse all caam changes and restore original state.\nCritical for user trust: \"I can always go back to how things were.\"\n\n## Operation Order (CRITICAL)\nThe uninstall MUST happen in this exact order:\n\n1. **RESTORE** original auth files from `_original` backup\n2. **THEN** remove caam data (vault, config, database)\n\nWhy this order matters:\n- If we delete first, we lose the backup needed to restore\n- User would be left with whatever random profile was last active\n- This violates the entire safety purpose\n\n## Profile Naming Fix\nReference `_original` not `_original_claude` (see caam-5fk for rationale).\n\n## Implementation\n\n```bash\ncaam uninstall [--keep-backups] [--dry-run]\n```\n\n### Steps:\n1. For each provider with an `_original` backup:\n   a. Restore `_original` auth files to their canonical locations\n   b. Verify restoration succeeded\n2. If `--keep-backups` NOT set:\n   a. Remove ~/.caam/vault/\n   b. Remove ~/.caam/config/\n   c. Remove ~/.caam/caam.db\n3. Print summary of what was restored/removed\n\n### Flags:\n- `--keep-backups`: Restore originals but keep vault (user may want profiles later)\n- `--dry-run`: Show what would happen without doing it\n- `--force`: Skip confirmation prompt\n\n## Files\n- cmd/caam/cmd/uninstall.go: Main uninstall command\n- internal/vault/restore.go: Restoration logic (separate from backup)\n\n## Success Criteria\n- Restores ALL original auth states before any deletion\n- Single command, no manual steps required\n- Dry-run shows exactly what will happen\n- Works even if some providers have no _original (skips them with warning)\n","created_at":"2025-12-18T03:06:35Z"},{"id":55,"issue_id":"caam-3b3","author":"ubuntu","text":"Claimed. Implementing  with restore-from  (per tool) before deleting caam data. Will include --dry-run/--keep-backups/--force and unit/integration tests.","created_at":"2025-12-18T04:09:25Z"},{"id":56,"issue_id":"caam-3b3","author":"ubuntu","text":"Implemented uninstall command: restores auth from vault/\u003ctool\u003e/_original before any deletion, then removes caam data/config/db/log/pid. Added flags --dry-run, --keep-backups, --force plus cmd tests for restore+cleanup, keep-backups, and dry-run.","created_at":"2025-12-18T04:18:56Z"}]}
{"id":"caam-3ef","title":"Health status calculation logic","description":"# Health Status Calculation\n\n## Purpose\nCalculate profile health status (üü¢üü°üî¥) based on token expiry, errors, and penalties.\n\n## Background (from codex-pool)\n```go\nscore = headroom * planBonus * creditBonus - penalty\n```\n\nFor caam v1, we simplify to status tiers with an internal numeric score.\n\n## Technical Requirements\n\n### Status Enum\n```go\ntype HealthStatus int\n\nconst (\n    StatusUnknown  HealthStatus = iota // ‚ö™ Cannot determine\n    StatusHealthy                      // üü¢ Good to use\n    StatusWarning                      // üü° Expiring soon or errors\n    StatusCritical                     // üî¥ Expired or many errors\n)\n\nfunc (s HealthStatus) Icon() string\nfunc (s HealthStatus) String() string\n```\n\n### Scoring Algorithm\n```go\nfunc CalculateHealth(h *ProfileHealth) (HealthStatus, float64) {\n    score := 0.0\n    now := time.Now()\n    \n    // Factor 1: Token expiry (primary)\n    if h.TokenExpiresAt.IsZero() {\n        // Unknown expiry - neutral\n    } else if h.TokenExpiresAt.Before(now) {\n        score -= 1.0  // Expired\n    } else {\n        ttl := h.TokenExpiresAt.Sub(now)\n        switch {\n        case ttl \u003e time.Hour:\n            score += 1.0\n        case ttl \u003e 15*time.Minute:\n            score += 0.5\n        default:\n            // \u003c 15 min: no bonus\n        }\n    }\n    \n    // Factor 2: Recent errors\n    switch {\n    case h.ErrorCount1h == 0:\n        score += 0.3\n    case h.ErrorCount1h \u003c= 2:\n        // Neutral\n    default:\n        score -= 0.5\n    }\n    \n    // Factor 3: Plan type bonus\n    switch h.PlanType {\n    case \"enterprise\":\n        score += 0.3\n    case \"pro\", \"team\":\n        score += 0.2\n    }\n    \n    // Factor 4: Penalty (from errors, with decay)\n    score -= h.Penalty\n    \n    // Convert to status\n    status := StatusHealthy\n    if score \u003c 0 {\n        status = StatusCritical\n    } else if score \u003c 0.5 {\n        status = StatusWarning\n    }\n    \n    return status, score\n}\n```\n\n### Thresholds (Configurable)\n```go\ntype HealthConfig struct {\n    TokenExpiryWarningMinutes int     // Default: 60\n    TokenExpiryCriticalMinutes int    // Default: 15\n    ErrorCountWarning         int     // Default: 2\n    ErrorCountCritical        int     // Default: 5\n}\n```\n\n## User-Facing Display\n```\nüü¢ Healthy   - Good to use\nüü° Warning   - Token expiring soon or recent errors\nüî¥ Critical  - Token expired or many errors\n‚ö™ Unknown   - Cannot determine status\n```\n\n## Acceptance Criteria\n- [ ] HealthStatus enum with Icon() and String()\n- [ ] CalculateHealth function with documented algorithm\n- [ ] Configurable thresholds via HealthConfig\n- [ ] Unit tests covering all status transitions\n- [ ] Edge cases: zero time, negative penalty, nil health\n\n## Files to Create/Modify\n- `internal/health/status.go` (new)\n- `internal/health/status_test.go` (new)\n\n## Dependencies\n- Health metadata storage (caam-xxx)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:17:57.789256368-05:00","updated_at":"2025-12-17T17:14:39.883586788-05:00","closed_at":"2025-12-17T17:14:39.883586788-05:00","close_reason":"Implementation complete in status.go - HealthStatus enum, CalculateHealth function, HealthConfig, and tests all passing. Committed as part of 2793c4c.","dependencies":[{"issue_id":"caam-3ef","depends_on_id":"caam-6gj","type":"blocks","created_at":"2025-12-17T16:27:22.207059052-05:00","created_by":"ubuntu"},{"issue_id":"caam-3ef","depends_on_id":"caam-thb","type":"blocks","created_at":"2025-12-17T16:27:27.310848158-05:00","created_by":"ubuntu"},{"issue_id":"caam-3ef","depends_on_id":"caam-0gb","type":"blocks","created_at":"2025-12-17T16:31:54.24697844-05:00","created_by":"ubuntu"}]}
{"id":"caam-3nx","title":"EPIC: Data Safety \u0026 Recovery","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-17T21:42:40.84068493-05:00","updated_at":"2025-12-17T21:42:40.84068493-05:00","comments":[{"id":36,"issue_id":"caam-3nx","author":"ubuntu","text":"Purpose: Ensure users can never lose their original authentication state and can fully reverse any changes made by caam. This is critical for user trust and adoption.\n\nBackground: Currently, caam has a dangerous gap: if a user runs caam activate foo without first backing up their current auth, the original files are overwritten and permanently lost. This violates the principle of least surprise and could cause real harm.\n\nScope: (1) Auto-backup of original state on first use, (2) Protected profile naming conventions, (3) Smart auto-backup before any switch, (4) Uninstall command.\n\nSuccess Criteria: User can NEVER lose original auth through normal usage; Clear distinction between user/system profiles; Single command to reverse all changes; Zero additional friction.\n","created_at":"2025-12-18T02:43:17Z"}]}
{"id":"caam-3w5","title":"Config schema: safety section","description":"Add safety configuration options to SPMConfig:\n\n```yaml\nsafety:\n  auto_backup_original: true  # Auto-backup on first activate\n  auto_backup_before_switch: smart  # always|smart|never\n  max_auto_backups: 5  # Rotate old _backup_* profiles\n  protected_profile_prefix: '_'  # Profiles starting with this are protected\n```\n\nFiles to modify:\n- internal/config/spm_config.go: Add SafetyConfig struct\n- internal/config/spm_config_test.go: Test defaults and validation\n\nThis is foundational - other safety features depend on these config options.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T21:43:31.755611107-05:00","updated_at":"2025-12-17T21:43:31.755611107-05:00","comments":[{"id":39,"issue_id":"caam-3w5","author":"ubuntu","text":"Revised description - simplified config schema:\n\n```yaml\nsafety:\n  auto_backup_before_switch: smart  # \"always\" | \"smart\" | \"never\"\n  max_auto_backups: 5               # Keep last N auto-backups, rotate older\n```\n\n## Changes from Original Design\n\nREMOVED - `auto_backup_original`: This is now ALWAYS enabled, not configurable.\nRationale: Making it optional defeats the entire safety purpose. The one-time backup\nof original state has zero downside and prevents catastrophic data loss.\n\nREMOVED - `protected_profile_prefix`: Now hardcoded as `_`.\nRationale: Making this configurable adds complexity with no benefit. The `_` prefix\nis a standard convention (like hidden files) and changing it could cause confusion.\n\n## What Remains\n- `auto_backup_before_switch`: Controls smart backup on every switch (optional)\n- `max_auto_backups`: Limits accumulation of timestamped backups\n\n## Files\n- internal/config/spm_config.go: Add SafetyConfig struct (simplified)\n- internal/config/spm_config_test.go: Test defaults and validation\n","created_at":"2025-12-18T03:03:39Z"}]}
{"id":"caam-42m","title":"Unit tests for internal/provider/codex","description":"## Package: internal/provider/codex\n\nCodex CLI provider implementation.\n\n## What to Test\n- Provider name and display name\n- Auth file path (auth.json)\n- Config directory handling\n- Binary name for exec\n\n## Files to Create\n- internal/provider/codex/codex_test.go\n\n## Approach\n- Use t.TempDir() with HOME override\n- Test path construction\n- Verify interface compliance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:49:36.35571963-05:00","updated_at":"2025-12-17T02:11:29.439441733-05:00","closed_at":"2025-12-17T02:11:29.439441733-05:00","close_reason":"Implemented comprehensive unit tests for internal/provider/codex: New(), ID(), DisplayName(), DefaultBin(), SupportedAuthModes (OAuth + APIKey), AuthFiles (CODEX_HOME handling), PrepareProfile (directory creation, permissions), Env (CODEX_HOME env var), Logout (auth.json removal), Status (login state, lock detection), ValidateProfile, interface compliance, and full profile lifecycle integration test.","dependencies":[{"issue_id":"caam-42m","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:16.116698564-05:00","created_by":"ubuntu"},{"issue_id":"caam-42m","depends_on_id":"caam-9fd","type":"blocks","created_at":"2025-12-17T01:56:05.493464376-05:00","created_by":"ubuntu"}]}
{"id":"caam-44i","title":"Manual refresh CLI command","description":"# Manual Refresh CLI Command\n\n## Purpose\nAdd `caam refresh` command for users to manually trigger token refresh.\n\n## Use Cases\n1. User wants to refresh before expiry threshold\n2. User wants to refresh all profiles proactively\n3. User wants to check if refresh is working\n4. Scripting/automation scenarios\n\n## Command Design\n\n### Single Profile Refresh\n```bash\n$ caam refresh claude work\nRefreshing claude/work... done\nToken now valid for 59 minutes\n\n$ caam refresh codex main\nRefreshing codex/main... done\nToken now valid for 1 hour 15 minutes\n```\n\n### All Profiles Refresh\n```bash\n$ caam refresh --all\nRefreshing all profiles...\n  claude/work         done (59 minutes)\n  claude/personal     done (1 hour)\n  codex/main          done (1 hour 15 minutes)\n  gemini/default      skipped (no refresh token)\n\n3 refreshed, 1 skipped\n```\n\n### Dry Run\n```bash\n$ caam refresh --dry-run\nWould refresh:\n  claude/work       (expires in 8 minutes)\n  claude/personal   (expires in 45 minutes)\n\nWould skip:\n  codex/main        (expires in 2 hours)\n  gemini/default    (no refresh token)\n```\n\n### Force Refresh\n```bash\n$ caam refresh claude work --force\nRefreshing claude/work (forcing even if not expiring)... done\n```\n\n## Technical Requirements\n\n### Command Structure\n```go\nvar refreshCmd = \u0026cobra.Command{\n    Use:   \"refresh [provider] [profile]\",\n    Short: \"Refresh OAuth tokens for profiles\",\n    Long:  `Refresh OAuth tokens before they expire.\n    \nWithout arguments, shows profiles that would benefit from refresh.\nWith provider and profile, refreshes that specific profile.\nWith --all, refreshes all profiles that support refresh.`,\n    RunE: runRefresh,\n}\n\nfunc init() {\n    refreshCmd.Flags().Bool(\"all\", false, \"Refresh all profiles\")\n    refreshCmd.Flags().Bool(\"dry-run\", false, \"Show what would be refreshed\")\n    refreshCmd.Flags().Bool(\"force\", false, \"Force refresh even if not expiring\")\n    refreshCmd.Flags().Bool(\"quiet\", false, \"Suppress output\")\n    rootCmd.AddCommand(refreshCmd)\n}\n```\n\n### Refresh Logic\n```go\nfunc runRefresh(cmd *cobra.Command, args []string) error {\n    all, _ := cmd.Flags().GetBool(\"all\")\n    dryRun, _ := cmd.Flags().GetBool(\"dry-run\")\n    force, _ := cmd.Flags().GetBool(\"force\")\n    \n    if all {\n        return refreshAllProfiles(cmd.Context(), dryRun, force)\n    }\n    \n    if len(args) \u003c 2 {\n        return showRefreshStatus()\n    }\n    \n    provider, profile := args[0], args[1]\n    return refreshSingleProfile(cmd.Context(), provider, profile, force)\n}\n```\n\n### Output Formatting\n```go\nfunc formatRefreshResult(provider, profile string, err error, newExpiry time.Time) string {\n    prefix := fmt.Sprintf(\"%s/%s\", provider, profile)\n    if err != nil {\n        return fmt.Sprintf(\"  %-25s failed: %v\", prefix, err)\n    }\n    ttl := time.Until(newExpiry)\n    return fmt.Sprintf(\"  %-25s done (%s)\", prefix, formatDuration(ttl))\n}\n```\n\n## Error Handling\n- Profile not found ‚Üí error message\n- No refresh token ‚Üí \"skipped (no refresh token)\"\n- Refresh fails ‚Üí show error, non-zero exit code\n- Network error ‚Üí show error, suggest retry\n\n## Acceptance Criteria\n- [ ] `caam refresh provider profile` refreshes single profile\n- [ ] `caam refresh --all` refreshes all profiles\n- [ ] `caam refresh --dry-run` shows what would happen\n- [ ] `caam refresh --force` forces refresh\n- [ ] Clear success/failure messages\n- [ ] Non-zero exit code on failure\n- [ ] Help text documents all options\n\n## Files to Create/Modify\n- `cmd/caam/cmd/refresh.go` (new)\n\n## Dependencies\n- OAuth refresh handlers\n- Health metadata storage","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:20:51.369185777-05:00","updated_at":"2025-12-17T19:08:48.670103942-05:00","closed_at":"2025-12-17T19:08:48.670103942-05:00","close_reason":"Added `caam refresh` command with single-profile and `--all` modes, `--dry-run`, `--force`, `--quiet`, uses SPM refresh threshold when available, and returns non-zero on failures. Added tests for Codex refresh and skip behavior.","dependencies":[{"issue_id":"caam-44i","depends_on_id":"caam-fwz","type":"blocks","created_at":"2025-12-17T16:28:30.679689173-05:00","created_by":"ubuntu"},{"issue_id":"caam-44i","depends_on_id":"caam-u8g","type":"blocks","created_at":"2025-12-17T16:28:35.787060633-05:00","created_by":"ubuntu"},{"issue_id":"caam-44i","depends_on_id":"caam-9os","type":"blocks","created_at":"2025-12-17T16:28:40.892913354-05:00","created_by":"ubuntu"}],"comments":[{"id":10,"issue_id":"caam-44i","author":"ubuntu","text":"Starting `caam refresh` command: supports single-profile refresh, `--all`, `--dry-run`, `--force`, and clear output + non-zero exit on failures. Will reuse internal/refresh + health parsers.","created_at":"2025-12-18T00:04:45Z"}]}
{"id":"caam-4dk","title":"Integrate browser launcher into login flow","description":"## Task\nModify the provider Login() methods to use the browser launcher when opening OAuth URLs.\n\n## Changes Required\n1. Update Provider.Login() signature or add context\n2. Pass browser config from profile to login flow\n3. Intercept URL detection and use browser launcher\n4. Fall back to default behavior if no browser config\n\n## Affected Files\n- internal/provider/codex/codex.go\n- internal/provider/claude/claude.go  \n- internal/provider/gemini/gemini.go\n- internal/exec/exec.go\n\n## Testing\n- Test with Chrome profile configured\n- Test with no browser config (should use default)\n- Test URL detection for each provider's login flow\n\n## Acceptance Criteria\n- Login with browser profile opens correct browser\n- Login without browser config uses default behavior\n- All three providers work correctly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T00:50:56.860785535-05:00","updated_at":"2025-12-17T01:20:04.958721606-05:00","closed_at":"2025-12-17T01:20:04.958721606-05:00","close_reason":"Integrated browser launcher into all provider login flows. All three providers (codex, claude, gemini) now detect URLs in output and open them with the configured browser profile. Also updated Vertex ADC flow for gemini.","dependencies":[{"issue_id":"caam-4dk","depends_on_id":"caam-4eg","type":"parent-child","created_at":"2025-12-17T00:50:56.880868667-05:00","created_by":"ubuntu"},{"issue_id":"caam-4dk","depends_on_id":"caam-nac","type":"blocks","created_at":"2025-12-17T00:50:56.882108442-05:00","created_by":"ubuntu"},{"issue_id":"caam-4dk","depends_on_id":"caam-ixy","type":"blocks","created_at":"2025-12-17T00:50:56.883026701-05:00","created_by":"ubuntu"}]}
{"id":"caam-4eg","title":"Browser-Profile Aware Login","description":"## Overview\nThe PRIMARY pain point for users with multiple 'all you can eat' subscriptions is the OAuth login flow. When you have 5 Claude Max accounts (each with a different Google account), the browser OAuth flow is painful because:\n1. Browser opens with your 'default' Google account\n2. You have to click 'switch account'\n3. Find the right account from the list\n4. Then authorize\n\nThis takes 30-60 seconds and is error-prone (logging into wrong account).\n\n## Solution\nAssociate each caam profile with a specific browser profile (e.g., Chrome profile). When login flows need a browser, open the URL in THAT browser profile, which already has the correct Google account logged in.\n\n## Key Insight\nChrome (and Firefox) support launching with a specific profile directory. This is the same mechanism that allows people to have separate 'work' and 'personal' browser profiles. We leverage this to make OAuth flows automatically use the right Google account.\n\n## Implementation Approach\n1. Add browser profile config to Profile struct (browser_command, browser_profile_dir)\n2. Create browser launcher abstraction\n3. Detect localhost redirect URLs from CLI stdout\n4. Launch browser with correct profile when URL detected\n5. Support Chrome, Firefox, and 'default browser' fallback\n\n## User Value\nReduces login friction from 30-60 seconds to ~5 seconds (just click authorize). Eliminates risk of logging into wrong account.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T00:49:43.32942877-05:00","updated_at":"2025-12-17T01:22:09.970282351-05:00","closed_at":"2025-12-17T01:22:09.970282351-05:00","close_reason":"Browser-Profile Aware Login epic complete. All 5 child tasks done: Profile struct browser config, browser launcher abstraction, URL detection, provider integration, and CLI flags."}
{"id":"caam-4ve","title":"TUI hot reload integration","description":"## Purpose\nIntegrate the file system watcher with the TUI to automatically refresh the profile\nlist when files change on disk.\n\n## Background\nThis enables a seamless workflow where:\n1. User has TUI open in Terminal 1\n2. User runs `caam backup claude newprofile` in Terminal 2\n3. TUI automatically shows the new profile without restart\n\ncodex-pool achieves similar with `POST /admin/reload`. For caam, we use file watching.\n\n## User Experience\n```\n# Terminal 1: TUI running\n‚îå‚îÄ Claude Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ ‚óè work@company.com    üü¢ Active       ‚îÇ\n‚îÇ   personal@gmail.com  üü°              ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n# Terminal 2: Add new profile\n$ caam backup claude newproject@corp.com\nProfile saved.\n\n# Terminal 1: TUI auto-updates (no restart needed!)\n‚îå‚îÄ Claude Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ ‚óè work@company.com       üü¢ Active    ‚îÇ\n‚îÇ   personal@gmail.com     üü°           ‚îÇ\n‚îÇ   newproject@corp.com    üü¢ NEW       ‚îÇ  ‚Üê appeared automatically\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Technical Implementation\n\n### Message Type\n```go\n// internal/tui/messages.go\ntype profilesChangedMsg struct {\n    event watcher.Event\n}\n```\n\n### Model Integration\n```go\n// internal/tui/model.go\ntype Model struct {\n    // ... existing fields\n    watcher *watcher.Watcher\n}\n\n// Init starts the file watcher\nfunc (m Model) Init() tea.Cmd {\n    return tea.Batch(\n        m.loadProfiles(),\n        m.watchProfiles(),\n    )\n}\n\n// watchProfiles returns a command that listens for file changes\nfunc (m Model) watchProfiles() tea.Cmd {\n    return func() tea.Msg {\n        select {\n        case event := \u003c-m.watcher.Events():\n            return profilesChangedMsg{event: event}\n        case err := \u003c-m.watcher.Errors():\n            return errMsg{err: err}\n        }\n    }\n}\n\n// Update handles the change event\nfunc (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {\n    switch msg := msg.(type) {\n    case profilesChangedMsg:\n        // Show brief notification\n        m.statusMsg = fmt.Sprintf(\"Profile %s %s\", \n            msg.event.Profile, \n            eventTypeVerb(msg.event.Type))\n        \n        // Reload profiles and continue watching\n        return m, tea.Batch(\n            m.loadProfiles(),\n            m.watchProfiles(),\n        )\n    }\n}\n```\n\n### Visual Feedback\n```go\n// Show \"NEW\" badge briefly for added profiles\ntype profileBadge struct {\n    profile  string\n    badge    string\n    expiry   time.Time\n}\n\nfunc (m *Model) addBadge(profile, badge string, duration time.Duration) {\n    m.badges[profile] = profileBadge{\n        profile: profile,\n        badge:   badge,\n        expiry:  time.Now().Add(duration),\n    }\n}\n```\n\n### Graceful Degradation\n```go\n// If watcher fails, TUI still works but without auto-refresh\nfunc (m Model) Init() tea.Cmd {\n    cmds := []tea.Cmd{m.loadProfiles()}\n    \n    w, err := watcher.New(m.profilesDir)\n    if err != nil {\n        // Log warning but continue without watching\n        log.Printf(\"Warning: file watching unavailable: %v\", err)\n    } else {\n        m.watcher = w\n        cmds = append(cmds, m.watchProfiles())\n    }\n    \n    return tea.Batch(cmds...)\n}\n```\n\n## Files to Modify\n- internal/tui/model.go\n- internal/tui/messages.go\n- internal/tui/profiles_panel.go (for badges)\n\n## Acceptance Criteria\n- [ ] New profiles appear automatically in TUI\n- [ ] Modified profiles trigger refresh\n- [ ] Deleted profiles are removed from list\n- [ ] Brief notification shows what changed\n- [ ] NEW badge shown for 5 seconds on additions\n- [ ] No crash if watcher is unavailable\n- [ ] Clean shutdown stops watcher","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:24:29.724093683-05:00","updated_at":"2025-12-17T19:41:51.401036395-05:00","closed_at":"2025-12-17T19:41:51.401036395-05:00","close_reason":"Wired profile watcher into TUI for hot reload; load vault profiles, show NEW badge, and cleanly close watcher.","dependencies":[{"issue_id":"caam-4ve","depends_on_id":"caam-0gx","type":"blocks","created_at":"2025-12-17T16:29:25.420647662-05:00","created_by":"ubuntu"}],"comments":[{"id":13,"issue_id":"caam-4ve","author":"ubuntu","text":"Starting TUI hot reload integration: wire internal/watcher into Bubble Tea model to reload vault profile list on fs events, show brief status + NEW badge on additions, and ensure watcher closes cleanly on quit. (Agent mail not configured in this env; using issue comments.)","created_at":"2025-12-18T00:32:52Z"},{"id":14,"issue_id":"caam-4ve","author":"ubuntu","text":"Implemented hot reload in TUI: added fsnotify watcher on vault dir, Bubble Tea cmds/messages to reload profiles on add/modify/delete, vault-backed loadProfiles (with active profile detection), and 5s NEW badge on additions w/ expiry. Added unit tests for vault loading + badge lifecycle. Quit closes watcher; Run also closes as safety.","created_at":"2025-12-18T00:41:41Z"}]}
{"id":"caam-539","title":"Project context TUI integration","description":"## Purpose\nAdd project context awareness to the TUI.\n\n## Features\n\n### Project Context Display\nShow current project association in the status bar or header.\n```\n‚îå‚îÄ Claude Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Project: /home/user/work/client-a ‚Üí client-a@work.com       ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ ‚óè client-a@work.com    üü¢ Pro   [PROJECT DEFAULT]           ‚îÇ\n‚îÇ   work@company.com     üü¢ Pro                               ‚îÇ\n‚îÇ   personal@gmail.com   üü° Free                              ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n### Quick Association\nAdd keyboard shortcut to associate currently selected profile with CWD.\n- Press `p` to set project association for selected profile\n- Shows confirmation message\n\n### Visual Indicators\n- \"PROJECT DEFAULT\" badge on associated profile\n- Different styling for project-associated profile\n- Clear indication when in a project directory vs not\n\n## Technical Implementation\n\n### Model Changes\nAdd projectAssoc field to Model that stores current directory association.\nLoad on startup based on os.Getwd().\n\n### New Key Binding\nAdd projectAssoc key binding to keys.go.\n\n### Badge System\nExtend ProfileInfo struct with ProjectDefault bool field.\n\n## Files to Modify\n- internal/tui/model.go\n- internal/tui/profiles_panel.go\n- internal/tui/keys.go\n\n## Acceptance Criteria\n- [ ] Project context shown when in associated directory\n- [ ] PROJECT DEFAULT badge on associated profile\n- [ ] p key creates association for selected profile\n- [ ] Confirmation message after association\n- [ ] Graceful handling when not in any project","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T16:26:06.709440597-05:00","updated_at":"2025-12-17T19:50:55.975972489-05:00","closed_at":"2025-12-17T19:50:55.975972489-05:00","close_reason":"Added project context awareness to TUI, including association shortcut and PROJECT DEFAULT indicator.","dependencies":[{"issue_id":"caam-539","depends_on_id":"caam-ir7","type":"blocks","created_at":"2025-12-17T16:29:40.726796796-05:00","created_by":"ubuntu"},{"issue_id":"caam-539","depends_on_id":"caam-dmw","type":"blocks","created_at":"2025-12-17T16:29:45.832079614-05:00","created_by":"ubuntu"}],"comments":[{"id":9,"issue_id":"caam-539","author":"ubuntu","text":"caam-ir7 and caam-dmw are now closed. Project associations are available via `internal/project` + `caam project ...` commands, and `caam activate \u003ctool\u003e` can auto-pick association when profile omitted. This task should be unblocked now.","created_at":"2025-12-17T23:56:59Z"},{"id":15,"issue_id":"caam-539","author":"ubuntu","text":"Starting project-context integration in TUI: load project association for CWD via internal/project store, show context in header/status, add p key to set association for selected profile, and mark associated profile with PROJECT DEFAULT badge.","created_at":"2025-12-18T00:45:09Z"},{"id":16,"issue_id":"caam-539","author":"ubuntu","text":"Implemented project context in TUI: resolve CWD via internal/project store on startup, render project line in header, add 'p' key to associate selected profile with current directory, and mark associated profile with [PROJECT DEFAULT] badge. Added unit test covering project association badge.","created_at":"2025-12-18T00:50:45Z"}]}
{"id":"caam-53s","title":"E2E: Error handling and edge cases","description":"End-to-end tests for error handling and edge cases:\n\n## Test Scenarios\n1. File system errors:\n   - Read-only directories\n   - Disk full simulation\n   - Permission denied\n   - Symlink handling\n\n2. Concurrent access:\n   - Multiple caam instances\n   - File locking behavior\n   - Race condition detection\n\n3. Invalid data handling:\n   - Corrupted profile files\n   - Invalid JSON in auth files\n   - Missing required fields\n   - Version mismatch\n\n4. Recovery workflows:\n   - Recover from interrupted backup\n   - Recover from interrupted restore\n   - Clean up partial state\n\n## Requirements\n- Test actual error conditions (not mocked)\n- Verify error messages are user-friendly\n- Verify cleanup on errors\n- Log full error context for debugging","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:53:06.789456821-05:00","updated_at":"2025-12-17T02:42:28.626348145-05:00","closed_at":"2025-12-17T02:42:28.626348145-05:00","close_reason":"Added comprehensive E2E error handling tests: file system errors (read-only, permissions, symlinks), concurrent access (multiple backups, locking), invalid data (corrupted JSON, missing files), recovery workflows, and edge cases. 27 new tests covering error conditions and edge cases.","dependencies":[{"issue_id":"caam-53s","depends_on_id":"caam-7a2","type":"blocks","created_at":"2025-12-17T01:55:14.217730072-05:00","created_by":"ubuntu"},{"issue_id":"caam-53s","depends_on_id":"caam-aek","type":"blocks","created_at":"2025-12-17T01:55:46.485430641-05:00","created_by":"ubuntu"}]}
{"id":"caam-5ed","title":"Cooldown tracking after limit hits","description":"Track when accounts hit limits and enforce cooldown periods.\n\n## The Problem\nIf account A hits a limit and user immediately switches to account B, then back to A an hour later, this pattern is suspicious. Real users don't hit limits multiple times per day on the same account.\n\n## Solution\nTrack limit events and enforce cooldowns:\n1. User marks limit hit: `caam limit-hit claude` (or auto-detect in future)\n2. System records: profile X hit limit at time T\n3. Cooldown calculated: can't reuse until T + cooldown_hours\n4. Activation blocked/warned if profile is in cooldown\n\n## Database Schema\n```sql\nCREATE TABLE limit_events (\n  id INTEGER PRIMARY KEY,\n  provider TEXT NOT NULL,\n  profile_name TEXT NOT NULL,\n  hit_at DATETIME NOT NULL,\n  cooldown_until DATETIME NOT NULL,\n  notes TEXT\n);\n\nCREATE INDEX idx_limit_events_provider_profile ON limit_events(provider, profile_name);\nCREATE INDEX idx_limit_events_cooldown ON limit_events(cooldown_until);\n```\n\n## Commands\n```bash\n# Mark current profile as hitting limit\ncaam limit-hit claude\n# Output: Recorded limit hit for claude/work-account. Cooldown until 20:32.\n\n# Mark specific profile\ncaam limit-hit codex backup-account\n\n# Check cooldown status\ncaam cooldown status\n# Output:\n# claude/work-account: in cooldown (2h 15m remaining)\n# codex/backup-account: ready\n# codex/main: in cooldown (45m remaining)\n\n# Clear cooldown manually (for testing)\ncaam cooldown clear claude work-account\n```\n\n## Activation Integration\nWhen user tries to activate a profile in cooldown:\n```\n$ caam activate claude work-account\n\nWarning: claude/work-account is in cooldown\n  Limit hit: 2 hours ago\n  Cooldown remaining: 4 hours\n  \nUse --force to activate anyway, or try one of:\n  caam activate claude personal-account\n  caam activate claude --next  (auto-select best available)\n\nProceed anyway? [y/N]\n```\n\n## Auto-detection (Future Enhancement)\nCould potentially detect limit errors in `caam exec` output:\n- Codex: 'You've hit your usage limit'\n- Claude: rate limit errors\n- Gemini: quota exceeded\n\nThis would be a separate enhancement task.\n\n## Files\n- internal/db/limit_events.go: DB operations for limit tracking\n- internal/db/limit_events_test.go: Tests\n- internal/stealth/cooldown.go: Cooldown logic\n- cmd/caam/cmd/limit.go: limit-hit and cooldown commands\n- cmd/caam/cmd/activate.go: Integration","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-17T21:47:26.364033647-05:00","updated_at":"2025-12-17T21:47:26.364033647-05:00","dependencies":[{"issue_id":"caam-5ed","depends_on_id":"caam-bgz","type":"blocks","created_at":"2025-12-17T21:47:38.495473582-05:00","created_by":"ubuntu"}],"comments":[{"id":42,"issue_id":"caam-5ed","author":"ubuntu","text":"Revised description - fix dependency and add --all flag:\n\n## Purpose\nTrack when accounts hit rate limits and enforce cooldown periods before reuse.\nThis prevents the suspicious pattern of: Account A hits limit -\u003e immediately switch to Account B.\n\n## DEPENDENCY FIX\nThis feature does NOT depend on caam-108 (switch delay system).\n\nRationale: Cooldowns and delays are INDEPENDENT features:\n- Delays: Wait N seconds before ANY switch (reduces automation fingerprint)\n- Cooldowns: Wait N minutes before reusing a SPECIFIC account that hit a limit\n\nYou might want cooldowns without delays, or delays without cooldowns.\nThe only shared dependency is caam-bgz (config schema) since both need config.\n\n## Implementation\n\n### Tracking\nWhen user reports a limit hit:\n```bash\ncaam cooldown set claude/work --minutes=60\n```\n\nThis stores:\n- Provider/profile that hit the limit\n- Timestamp of limit hit\n- Cooldown duration\n\n### Enforcement\nOn `caam activate`:\n1. Check if target profile has active cooldown\n2. If yes: show warning with time remaining\n3. User can override with `--force` or wait\n\n### Clearing\n```bash\ncaam cooldown clear claude/work     # Clear specific\ncaam cooldown clear --all           # Clear ALL cooldowns (added!)\ncaam cooldown list                  # Show active cooldowns\n```\n\n## Config\n```yaml\nstealth:\n  cooldown:\n    enabled: false\n    default_minutes: 60      # Default cooldown duration\n    track_limit_hits: true   # Auto-track when limits detected\n```\n\n## Files\n- internal/db/cooldown.go: Cooldown storage and queries\n- internal/db/cooldown_test.go: Tests\n- cmd/caam/cmd/cooldown.go: CLI subcommands (set, clear, list)\n- cmd/caam/cmd/activate.go: Add cooldown check before activation\n\n## Success Criteria\n- Can manually set cooldowns on profiles\n- Activation warns when profile is in cooldown\n- Can override with --force\n- Can clear individual or ALL cooldowns\n","created_at":"2025-12-18T03:06:23Z"}]}
{"id":"caam-5fk","title":"Auto-backup original state on first activate","description":"Automatically preserve the user's pre-caam authentication state.\n\n## The Problem\nUser runs `caam activate claude foo` without backing up first ‚Üí original auth is overwritten and LOST FOREVER. This is the highest-risk safety gap.\n\n## Solution\nOn ANY activate command:\n1. Check if auth files exist for the tool\n2. Check if they match any existing vault profile (using hash comparison)\n3. If auth exists AND no match found ‚Üí this is 'virgin' state\n4. Auto-backup to `_original_\u003ctool\u003e` profile\n5. Print: 'Backed up original claude auth to _original_claude'\n6. NEVER overwrite existing _original profile (it's a one-time safety net)\n\n## Key Design Decisions\n- Only happens ONCE per tool (when _original doesn't exist)\n- Silent if _original already exists (idempotent)\n- Uses protected profile naming (_original prefix)\n- Stores metadata: {type: 'system', created_by: 'first-activate', original_paths: [...]}\n\n## Implementation\n1. Add Vault.HasOriginalBackup(tool) method\n2. Add Vault.BackupOriginal(fileSet) method\n3. Modify activate command to call BackupOriginal before restore\n4. Add integration test: fresh system ‚Üí activate ‚Üí verify _original created\n\n## Files\n- internal/authfile/authfile.go: New methods\n- cmd/caam/cmd/activate.go: Add auto-backup logic\n- internal/authfile/authfile_test.go: Unit tests\n- cmd/caam/cmd/activate_test.go: Integration test","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T21:44:21.406320231-05:00","updated_at":"2025-12-17T23:07:00.583111467-05:00","closed_at":"2025-12-17T23:07:00.583111467-05:00","close_reason":"Auto-backup original auth on first activate: added Vault.BackupOriginal/HasOriginalBackup and activate pre-restore safety. _original is protected/immutable; meta.json includes type=system, created_by=first-activate, original_paths; tests added.","dependencies":[{"issue_id":"caam-5fk","depends_on_id":"caam-nh8","type":"blocks","created_at":"2025-12-17T21:44:32.52430969-05:00","created_by":"ubuntu"}],"comments":[{"id":41,"issue_id":"caam-5fk","author":"ubuntu","text":"Revised description - fix profile naming:\n\n## Implementation\n\nOn FIRST-EVER `caam activate` (any provider):\n1. Check if `_original` profile exists for this provider\n2. If NOT: automatically backup current auth state as `_original`\n3. Proceed with normal activation\n\n## Profile Naming\n\nProfile name: `_original` (not `_original_\u003ctool\u003e`)\n\nRationale: The `_` prefix already marks it as protected/system-managed. Adding the tool name is redundant because:\n- Profiles are already namespaced by provider (claude, codex, etc.)\n- The vault structure is: `~/.caam/vault/\u003cprovider\u003e/\u003cprofile_name\u003e/`\n- So claude's original is at: `~/.caam/vault/claude/_original/`\n- And codex's original is at: `~/.caam/vault/codex/_original/`\n\nNo collision possible. Simpler naming = easier to remember and type.\n\n## Protected Profile Behavior\n\nProfiles starting with `_` are protected:\n- Cannot be deleted via `caam delete`\n- Cannot be overwritten via `caam save`\n- Hidden from normal `caam list` (shown with `--all` or `-a`)\n- Shown in distinct color/style when displayed\n\n## Files\n- internal/vault/vault.go: Add IsProtectedProfile() helper\n- internal/vault/vault.go: Modify Save() to check for protected prefix\n- cmd/caam/cmd/activate.go: Add first-run backup logic\n- cmd/caam/cmd/list.go: Filter protected by default, add --all flag\n\n## Success Criteria\n- First activate ALWAYS creates _original backup\n- Protected profiles cannot be modified by user\n- Clear visual distinction in listings\n","created_at":"2025-12-18T03:06:17Z"},{"id":51,"issue_id":"caam-5fk","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nFYI caam-nh8 is now closed: `_`-prefixed vault profiles are treated as system profiles (ls shows [system], delete requires --force and uses Vault.DeleteForce). Meta.json now includes {type, created_by}. This should help implement _original_\u003ctool\u003e safely.","created_at":"2025-12-18T03:48:26Z"},{"id":53,"issue_id":"caam-5fk","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nClaimed. Implementing first-activate safety net: if `_original` does not exist and current auth files exist but don't match any vault profile, auto-backup current auth to `vault/\u003ctool\u003e/_original/` before restore. Will also ensure system profiles are not overwritten and add integration test (codex) for `_original` creation.","created_at":"2025-12-18T03:52:59Z"},{"id":54,"issue_id":"caam-5fk","author":"ubuntu","text":"Implemented first-activate safety net: Vault.BackupOriginal() creates protected _original per tool if current auth exists and doesn't match any vault profile; activate now calls this before refresh/restore and prints when created. System profiles are immutable (no overwrite) and meta.json now records type=system, created_by=first-activate for _original, plus original_paths. Added unit tests + activate integration test (codex).","created_at":"2025-12-18T04:06:48Z"}]}
{"id":"caam-6gi","title":"Penalty tracking with decay mechanism","description":"# Penalty Tracking with Decay\n\n## Purpose\nImplement the penalty decay mechanism from codex-pool to temporarily penalize problematic profiles while allowing natural recovery.\n\n## Background (from codex-pool)\n```go\nfunc decayPenaltyLocked(a *Account, now time.Time) {\n    if a.LastPenalty.IsZero() {\n        a.LastPenalty = now\n        return\n    }\n    if now.Sub(a.LastPenalty) \u003c 5*time.Minute {\n        return\n    }\n    // decay 20% every 5 minutes\n    a.Penalty *= 0.8\n    if a.Penalty \u003c 0.01 {\n        a.Penalty = 0\n    }\n    a.LastPenalty = now\n}\n```\n\n## Why Decay?\n- **Without decay**: One bad error = permanent penalty = profile never used\n- **With decay**: Errors hurt temporarily, but profiles recover naturally\n- **Result**: System is self-healing, no manual intervention needed\n\n## Technical Requirements\n\n### Penalty Events\n| Event | Penalty Added |\n|-------|---------------|\n| Auth error (401/403) | +1.0 |\n| Rate limit (429) | +0.5 |\n| Server error (5xx) | +0.3 |\n| Network timeout | +0.2 |\n| Other error | +0.1 |\n\n### Decay Algorithm\n```go\nconst (\n    DecayInterval = 5 * time.Minute\n    DecayRate     = 0.8  // 20% decay\n    MinPenalty    = 0.01 // Below this, reset to 0\n)\n\nfunc (h *ProfileHealth) DecayPenalty(now time.Time) {\n    if h.PenaltyUpdatedAt.IsZero() {\n        h.PenaltyUpdatedAt = now\n        return\n    }\n    \n    elapsed := now.Sub(h.PenaltyUpdatedAt)\n    intervals := int(elapsed / DecayInterval)\n    \n    if intervals \u003e 0 {\n        for i := 0; i \u003c intervals; i++ {\n            h.Penalty *= DecayRate\n        }\n        if h.Penalty \u003c MinPenalty {\n            h.Penalty = 0\n        }\n        h.PenaltyUpdatedAt = now\n    }\n}\n\nfunc (h *ProfileHealth) AddPenalty(amount float64, now time.Time) {\n    h.DecayPenalty(now)  // Apply decay first\n    h.Penalty += amount\n    h.PenaltyUpdatedAt = now\n}\n```\n\n### Error-to-Penalty Mapping\n```go\nfunc PenaltyForError(err error) float64 {\n    // Check error type\n    if isAuthError(err) {\n        return 1.0\n    }\n    if isRateLimitError(err) {\n        return 0.5\n    }\n    if isServerError(err) {\n        return 0.3\n    }\n    if isTimeoutError(err) {\n        return 0.2\n    }\n    return 0.1\n}\n```\n\n## Decay Visualization\n```\nTime    Penalty   Status\n0min    1.0       üî¥ Critical\n5min    0.8       üî¥ Critical\n10min   0.64      üü° Warning\n15min   0.51      üü° Warning\n20min   0.41      üü° Warning\n25min   0.33      üü¢ Healthy\n...\n60min   0.01      üü¢ Healthy (reset to 0)\n```\n\n## Acceptance Criteria\n- [ ] DecayPenalty applies decay based on elapsed time\n- [ ] AddPenalty applies decay then adds new penalty\n- [ ] PenaltyForError maps errors to penalty amounts\n- [ ] Penalty resets to 0 when below MinPenalty\n- [ ] Unit tests with time mocking\n- [ ] Integration with health status calculation\n\n## Files to Create/Modify\n- `internal/health/penalty.go` (new)\n- `internal/health/penalty_test.go` (new)\n\n## Dependencies\n- Health metadata storage","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:18:04.703653469-05:00","updated_at":"2025-12-17T20:34:21.068188843-05:00","closed_at":"2025-12-17T20:34:21.068190757-05:00","dependencies":[{"issue_id":"caam-6gi","depends_on_id":"caam-6gj","type":"blocks","created_at":"2025-12-17T16:27:32.416529256-05:00","created_by":"ubuntu"},{"issue_id":"caam-6gi","depends_on_id":"caam-0gb","type":"blocks","created_at":"2025-12-17T16:31:59.344432339-05:00","created_by":"ubuntu"}]}
{"id":"caam-6gj","title":"Health metadata storage and persistence","description":"# Health Metadata Storage\n\n## Purpose\nCreate the storage layer for profile health data including token expiry, error counts, penalties, and plan types.\n\n## Technical Requirements\n\n### File Location\n`~/.caam/health.json`\n\n### Data Structure\n```go\ntype HealthStore struct {\n    Profiles map[string]*ProfileHealth `json:\"profiles\"` // key: \"provider/name\"\n    Version  int                       `json:\"version\"`\n}\n\ntype ProfileHealth struct {\n    TokenExpiresAt   time.Time `json:\"token_expires_at,omitempty\"`\n    LastError        time.Time `json:\"last_error,omitempty\"`\n    ErrorCount1h     int       `json:\"error_count_1h\"`\n    Penalty          float64   `json:\"penalty\"`\n    PenaltyUpdatedAt time.Time `json:\"penalty_updated_at,omitempty\"`\n    PlanType         string    `json:\"plan_type,omitempty\"` // \"free\", \"pro\", \"enterprise\"\n    LastChecked      time.Time `json:\"last_checked,omitempty\"`\n}\n```\n\n### API Interface\n```go\ntype HealthStorage interface {\n    Load() (*HealthStore, error)\n    Save(store *HealthStore) error\n    GetProfile(provider, name string) (*ProfileHealth, error)\n    UpdateProfile(provider, name string, health *ProfileHealth) error\n    RecordError(provider, name string) error\n    ClearErrors(provider, name string) error\n}\n```\n\n### Implementation Notes\n- Use atomic file writes (temp file + rename)\n- Handle missing file gracefully (return empty store)\n- Validate JSON structure on load\n- Support concurrent access (file locking or mutex)\n\n## Acceptance Criteria\n- [ ] HealthStore struct defined in `internal/health/storage.go`\n- [ ] Load/Save with atomic writes\n- [ ] Profile-specific getters and setters\n- [ ] Error recording increments error_count_1h\n- [ ] Unit tests with temp directory\n- [ ] Handles corrupted JSON gracefully\n\n## Files to Create/Modify\n- `internal/health/storage.go` (new)\n- `internal/health/storage_test.go` (new)\n\n## Dependencies\nNone (foundation task)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:17:44.164900363-05:00","updated_at":"2025-12-17T16:39:45.989320239-05:00","closed_at":"2025-12-17T16:39:45.989320239-05:00","close_reason":"Implemented health metadata storage with atomic writes, Load/Save, GetProfile, UpdateProfile, RecordError, SetTokenExpiry, SetPlanType, DecayPenalties, GetStatus. All tests pass."}
{"id":"caam-6i6","title":"E2E: TUI interaction simulation tests","description":"End-to-end tests for TUI interactions using Bubble Tea testing:\n\n## Test Scenarios\n1. Navigation workflows:\n   - Start TUI, navigate providers with Tab/arrow keys\n   - Select profile with j/k, activate with Enter\n   - Verify correct profile activated\n\n2. Action workflows:\n   - Press 'd' to delete, confirm with 'y'\n   - Press 'l' to login/refresh\n   - Press 'b' to backup\n   - Press 'o' to open in browser\n\n3. Search workflow:\n   - Press '/' to enter search mode\n   - Type search query\n   - Verify filtered results\n   - Press Esc to cancel\n\n4. Error handling:\n   - Attempt action on non-existent profile\n   - Handle backend errors gracefully\n   - Verify error messages displayed\n\n## Requirements\n- Use tea.Test() for Bubble Tea testing\n- Send actual key messages\n- Verify model state changes\n- Log all state transitions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:53:00.289693273-05:00","updated_at":"2025-12-17T02:36:14.049789613-05:00","closed_at":"2025-12-17T02:36:14.049789613-05:00","close_reason":"Completed 27 E2E TUI interaction simulation tests - navigation, actions, state transitions, UI workflows","dependencies":[{"issue_id":"caam-6i6","depends_on_id":"caam-7a2","type":"blocks","created_at":"2025-12-17T01:55:09.11986964-05:00","created_by":"ubuntu"},{"issue_id":"caam-6i6","depends_on_id":"caam-aek","type":"blocks","created_at":"2025-12-17T01:55:41.387650139-05:00","created_by":"ubuntu"}]}
{"id":"caam-77v","title":"Implement 'doctor' command for diagnostics","description":"## Task\nAdd 'caam doctor' command to diagnose setup issues.\n\n## Checks to Perform\n1. **CLI binaries**: Are codex, claude, gemini installed and in PATH?\n2. **Data directories**: Do ~/.local/share/caam/{vault,profiles} exist with correct permissions?\n3. **Config**: Is config.json valid?\n4. **Profiles**: Are all profiles valid? Any broken symlinks?\n5. **Locks**: Any stale lock files?\n6. **Auth files**: For each provider, do auth files exist in expected locations?\n\n## Output Format\n```\ncaam doctor\n\nChecking CLI tools...\n  ‚úì codex found at /usr/local/bin/codex (v1.2.3)\n  ‚úì claude found at /usr/local/bin/claude (v2.0.1)\n  ‚úó gemini not found in PATH\n\nChecking data directories...\n  ‚úì ~/.local/share/caam/vault exists (mode 0700)\n  ‚úì ~/.local/share/caam/profiles exists (mode 0700)\n\nChecking profiles...\n  ‚úì codex/work-1: OK\n  ‚ö† codex/old-profile: Stale lock file (PID 12345 not running)\n  ‚úó claude/broken: Missing home directory\n\nChecking auth files...\n  ‚úì codex: ~/.codex/auth.json exists\n  ‚úì claude: ~/.claude.json exists\n  ‚úó gemini: ~/.gemini/settings.json missing\n```\n\n## Flags\n- --fix: Attempt to fix issues (create dirs, clean stale locks)\n- --json: Machine-readable output\n\n## Acceptance Criteria\n- Checks all major components\n- Clear pass/fail/warning output\n- --fix can resolve common issues","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:54:40.095003307-05:00","updated_at":"2025-12-17T01:32:36.994420886-05:00","closed_at":"2025-12-17T01:32:36.994420886-05:00","close_reason":"Doctor command implemented with all checks: CLI tools, data directories, config, profiles, stale locks, auth files. Includes --fix and --json flags.","dependencies":[{"issue_id":"caam-77v","depends_on_id":"caam-1ba","type":"parent-child","created_at":"2025-12-17T00:54:40.109818461-05:00","created_by":"ubuntu"}]}
{"id":"caam-7a2","title":"E2E Integration Tests","description":"## Overview\nEnd-to-end integration tests that exercise complete workflows with detailed logging.\n\n## Test Scenarios\n1. **Vault Profile Workflow**\n   - Fresh install ‚Üí backup ‚Üí activate ‚Üí status ‚Üí verify\n   - Multiple profiles per provider\n   - Cross-provider operations\n\n2. **Isolated Profile Workflow**\n   - Create profile ‚Üí login ‚Üí exec ‚Üí cleanup\n   - Concurrent profile usage\n   - Lock management during execution\n\n3. **Session Management**\n   - Lock acquisition and release\n   - Stale lock detection\n   - Force unlock scenarios\n\n4. **CLI Integration**\n   - All subcommands work correctly\n   - Error handling and exit codes\n   - JSON output modes\n\n5. **TUI Integration**\n   - Startup and shutdown\n   - Keyboard navigation\n   - Action execution\n\n## Infrastructure\n- Shell script test runner\n- Detailed logging with timestamps\n- Setup/teardown for test environments\n- CI-compatible execution","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T01:48:16.005311845-05:00","updated_at":"2025-12-17T02:02:13.314955238-05:00","closed_at":"2025-12-17T02:02:13.314955238-05:00","close_reason":"E2E epic: dependency caam-9c4 complete. Infrastructure pattern established. Ready to implement individual E2E tests.","dependencies":[{"issue_id":"caam-7a2","depends_on_id":"caam-9c4","type":"blocks","created_at":"2025-12-17T01:53:43.713465702-05:00","created_by":"ubuntu"}]}
{"id":"caam-7nw","title":"Unit tests for internal/authfile","description":"## Package: internal/authfile (CRITICAL)\n\nCore auth file operations - most important to test thoroughly.\n\n## What to Test\n- AuthFile struct creation\n- File existence checking\n- File reading\n- File writing\n- Content hashing (SHA-256)\n- Hash comparison\n- Backup to vault\n- Restore from vault\n- Directory creation\n- Permission handling\n\n## Files to Create\n- internal/authfile/authfile_test.go\n\n## Approach\n- Use t.TempDir() for all file operations\n- Create real files with known content\n- Test actual file system behavior\n- Verify file permissions\n- Test hash stability\n\n## Critical Tests\n- Hash of same content always matches\n- Backup creates exact copy\n- Restore overwrites correctly\n- Missing file handling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T01:48:51.513080466-05:00","updated_at":"2025-12-17T01:56:37.839329308-05:00","closed_at":"2025-12-17T01:56:37.839329308-05:00","close_reason":"Implemented 35 comprehensive unit tests covering all authfile package functions: NewVault, DefaultVaultPath, ProfilePath, BackupPath, Backup, Restore, List, ListAll, Delete, ActiveProfile, HasAuthFiles, ClearAuthFiles, copyFile, hashFile, and a full backup-restore roundtrip test","dependencies":[{"issue_id":"caam-7nw","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:00.80263279-05:00","created_by":"ubuntu"}]}
{"id":"caam-82c","title":"Add force-unlock command","description":"## Task\nAdd 'caam unlock' command to forcibly remove locks.\n\n## Usage\n```bash\ncaam unlock codex work-1          # Unlock specific profile\ncaam unlock --stale               # Clean all stale locks\ncaam unlock codex work-1 --force  # Force unlock even if process running\n```\n\n## Safety\n- Default: Only unlock if process not running\n- --force: Unlock even if process appears running (dangerous)\n- Warn before force unlock\n- Consider sending SIGTERM to process before unlocking\n\n## Implementation\n- Check if lock is stale (PID not running)\n- If stale, just remove lock file\n- If --force, warn and remove anyway\n- If not stale and no --force, error\n\n## Acceptance Criteria\n- Can unlock stale locks\n- Force requires explicit flag\n- Warning before dangerous operations","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T00:53:39.864750655-05:00","updated_at":"2025-12-17T01:34:16.981893529-05:00","closed_at":"2025-12-17T01:34:16.981893529-05:00","close_reason":"Added caam profile unlock command with stale lock detection and --force flag","dependencies":[{"issue_id":"caam-82c","depends_on_id":"caam-pxg","type":"parent-child","created_at":"2025-12-17T00:53:39.879518279-05:00","created_by":"ubuntu"},{"issue_id":"caam-82c","depends_on_id":"caam-pb7","type":"blocks","created_at":"2025-12-17T00:53:39.880805974-05:00","created_by":"ubuntu"}]}
{"id":"caam-9c4","title":"Comprehensive Test Suite","description":"## Overview\nEstablish complete test coverage for the caam codebase without mocks or fakes, plus e2e integration tests with detailed logging.\n\n## Current State\n- Only internal/tui has tests (37% coverage)\n- 13 packages have NO test files\n- No e2e integration tests exist\n- No test logging infrastructure\n\n## Goals\n1. **Unit Tests**: Real-world tests for each package without mocks\n   - Use temporary directories for file operations\n   - Use real file system operations\n   - Test actual behavior, not mocked behavior\n   \n2. **E2E Integration Tests**: Complete workflow testing\n   - Backup/activate/status cycle\n   - Profile isolation\n   - Lock management\n   - CLI command integration\n   \n3. **Test Infrastructure**\n   - Detailed logging for debugging\n   - Test fixtures and helpers\n   - CI integration\n\n## Philosophy\n- NO mocks/fakes - test real behavior\n- Tests should be runnable in isolation\n- Clear failure messages with context\n- Comprehensive edge case coverage","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T01:47:43.240498018-05:00","updated_at":"2025-12-17T01:58:50.964601277-05:00","closed_at":"2025-12-17T01:58:50.964601277-05:00","close_reason":"Test suite infrastructure established: TUI tests (37%), profile tests (82%), authfile tests complete. Pattern set for remaining packages."}
{"id":"caam-9dp","title":"Unit tests for internal/provider/gemini","description":"## Package: internal/provider/gemini\n\nGemini CLI provider implementation.\n\n## What to Test\n- Provider name and display name\n- Settings file path\n- Config directory structure\n- Binary name for exec\n\n## Files to Create\n- internal/provider/gemini/gemini_test.go\n\n## Approach\n- Use t.TempDir() with HOME override\n- Test path construction\n- Verify interface compliance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:49:43.54419094-05:00","updated_at":"2025-12-17T02:17:42.108066069-05:00","closed_at":"2025-12-17T02:17:42.108066069-05:00","close_reason":"Created 38 comprehensive unit tests covering provider identity, auth modes (OAuth, APIKey, VertexADC), auth files, GEMINI_HOME handling, PrepareProfile, Env with mode-specific vars, Logout, Status with mode-specific auth checks, ValidateProfile, and full lifecycle integration tests for all three auth modes. All tests pass.","dependencies":[{"issue_id":"caam-9dp","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:21.220189437-05:00","created_by":"ubuntu"},{"issue_id":"caam-9dp","depends_on_id":"caam-9fd","type":"blocks","created_at":"2025-12-17T01:56:10.593072098-05:00","created_by":"ubuntu"}]}
{"id":"caam-9fd","title":"Unit tests for internal/provider","description":"## Package: internal/provider\n\nProvider interface and registry management.\n\n## What to Test\n- Provider interface contract\n- Registry creation\n- Provider registration\n- Provider lookup by name\n- All() returns all providers\n- Unknown provider handling\n\n## Files to Create\n- internal/provider/provider_test.go\n- internal/provider/registry_test.go\n\n## Approach\n- Create mock-free test provider implementation\n- Test registry operations\n- Verify provider interface compliance","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:49:16.444043828-05:00","updated_at":"2025-12-17T02:00:46.493600728-05:00","closed_at":"2025-12-17T02:00:46.493600728-05:00","close_reason":"Implemented 12 unit tests covering AuthMode constants, AuthFileSpec struct, ProfileStatus struct, Registry (NewRegistry, Register, RegisterOverwrite, Get, All, IDs), and Provider interface compliance","dependencies":[{"issue_id":"caam-9fd","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:05.924055584-05:00","created_by":"ubuntu"}]}
{"id":"caam-9os","title":"OAuth refresh handler for Google Gemini","description":"# OAuth Refresh Handler for Google Gemini\n\n## Purpose\nImplement OAuth token refresh for Google Gemini using standard Google OAuth2 flow.\n\n## Reference (from codex-pool)\n```go\nfunc (h *proxyHandler) refreshGeminiAccount(ctx context.Context, a *Account, \n    refreshTok string) error {\n    form := url.Values{}\n    form.Set(\"client_id\", geminiOAuthClientID())\n    form.Set(\"grant_type\", \"refresh_token\")\n    form.Set(\"refresh_token\", refreshTok)\n    // POST to https://oauth2.googleapis.com/token\n}\n```\n\n**KEY DIFFERENCE**: Gemini uses form-encoded body, NOT JSON!\n\n## Technical Requirements\n\n### Constants\n```go\nconst (\n    GeminiTokenURL = \"https://oauth2.googleapis.com/token\"\n)\n\n// Client ID from gcloud ADC or gemini CLI\nfunc geminiClientID() string {\n    // This may need to be read from the ADC file\n    // or use a known client ID\n}\n```\n\n### Auth File Location\n```\n~/.config/gcloud/application_default_credentials.json\n```\n\n### ADC File Format\n```json\n{\n  \"client_id\": \"764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com\",\n  \"client_secret\": \"d-FL95Q19q7MQmFpd7hHD0Ty\",\n  \"refresh_token\": \"1//...\",\n  \"type\": \"authorized_user\"\n}\n```\n\n**Note**: ADC file contains client_id and client_secret - use these for refresh!\n\n### Refresh Function\n```go\nfunc RefreshGeminiToken(ctx context.Context, clientID, clientSecret, refreshToken string) (*TokenResponse, error) {\n    form := url.Values{}\n    form.Set(\"client_id\", clientID)\n    form.Set(\"client_secret\", clientSecret)\n    form.Set(\"grant_type\", \"refresh_token\")\n    form.Set(\"refresh_token\", refreshToken)\n    \n    req, err := http.NewRequestWithContext(ctx, \"POST\", GeminiTokenURL, \n        strings.NewReader(form.Encode()))\n    req.Header.Set(\"Content-Type\", \"application/x-www-form-urlencoded\")\n    \n    resp, err := http.DefaultClient.Do(req)\n    if err != nil {\n        return nil, fmt.Errorf(\"gemini refresh failed: %w\", err)\n    }\n    defer resp.Body.Close()\n    \n    if resp.StatusCode != 200 {\n        body, _ := io.ReadAll(resp.Body)\n        return nil, fmt.Errorf(\"gemini refresh error %d: %s\", \n            resp.StatusCode, string(body))\n    }\n    \n    var tokenResp TokenResponse\n    json.NewDecoder(resp.Body).Decode(\u0026tokenResp)\n    \n    return \u0026tokenResp, nil\n}\n```\n\n### Google TokenResponse\n```go\n// Google returns slightly different format\ntype GoogleTokenResponse struct {\n    AccessToken  string `json:\"access_token\"`\n    ExpiresIn    int    `json:\"expires_in\"`    // Seconds\n    Scope        string `json:\"scope\"`\n    TokenType    string `json:\"token_type\"`\n    // Note: refresh_token is NOT returned on refresh\n}\n```\n\n### File Update Approach\nFor Gemini/gcloud ADC, we typically do NOT update the ADC file. Instead:\n1. Store the access token separately for caam use\n2. Or update health metadata with expiry only\n3. The ADC file is managed by gcloud CLI\n\n```go\nfunc UpdateGeminiHealth(provider, profile string, resp *TokenResponse) error {\n    // Update health metadata only\n    health := healthStore.GetProfile(provider, profile)\n    health.TokenExpiresAt = time.Now().Add(\n        time.Duration(resp.ExpiresIn) * time.Second)\n    return healthStore.UpdateProfile(provider, profile, health)\n}\n```\n\n## Alternative: Read-Only Approach\nSince gcloud manages ADC, we might just:\n1. Read expiry from access token (if JWT)\n2. Parse token to check expiry\n3. Recommend user run `gcloud auth login` if expired\n\n## Acceptance Criteria\n- [ ] RefreshGeminiToken with form-encoded body\n- [ ] Extracts client_id/secret from ADC file\n- [ ] Updates health metadata with new expiry\n- [ ] Unit tests with mock HTTP server\n- [ ] Handles Google-specific error responses\n- [ ] Documents ADC file management approach\n\n## Files to Create/Modify\n- `internal/refresh/gemini.go` (new)\n- `internal/refresh/gemini_test.go` (new)\n\n## Dependencies\n- Health metadata storage (for updating expiry)\n\n## Considerations\n- Should we modify ADC file or just track expiry?\n- Interaction with `gcloud auth` commands\n- Multiple Google accounts scenario","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:20:37.044266582-05:00","updated_at":"2025-12-17T17:38:54.28050005-05:00","closed_at":"2025-12-17T17:38:54.28050005-05:00","close_reason":"Implemented OAuth refresh logic for Google Gemini. Includes RefreshGeminiToken using standard Google OAuth2 endpoints and form-encoding. Handles ADC file reading.","dependencies":[{"issue_id":"caam-9os","depends_on_id":"caam-thb","type":"blocks","created_at":"2025-12-17T16:28:05.160681937-05:00","created_by":"ubuntu"}],"comments":[{"id":47,"issue_id":"caam-9os","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nFollow-up from caam-dt4: fixed vault refresh path so Gemini refresh uses oauth client credentials from vault `oauth_credentials.json` (ADC-like) and updates `settings.json` access_token/expiry; if credentials are missing/unsupported format, refresh is now reported as skipped (unsupported) instead of hard failing `caam refresh --all`.","created_at":"2025-12-18T03:32:17Z"}]}
{"id":"caam-a4e","title":"Add sessions list command","description":"## Task\nAdd 'caam sessions' command to show all running caam sessions.\n\n## Output Format\n```\nPROVIDER  PROFILE    PID     STARTED         COMMAND\ncodex     work-1     12345   2h ago          codex\nclaude    personal   12346   30m ago         claude -p ...\ngemini    team       -       (stale lock)    -\n```\n\n## Implementation\n- Scan all profiles across all providers\n- Check lock files\n- Validate PIDs (detect stale)\n- Show command if available (could add to lock file)\n\n## Flags\n- --json: JSON output for scripting\n- --provider: Filter by provider\n\n## Acceptance Criteria\n- Shows all locked profiles\n- Identifies stale locks\n- JSON output works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:53:34.768986551-05:00","updated_at":"2025-12-17T01:35:04.588404136-05:00","closed_at":"2025-12-17T01:35:04.588404136-05:00","close_reason":"Sessions command implemented: shows all locked profiles with PID, status (active/stale), duration. Includes --json and --provider flags.","dependencies":[{"issue_id":"caam-a4e","depends_on_id":"caam-pxg","type":"parent-child","created_at":"2025-12-17T00:53:34.786665006-05:00","created_by":"ubuntu"},{"issue_id":"caam-a4e","depends_on_id":"caam-pb7","type":"blocks","created_at":"2025-12-17T00:53:34.787979761-05:00","created_by":"ubuntu"}]}
{"id":"caam-aek","title":"E2E: Test harness and logging infrastructure","description":"Create reusable test harness with detailed logging:\n\n## Components to Build\n1. TestHarness struct:\n   - TempDir management\n   - Fixture loading\n   - Environment variable management\n   - Cleanup handling\n\n2. Logger interface:\n   - Structured logging (JSON + human readable)\n   - Log levels (DEBUG, INFO, WARN, ERROR)\n   - Timestamps and durations\n   - Test context (name, step, iteration)\n\n3. Fixture helpers:\n   - CreateClaudeAuthFixture()\n   - CreateCodexAuthFixture()\n   - CreateGeminiAuthFixture()\n   - CreateProfileFixture()\n\n4. Assertion helpers:\n   - FileExists(path)\n   - FileContains(path, content)\n   - JSONEquals(path, expected)\n   - DirStructureMatches(path, expected)\n\n## Requirements\n- No external dependencies (use testing.T)\n- Verbose output controlled by -v flag\n- Integration with go test -json for CI","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T01:53:12.76462457-05:00","updated_at":"2025-12-17T02:06:44.246005006-05:00","closed_at":"2025-12-17T02:06:44.246005006-05:00","close_reason":"Completed E2E test harness with Logger, TestHarness, fixture helpers (Claude/Codex/Gemini auth, profiles), and assertion helpers. 27 tests pass.","dependencies":[{"issue_id":"caam-aek","depends_on_id":"caam-7a2","type":"blocks","created_at":"2025-12-17T01:55:19.318889376-05:00","created_by":"ubuntu"}]}
{"id":"caam-ai6","title":"Research Gemini CLI headless authentication options","description":"# Research Gemini CLI Headless Auth\n\n## Research Findings (Completed)\n\n### Available Methods\n\n#### 1. Device Code Flow (Recent Update - August 2025)\nGemini CLI now provides an auth URL to copy/paste, returning an activation code. This is similar to device code flow:\n- CLI shows auth URL\n- User opens URL on any device\n- User gets code to enter back in CLI\n- Works in headless environments!\n\n**Status**: This appears to be a recent improvement. Need to verify current behavior.\n\n#### 2. GEMINI_API_KEY Environment Variable\n```bash\nexport GEMINI_API_KEY=\"your-api-key\"\ngemini \"your prompt\"\n```\nDirect API key authentication for Gemini API.\n\n#### 3. GOOGLE_API_KEY Environment Variable\n```bash\nexport GOOGLE_API_KEY=\"your-google-api-key\"\ngemini \"your prompt\"\n```\nGoogle Cloud API key authentication.\n\n#### 4. Application Default Credentials (ADC)\n```bash\nexport GOOGLE_APPLICATION_CREDENTIALS=\"/path/to/service-account.json\"\nexport GOOGLE_CLOUD_PROJECT=\"your-project\"\nexport GOOGLE_CLOUD_LOCATION=\"us-central1\"\ngemini \"your prompt\"\n```\nFor service account authentication - best for automation and CI/CD.\n\n#### 5. BROWSER Workaround (Legacy)\nSet BROWSER to a script that captures the auth URL:\n```bash\n#!/bin/bash\necho \"Auth URL: \\$1\" \u003e\u003e /tmp/gemini-auth-url.txt\n```\nThen manually complete auth on another device.\n\n### Auth Files Location\n\n~/.gemini/\n‚îú‚îÄ‚îÄ google_accounts.json  # Active account email\n‚îú‚îÄ‚îÄ oauth_creds.json      # OAuth credentials  \n‚îú‚îÄ‚îÄ settings.json         # Auth type selection\n‚îú‚îÄ‚îÄ installation_id       # Installation identifier\n‚îî‚îÄ‚îÄ state.json            # Session state\n\n### Implementation Path for caam\n\n1. **Verify Device Code Flow**: Test if current gemini CLI supports URL-based auth\n2. **AuthModeDeviceCode**: If supported, add to Gemini provider\n3. **AuthModeAPIKey**: Support GEMINI_API_KEY and GOOGLE_API_KEY\n4. **AuthModeServiceAccount**: Support ADC for automation\n\n### Files to Modify\n\n- internal/provider/gemini/gemini.go (if exists)\n- Add multiple auth mode support\n\n### Acceptance Criteria\n\n- [ ] Verify current gemini CLI device code behavior\n- [ ] Implement API key mode with GEMINI_API_KEY\n- [ ] Document service account setup for automation\n- [ ] If device code works, implement caam integration\n\n### References\n\n- https://github.com/google-gemini/gemini-cli/issues/1696\n- https://github.com/google-gemini/gemini-cli/discussions/2811\n- https://google-gemini.github.io/gemini-cli/docs/get-started/authentication.html\n- https://medium.com/@fourdollars/conquering-google-login-for-gemini-cli-on-headless-servers-3e9d2649790f","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T17:37:48.105233312-05:00","updated_at":"2025-12-17T18:06:21.505993439-05:00","closed_at":"2025-12-17T18:06:21.505993439-05:00","close_reason":"Research complete. Gemini has API key options (GEMINI_API_KEY) and recent device-code-like flow, but most reliable approach is vault transfer. Service accounts recommended for automation."}
{"id":"caam-asu","title":"Unit tests for internal/profile","description":"## Package: internal/profile (CRITICAL)\n\nProfile management - vault and isolation.\n\n## What to Test\n\n### Store Operations\n- NewStore creation\n- Vault directory creation\n- Profile listing per provider\n- Profile existence checking\n\n### Vault Profiles\n- Backup auth to vault\n- Activate from vault\n- Delete vault profile\n- Active profile detection via hash\n\n### Isolated Profiles\n- Create isolated profile directory\n- Profile HOME setup\n- Login flow (directory structure)\n- Exec environment setup\n- Profile deletion\n\n### Lock Management\n- Lock file creation\n- Lock checking\n- Lock release\n- Stale lock detection (PID validation)\n- Force unlock\n\n## Files to Create\n- internal/profile/store_test.go\n- internal/profile/vault_test.go\n- internal/profile/isolated_test.go\n- internal/profile/lock_test.go\n\n## Approach\n- Use t.TempDir() for all directories\n- Create real file structures\n- Test actual file system behavior\n- PID tests may need process spawning","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T01:50:08.888362969-05:00","updated_at":"2025-12-17T01:57:02.444888855-05:00","closed_at":"2025-12-17T01:57:02.444888855-05:00","close_reason":"Added 23 unit tests covering 82.3% of profile package. Fixed BrowserDisplayName bug.","dependencies":[{"issue_id":"caam-asu","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:26.325293778-05:00","created_by":"ubuntu"},{"issue_id":"caam-asu","depends_on_id":"caam-7nw","type":"blocks","created_at":"2025-12-17T01:56:15.689630399-05:00","created_by":"ubuntu"}]}
{"id":"caam-bgz","title":"Config schema: stealth section","description":"Add stealth configuration options to SPMConfig.\n\n```yaml\nstealth:\n  enabled: false  # Master switch - all stealth features disabled by default\n  \n  delay:\n    min_seconds: 30     # Minimum delay before switch completes\n    max_seconds: 120    # Maximum delay (random between min-max)\n    jitter_seconds: 30  # Additional random 0-N seconds added to delay\n  \n  cooldown:\n    enabled: true       # Track and enforce cooldowns after limit hits\n    codex_hours: 4      # Hours before codex account can be reused after limit\n    claude_hours: 6     # Hours for claude\n    gemini_hours: 4     # Hours for gemini\n    default_hours: 4    # Fallback for unknown providers\n  \n  rotation:\n    enabled: true       # Enable smart profile rotation\n    prefer_healthy: true      # Weight toward profiles with fresh tokens\n    avoid_recent_hours: 2     # Penalize profiles used in last N hours\n    randomness: 0.2           # Random factor (0-1) in rotation scoring\n```\n\n## Validation Rules\n- delay.min_seconds \u003c= delay.max_seconds\n- cooldown.*_hours \u003e= 0\n- rotation.randomness between 0 and 1\n\n## Files\n- internal/config/spm_config.go: Add StealthConfig struct with nested structs\n- internal/config/spm_config_test.go: Test defaults and validation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T21:46:32.668918003-05:00","updated_at":"2025-12-17T23:21:06.081885833-05:00","closed_at":"2025-12-17T23:21:06.081885833-05:00","close_reason":"Implemented StealthConfig with SwitchDelay, Cooldown, and Rotation configs. All features opt-in (disabled by default). Added validation and comprehensive tests.","comments":[{"id":40,"issue_id":"caam-bgz","author":"ubuntu","text":"Revised description - fix confusing enabled flag structure:\n\n```yaml\nstealth:\n  switch_delay:\n    enabled: false          # Master switch for this feature\n    min_seconds: 5\n    max_seconds: 30\n    show_countdown: true\n\n  cooldown:\n    enabled: false          # Master switch for this feature\n    default_minutes: 60\n    track_limit_hits: true\n\n  rotation:\n    enabled: false          # Master switch for this feature\n    algorithm: \"smart\"      # \"smart\" | \"round_robin\" | \"random\"\n```\n\n## Changes from Original Design\n\nREMOVED - Top-level `enabled: false` that conflicted with per-feature `enabled` flags.\n\nRationale: The original design had:\n```yaml\nstealth:\n  enabled: false  # \u003c-- This was confusing\n  switch_delay:\n    enabled: false  # \u003c-- Redundant when parent is disabled\n```\n\nUsers would be confused: \"Do I need to set both? What if parent is true but child is false?\"\n\nNEW DESIGN: Each feature has its OWN `enabled` flag. No parent switch.\n- Want just delays? Set `switch_delay.enabled: true`\n- Want just cooldowns? Set `cooldown.enabled: true`\n- Want everything? Enable each one individually\n\nThis is clearer, more explicit, and avoids the confusing interaction between parent/child enabled flags.\n\n## Files\n- internal/config/spm_config.go: Add StealthConfig struct (per-feature enabled)\n- internal/config/spm_config_test.go: Test defaults and validation\n","created_at":"2025-12-18T03:06:10Z"}]}
{"id":"caam-by4","title":"Terminal UI (TUI) with Bubble Tea","description":"## Overview\nA visual terminal interface for managing caam profiles. While the CLI is fully functional, a TUI provides:\n- At-a-glance view of all profiles across providers\n- Visual feedback on status (logged in, locked, active)\n- Discoverable interface for new users\n- Running session management\n\n## Design (from original spec)\nLayout:\n- Left panel: Provider list (Codex / Claude / Gemini)\n- Center panel: Profiles table (Name, Auth mode, Logged-in?, Last used, Notes)\n- Right panel: Action pane + detail view for selected profile\n\nKeybindings:\n- ‚Üë/‚Üì: Select profile\n- Enter: Run default command (launch CLI)\n- l: Login/refresh auth\n- o: Open account page in browser\n- e: Edit profile (notes, browser config)\n- d: Delete profile (with confirmation)\n- /: Search/filter profiles\n- Tab: Switch between providers\n- q: Quit\n\n## Implementation\nUse Bubble Tea (bubbletea) with:\n- bubbles for standard components (list, table, textinput)\n- lipgloss for styling\n\n## User Value\n- Visual overview prevents mistakes (wrong account)\n- Running sessions visible prevents data corruption\n- Lower learning curve than CLI-only\n\n## Consideration\nTUI should be the default when running 'caam' with no args, but all functionality must remain available via CLI for scripting.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-17T00:51:16.807075968-05:00","updated_at":"2025-12-17T01:46:22.843793337-05:00","closed_at":"2025-12-17T01:46:22.843793337-05:00","close_reason":"All TUI components implemented: scaffolding (caam-qpx), provider panel (caam-ta7), profiles table (caam-nmm), detail panel (caam-f9h), keyboard navigation (caam-j14). TUI is fully functional with three-panel layout and all keybindings wired up."}
{"id":"caam-cfb","title":"Usage analytics CLI command","description":"## Purpose\nAdd `caam usage` command to display profile usage statistics from the command line.\n\n## Background\nUsers should be able to see their usage patterns to understand which profiles\nthey use most, identify underutilized accounts, and optimize their workflow.\n\n## Command Structure\n```bash\n# Summary view (default)\ncaam usage\n\n# Detailed view for specific profile\ncaam usage --profile claude/work --detailed\n\n# Time range filtering\ncaam usage --days 30\ncaam usage --since 2025-12-01\n\n# Output formats\ncaam usage --json\ncaam usage --csv\n```\n\n## Example Output\n```\n$ caam usage\nProfile Usage (last 7 days)\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nclaude/work         42 sessions   18.5 hrs\nclaude/personal     12 sessions    4.2 hrs\ncodex/main          28 sessions   12.1 hrs\ngemini/default       3 sessions    0.5 hrs\n\n$ caam usage --profile claude/work --detailed\nSession History for claude/work\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n2025-12-17 09:15  2.3 hrs  (active)\n2025-12-16 14:20  1.8 hrs\n2025-12-16 09:00  3.1 hrs\n...\n\nTotal: 42 sessions, 18.5 hours over 7 days\nAverage session: 26 minutes\nMost active day: Monday (12 sessions)\n```\n\n## Technical Implementation\n```go\n// cmd/caam/usage.go\nvar usageCmd = \u0026cobra.Command{\n    Use:   \"usage\",\n    Short: \"Display profile usage statistics\",\n    RunE:  runUsage,\n}\n\nfunc init() {\n    usageCmd.Flags().StringP(\"profile\", \"p\", \"\", \"Profile to show (provider/name)\")\n    usageCmd.Flags().Bool(\"detailed\", false, \"Show detailed session history\")\n    usageCmd.Flags().Int(\"days\", 7, \"Number of days to include\")\n    usageCmd.Flags().String(\"since\", \"\", \"Start date (YYYY-MM-DD)\")\n    usageCmd.Flags().String(\"format\", \"table\", \"Output format: table, json, csv\")\n}\n\nfunc runUsage(cmd *cobra.Command, args []string) error {\n    db, err := db.Open()\n    if err != nil {\n        return err\n    }\n    defer db.Close()\n    \n    // Query and format based on flags\n}\n```\n\n## Files to Create/Modify\n- cmd/caam/usage.go\n- cmd/caam/usage_test.go\n- Modify cmd/caam/root.go to add subcommand\n\n## Acceptance Criteria\n- [ ] Summary shows all profiles with session count and duration\n- [ ] Detailed view shows individual sessions for a profile\n- [ ] Time range filtering works correctly\n- [ ] JSON and CSV export work\n- [ ] Handles empty database gracefully\n- [ ] Performance acceptable for large activity logs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:22:53.646488393-05:00","updated_at":"2025-12-17T20:11:12.338404628-05:00","closed_at":"2025-12-17T20:11:12.338404628-05:00","close_reason":"Added caam usage command with summary/detailed views and json/csv output.","dependencies":[{"issue_id":"caam-cfb","depends_on_id":"caam-r36","type":"blocks","created_at":"2025-12-17T16:28:57.057526979-05:00","created_by":"ubuntu"}],"comments":[{"id":21,"issue_id":"caam-cfb","author":"ubuntu","text":"Starting caam usage command: implement cmd/caam/cmd/usage.go with summary + detailed profile view, since/days filtering, and table/json/csv output using internal/db.","created_at":"2025-12-18T01:06:53Z"},{"id":22,"issue_id":"caam-cfb","author":"ubuntu","text":"Implemented  command with summary + per-profile detailed session history, days/since filtering, and table/json/csv output backed by SQLite activity_log. Added tests for empty DB, summary json, and detailed json.","created_at":"2025-12-18T01:10:45Z"},{"id":23,"issue_id":"caam-cfb","author":"ubuntu","text":"(Follow-up) Implemented the caam usage command with summary + per-profile detailed session history, days/since filtering, and table/json/csv output backed by SQLite activity_log. Added tests for empty DB, summary json, and detailed json.","created_at":"2025-12-18T01:11:02Z"}]}
{"id":"caam-ckk","title":"E2E: CLI command workflow tests","description":"End-to-end integration tests for CLI command workflows:\n\n## Test Scenarios\n1. `caam list` - List all profiles across providers\n2. `caam backup \u003cprovider\u003e \u003cemail\u003e` - Backup current auth state\n3. `caam restore \u003cprovider\u003e \u003cemail\u003e` - Restore saved profile\n4. `caam delete \u003cprovider\u003e \u003cemail\u003e` - Delete a saved profile\n5. `caam status` - Show current auth status for all providers\n\n## Requirements\n- Use t.TempDir() for isolated file system tests\n- Real file operations (no mocks)\n- Test actual cobra command execution\n- Detailed logging at each step\n- Test error cases (missing files, invalid profiles)\n\n## Logging Format\nEach test should log:\n- [START] Test name and description\n- [SETUP] Temp directory and fixture creation\n- [EXEC] Command being executed\n- [VERIFY] Expected vs actual results\n- [CLEANUP] Resources cleaned up\n- [PASS/FAIL] Final result with duration","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T01:52:40.357727069-05:00","updated_at":"2025-12-17T02:15:21.938011493-05:00","closed_at":"2025-12-17T02:15:21.938011493-05:00","close_reason":"Completed 9 E2E tests for CLI command workflows: list, backup, restore, delete, status, clear, profile workflow, invalid tool error handling, multi-provider isolation.","dependencies":[{"issue_id":"caam-ckk","depends_on_id":"caam-7a2","type":"blocks","created_at":"2025-12-17T01:54:53.822477208-05:00","created_by":"ubuntu"},{"issue_id":"caam-ckk","depends_on_id":"caam-aek","type":"blocks","created_at":"2025-12-17T01:55:26.082995053-05:00","created_by":"ubuntu"}]}
{"id":"caam-d04","title":"Hide Codex API key input during login","description":"internal/provider/codex/codex.go prompts 'input hidden' but reads via bufio.ReadString which echoes the key. Use term.ReadPassword when stdin is a TTY, with a safe fallback for non-interactive stdin. Add unit test for the non-tty path.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T21:42:37.010427988-05:00","updated_at":"2025-12-17T21:52:53.294908418-05:00","closed_at":"2025-12-17T21:52:53.294908418-05:00","close_reason":"Implemented hidden API key prompt for Codex api-key auth via term.ReadPassword with non-tty fallback; added unit test.","comments":[{"id":38,"issue_id":"caam-d04","author":"ubuntu","text":"Working on this now: implement hidden API key prompt for codex api-key auth (term.ReadPassword when TTY, fallback for non-tty), plus unit test for non-tty path.","created_at":"2025-12-18T02:50:20Z"}]}
{"id":"caam-dmw","title":"Project management CLI commands","description":"## Purpose\nAdd CLI commands for managing project-profile associations.\n\n## Commands\n\n### caam project set\nAssociate current directory with a profile.\n```bash\ncaam project set claude client-a@work.com\n# Output: Associated /home/user/work/client-a with claude/client-a@work.com\n```\n\n### caam project list\nShow all project associations.\n```bash\ncaam project list\n# Output:\n# /home/user/work/client-a\n#   claude: client-a@work.com\n#   codex:  work-main\n#\n# /home/user/personal/blog\n#   claude: personal@gmail.com\n```\n\n### caam project show\nShow associations for current directory.\n```bash\ncd /home/user/work/client-a\ncaam project show\n# Output:\n# Project: /home/user/work/client-a\n# Associations:\n#   claude: client-a@work.com\n#   codex:  work-main\n```\n\n### caam project remove\nRemove association.\n```bash\ncaam project remove claude\n# Output: Removed claude association from /home/user/work/client-a\n```\n\n### caam project clear\nRemove all associations for current directory.\n```bash\ncaam project clear\n# Output: Cleared all associations from /home/user/work/client-a\n```\n\n## Auto-activation Integration\nWhen running `caam activate claude` without specifying a profile:\n1. Check if CWD has an association\n2. If yes, use that profile automatically\n3. If no, use default or prompt user\n\n```bash\ncd /home/user/work/client-a\ncaam activate claude\n# Output: Using project association: claude/client-a@work.com\n# Activated.\n```\n\n## Files to Create/Modify\n- cmd/caam/project.go (project subcommand)\n- cmd/caam/project_test.go\n- cmd/caam/activate.go (add project check)\n\n## Acceptance Criteria\n- [ ] project set associates current directory\n- [ ] project list shows all associations\n- [ ] project show displays current directory associations\n- [ ] project remove deletes single provider association\n- [ ] project clear removes all associations\n- [ ] activate uses project association when available\n- [ ] Clear error messages for edge cases","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:25:49.003391908-05:00","updated_at":"2025-12-17T18:56:39.484397921-05:00","closed_at":"2025-12-17T18:56:39.484397921-05:00","close_reason":"Implemented `caam project` commands (set/list/show/remove/clear) backed by internal/project store, added project-aware `caam activate \u003ctool\u003e` (optional profile) using CWD association or default profile, and added tests.","dependencies":[{"issue_id":"caam-dmw","depends_on_id":"caam-ir7","type":"blocks","created_at":"2025-12-17T16:29:35.619607689-05:00","created_by":"ubuntu"}],"comments":[{"id":8,"issue_id":"caam-dmw","author":"ubuntu","text":"Starting implementation of `caam project` commands (set/list/show/remove/clear) and project-aware `caam activate \u003ctool\u003e` that uses CWD association when present (and config allows). Will add tests + wire into root command.","created_at":"2025-12-17T23:48:30Z"}]}
{"id":"caam-dt4","title":"Refresh/expiry: harden Claude+Gemini refresh and vault path probing","description":"## Problem\n\nDeep review found a few correctness/safety issues in the Smart Profile Management refresh pipeline:\n\n- `internal/refresh/refresh.go:refreshGemini` calls `health.ParseGeminiExpiry(vaultPath)` and then treats `info.Source` as a Google ADC file via `ReadADC(info.Source)`. For vault profiles, `info.Source` is typically `settings.json` (Gemini CLI), which is *not* ADC format. This makes `caam refresh gemini ‚Ä¶` reliably fail and also makes refresh-on-activate noisy.\n- `health.ParseClaudeExpiry(authDir)` assumes `authDir` is an XDG config root and probes `authDir/claude-code/auth.json`, but vault backups store Claude‚Äôs optional XDG file as flat `auth.json` under the profile dir (see README vault structure). This can cause expiry/refresh token discovery to miss valid vaulted auth.\n- `health.ParseGeminiExpiry(authDir)` returns `ErrNoAuthFile` if `settings.json` is missing even if `oauth_credentials.json` exists; it should consider any supported auth file.\n- Claude refresh handler still uses unverified endpoint/client_id placeholders (see caam-fwz close reason). We should avoid making network calls with refresh tokens unless endpoints are known-safe or explicitly configured.\n\n## Goal\n\n- Make refresh behavior safe by default (no accidental network calls to unverified endpoints).\n- Make gemini/claude refresh behavior internally consistent with vault layout.\n- Ensure CLI treats ‚Äúunsupported/not configured‚Äù as skip (not failure) while preserving hard failures for real errors.\n\n## Proposed Fix\n\n1. Add `refresh.UnsupportedError` (wrapping a sentinel `refresh.ErrUnsupported`) and use it for:\n   - Claude refresh when endpoint/client_id are not configured/verified\n   - Gemini refresh when required credential file is missing/unsupported\n2. Update `cmd/caam/cmd/refresh.go` to count `ErrUnsupported` as ‚Äúskipped‚Äù instead of ‚Äúfailed‚Äù.\n3. Update `health.ParseClaudeExpiry(authDir)` probe order when `authDir != \"\"`:\n   - `authDir/.claude.json`\n   - `authDir/auth.json` (vault flattened)\n   - `authDir/claude-code/auth.json` (isolated profile layout)\n4. Update `health.ParseGeminiExpiry(authDir)` so `ErrNoAuthFile` only when *none* of `settings.json` / `oauth_credentials.json` exist.\n5. Update gemini refresh to read credentials from `oauth_credentials.json` (or other ADC-like file in vault) and update the appropriate auth file/health accordingly, otherwise return `ErrUnsupported`.\n\n## Acceptance\n- `caam refresh --all` does not fail just because Claude/Gemini refresh is unsupported; it reports skipped with reason.\n- Unit tests cover new unsupported/skip behavior and vault path probing changes.\n\n## Related\n- caam-fwz (Claude refresh handler placeholders)\n- caam-9os (Gemini refresh handler)\n- caam-thb (expiry parsing)\n","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T22:16:21.041789816-05:00","updated_at":"2025-12-17T22:37:46.538620938-05:00","closed_at":"2025-12-17T22:37:46.538620938-05:00","close_reason":"Hardened refresh/expiry: endpoint allowlists, Gemini vault credentials+settings update, improved Claude/Gemini vault probing, unsupported treated as skip; tests added.","comments":[{"id":45,"issue_id":"caam-dt4","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nClaimed. Investigating internal/refresh + internal/health path probing; will add explicit unsupported/not-configured error type and adjust CLI to treat it as skip, plus fix Gemini credential source selection and Claude vault auth.json probing.","created_at":"2025-12-18T03:16:44Z"},{"id":49,"issue_id":"caam-dt4","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nImplemented refresh/expiry hardening: added `refresh.ErrUnsupported` + `UnsupportedError` and taught `caam refresh` + activate refresh-on-activate to treat unsupported as skipped (not failed). Gemini refresh now reads ADC-like client creds from vault `oauth_credentials.json` and updates `settings.json` access_token/expiry; missing creds becomes unsupported skip. Expiry parsers updated for vault layout (Claude flat `auth.json`) and Gemini ErrNoAuthFile logic. Added unit tests.","created_at":"2025-12-18T03:37:41Z"}]}
{"id":"caam-dw4","title":"Implement 'open' command to open account pages","description":"## Task\nAdd 'caam open' command to open the provider's account management page in the browser.\n\n## Usage\n```bash\ncaam open codex          # Open OpenAI account page\ncaam open claude work-1  # Open Anthropic account page (using work-1's browser config)\ncaam open gemini         # Open Google account page\n```\n\n## Account URLs\n- Codex/OpenAI: https://platform.openai.com/account\n- Claude/Anthropic: https://console.anthropic.com/\n- Gemini/Google: https://myaccount.google.com/ or https://aistudio.google.com/\n\n## Browser Profile Integration\nIf a profile is specified and has browser config, open URL in that browser profile. This ensures you see the correct account's dashboard.\n\n## Implementation\n- Define account URLs per provider\n- Use browser launcher (from browser epic) to open URL\n- If no profile specified, use default browser\n\n## Dependencies\n- Should use browser launcher from browser epic\n- Can work without it (fall back to default browser)\n\n## Acceptance Criteria\n- Opens correct URL for each provider\n- Uses browser profile if configured\n- Falls back to default browser if no config","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T00:55:03.513290492-05:00","updated_at":"2025-12-17T01:39:14.018599226-05:00","closed_at":"2025-12-17T01:39:14.018599226-05:00","close_reason":"Implemented caam open command to open provider account pages with browser profile support","dependencies":[{"issue_id":"caam-dw4","depends_on_id":"caam-1ba","type":"parent-child","created_at":"2025-12-17T00:55:03.533449267-05:00","created_by":"ubuntu"},{"issue_id":"caam-dw4","depends_on_id":"caam-4eg","type":"related","created_at":"2025-12-17T00:55:03.534802505-05:00","created_by":"ubuntu"}]}
{"id":"caam-e36","title":"Proactive Token Refresh","description":"# Proactive Token Refresh\n\n## Purpose\nAutomatically refresh OAuth tokens before they expire, preventing auth failures that disrupt user workflow.\n\n## Background (from codex-pool)\ncodex-pool refreshes tokens 5 minutes before expiry:\n```go\nif a.ExpiresAt.Before(now.Add(5*time.Minute)) {\n    return true  // needs refresh\n}\n```\n\n## Why This Matters\nWhen tokens expire mid-session:\n1. CLI tool fails with auth error\n2. User loses context/momentum\n3. User must manually re-authenticate\n4. Frustrating experience\n\nWith proactive refresh:\n1. Token refreshed before expiry\n2. No disruption to workflow\n3. User may not even notice\n\n## What This Epic Delivers\n1. Provider-specific token expiry parsing\n2. OAuth refresh handlers for Claude, Codex, Gemini\n3. Refresh-on-activate logic\n4. CLI feedback (\"Refreshing token...\")\n5. Integration with health status\n\n## Refresh Strategy\n1. **On profile activation**: If token expires within 10 minutes, refresh\n2. **Optional daemon mode**: Background process watches all profiles (future)\n3. **Manual trigger**: `caam refresh \u003cprovider\u003e \u003cprofile\u003e`\n\n## Provider-Specific Details\n\n### Claude Code\n- Auth file: `~/.claude.ai/oauth.json` (or similar)\n- Expiry: Stored in oauth.json\n- Refresh endpoint: TBD (needs investigation)\n\n### OpenAI Codex\n- Auth file: `~/.codex/auth.json`\n- Token endpoint: `https://auth.openai.com/oauth/token`\n- Request format:\n```json\n{\n  \"client_id\": \"app_EMoamEEZ73f0CkXaXp7hrann\",\n  \"grant_type\": \"refresh_token\",\n  \"refresh_token\": \"...\"\n}\n```\n\n### Google Gemini\n- Auth file: `~/.config/gcloud/application_default_credentials.json`\n- Token endpoint: `https://oauth2.googleapis.com/token`\n- Request format: Form-encoded (not JSON!)\n```\nclient_id=...\u0026grant_type=refresh_token\u0026refresh_token=...\n```\n\n## Safety Considerations\n1. **Never delete working tokens** - refresh to temp file first\n2. **Graceful failure** - if refresh fails, keep old token\n3. **Rate limiting** - cooldown between refresh attempts\n4. **Offline handling** - warn but do not fail\n5. **Atomic writes** - use temp file + rename pattern\n\n## User Experience\n```bash\n$ caam activate claude work\nRefreshing token (expires in 4 minutes)... done\nActivated profile \"work\" for claude\n\n$ caam status\nclaude: work (token valid for 59 minutes) üü¢\ncodex:  personal (token expired) üî¥\n```\n\n## Dependencies\n- Profile Health Foundation (for expiry storage)\n\n## Blocks\n- Nothing directly (standalone feature)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T16:16:24.53763408-05:00","updated_at":"2025-12-17T20:43:58.51948346-05:00","closed_at":"2025-12-17T20:43:58.51948346-05:00","close_reason":"Fully implemented: refresh package (claude.go, codex.go, gemini.go), refresh CLI command with --all/--dry-run/--force/--quiet flags, refresh-on-activate in activate.go. All tests pass.","dependencies":[{"issue_id":"caam-e36","depends_on_id":"caam-3am","type":"blocks","created_at":"2025-12-17T16:26:43.447146158-05:00","created_by":"ubuntu"},{"issue_id":"caam-e36","depends_on_id":"caam-x0g","type":"blocks","created_at":"2025-12-17T16:27:03.879152906-05:00","created_by":"ubuntu"}]}
{"id":"caam-e79","title":"Detect headless environment and suggest device-code flow","description":"# Detect Headless Environment and Suggest Device-Code Flow\n\n## What\n\nAutomatically detect when caam is running in a headless environment and suggest device-code authentication.\n\n## Why\n\nBetter UX: If a user runs \\`caam login codex work\\` on a headless server, the browser OAuth will fail. Instead of a confusing error, caam should:\n1. Detect the headless condition\n2. Suggest using --device-code\n3. Optionally prompt to use device-code automatically\n\n## Detection Heuristics\n\n### 1. No DISPLAY (Linux/Unix)\n\\`\\`\\`go\nfunc hasDisplay() bool {\n    return os.Getenv(\"DISPLAY\") != \"\" || os.Getenv(\"WAYLAND_DISPLAY\") != \"\"\n}\n\\`\\`\\`\n\n### 2. SSH session\n\\`\\`\\`go\nfunc isSSHSession() bool {\n    return os.Getenv(\"SSH_CLIENT\") != \"\" || os.Getenv(\"SSH_TTY\") != \"\"\n}\n\\`\\`\\`\n\n### 3. No TTY\n\\`\\`\\`go\nfunc isInteractive() bool {\n    // Check if stdin is a terminal\n    return term.IsTerminal(int(os.Stdin.Fd()))\n}\n\\`\\`\\`\n\n### 4. Container detection\n\\`\\`\\`go\nfunc inContainer() bool {\n    // Check for /.dockerenv or cgroup indicators\n    if _, err := os.Stat(\"/.dockerenv\"); err == nil {\n        return true\n    }\n    // Check cgroup for docker/lxc\n    data, _ := os.ReadFile(\"/proc/1/cgroup\")\n    return strings.Contains(string(data), \"docker\") ||\n           strings.Contains(string(data), \"lxc\")\n}\n\\`\\`\\`\n\n### 5. WSL without browser\n\\`\\`\\`go\nfunc isWSLWithoutBrowser() bool {\n    data, _ := os.ReadFile(\"/proc/version\")\n    return strings.Contains(strings.ToLower(string(data)), \"microsoft\") \u0026\u0026\n           os.Getenv(\"BROWSER\") == \"\"\n}\n\\`\\`\\`\n\n## Implementation\n\n### File: internal/env/detect.go (new)\n\n\\`\\`\\`go\npackage env\n\n// Environment describes the current runtime environment\ntype Environment struct {\n    HasDisplay    bool\n    IsSSH         bool\n    IsContainer   bool\n    IsWSL         bool\n    IsInteractive bool\n}\n\n// Detect analyzes the current environment\nfunc Detect() *Environment {\n    return \u0026Environment{\n        HasDisplay:    hasDisplay(),\n        IsSSH:         isSSHSession(),\n        IsContainer:   inContainer(),\n        IsWSL:         isWSL(),\n        IsInteractive: isInteractive(),\n    }\n}\n\n// IsHeadless returns true if browser-based auth will likely fail\nfunc (e *Environment) IsHeadless() bool {\n    // Headless if: no display AND (SSH or container)\n    return !e.HasDisplay \u0026\u0026 (e.IsSSH || e.IsContainer)\n}\n\n// SuggestDeviceCode returns true if we should suggest device code flow\nfunc (e *Environment) SuggestDeviceCode() bool {\n    return e.IsHeadless() || (e.IsWSL \u0026\u0026 !e.HasDisplay)\n}\n\\`\\`\\`\n\n### Integration in login command\n\n\\`\\`\\`go\nfunc runLogin(cmd *cobra.Command, args []string) error {\n    // ... existing code ...\n    \n    // Check if browser OAuth was requested in headless environment\n    if !loginDeviceCode \u0026\u0026 provider.AuthMode(prof.AuthMode) == provider.AuthModeOAuth {\n        env := env.Detect()\n        if env.SuggestDeviceCode() {\n            fmt.Println(\"‚ö†Ô∏è  Headless environment detected (no browser available)\")\n            \n            // Check if provider supports device code\n            if supportsDeviceCode(prov) {\n                fmt.Println(\"üí° Tip: Use --device-code flag for headless authentication:\")\n                fmt.Printf(\"   caam login %s %s --device-code\\\\n\\\\n\", tool, profileName)\n                \n                // Optionally prompt\n                if env.IsInteractive {\n                    fmt.Print(\"Use device code flow now? [Y/n]: \")\n                    var response string\n                    fmt.Scanln(\u0026response)\n                    if response == \"\" || strings.ToLower(response)[0] == 'y' {\n                        return runDeviceCodeLogin(ctx, prov, prof)\n                    }\n                }\n            } else {\n                fmt.Printf(\"Note: %s doesn't support device code flow.\\\\n\", tool)\n                fmt.Println(\"You may need to login on a machine with a browser,\")\n                fmt.Println(\"then use 'caam backup' to save and transfer credentials.\")\n            }\n        }\n    }\n    \n    // ... continue with normal flow ...\n}\n\\`\\`\\`\n\n## UX Output Examples\n\n### SSH into headless server, browser OAuth requested:\n\\`\\`\\`\n$ caam login codex work\n‚ö†Ô∏è  Headless environment detected (no browser available)\nüí° Tip: Use --device-code flag for headless authentication:\n   caam login codex work --device-code\n\nUse device code flow now? [Y/n]: y\nStarting Codex device code authentication...\nEnter code ABCD-EFGH at: https://auth.openai.com/codex/device\n\\`\\`\\`\n\n### Provider without device code support:\n\\`\\`\\`\n$ caam login claude work\n‚ö†Ô∏è  Headless environment detected (no browser available)\nNote: claude doesn't support device code flow.\nYou may need to login on a machine with a browser,\nthen use 'caam backup' to save and transfer credentials.\n\\`\\`\\`\n\n## Acceptance Criteria\n\n- [ ] Environment detection works correctly\n- [ ] SSH sessions detected\n- [ ] Containers detected\n- [ ] User-friendly suggestion message\n- [ ] Interactive prompt when appropriate\n- [ ] Graceful fallback when device code not supported\n\n## Testing\n\n- Test on local machine (should not trigger)\n- Test via SSH (should detect)\n- Test in Docker container (should detect)\n- Test with/without DISPLAY set\n\n## Dependencies\n\n- caam-hzu: AuthModeDeviceCode constant\n- caam-v89: --device-code flag","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T17:38:45.003272963-05:00","updated_at":"2025-12-17T18:06:34.401087351-05:00","closed_at":"2025-12-17T18:06:34.401087351-05:00","close_reason":"Removed as over-engineering. Headless detection is fragile (SSH/container/WSL heuristics). Better UX: explicit --device-code flag + helpful error message guiding to vault transfer.","dependencies":[{"issue_id":"caam-e79","depends_on_id":"caam-v89","type":"blocks","created_at":"2025-12-17T17:40:12.985178426-05:00","created_by":"ubuntu"}]}
{"id":"caam-e8o","title":"EPIC: Stealth Mode (Detection Mitigation)","description":"","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-17T21:45:58.398331249-05:00","updated_at":"2025-12-17T21:45:58.398331249-05:00","comments":[{"id":37,"issue_id":"caam-e8o","author":"ubuntu","text":"## Purpose\nReduce the risk of detection when using multiple accounts to work around usage limits.\nThis is an OPT-IN feature for users who want additional protection.\n\n## Background\nWhen users switch accounts immediately after hitting limits, this creates a detectable pattern:\n- Account A: heavy use ‚Üí limit hit ‚Üí silent\n- Account B: silent ‚Üí immediately active\n\nProviders could correlate same IP, device fingerprint, and timing to flag suspicious behavior.\n\n## Scope\nThis epic covers three mitigation features:\n1. Switch delays with random jitter - Makes switching look less automated\n2. Cooldown tracking after limit hits - Prevents immediate reuse of limited accounts\n3. Smart profile rotation - Varies which accounts are used and when\n\n## Design Philosophy\n- **Opt-in**: All features disabled by default (power users want speed)\n- **Configurable**: Each feature has granular settings\n- **Non-blocking**: Delays can be skipped with Ctrl+C\n- **Informative**: Shows countdown/status during delays\n\n## Risk Disclaimer\nThese features REDUCE but do not ELIMINATE detection risk. Users should understand:\n- Multiple accounts to circumvent limits may violate ToS\n- No technical measure can guarantee non-detection\n- Users assume responsibility for their usage patterns\n","created_at":"2025-12-18T02:46:14Z"}]}
{"id":"caam-ela","title":"Implement device code auth for Codex provider","description":"# Pass --device-auth to Codex in Profile Isolation Mode\n\n## Scope\n\nWhen \\`caam login codex \u003cprofile\u003e --device-code\\` is called, pass \\`--device-auth\\` to the underlying \\`codex login\\` command.\n\n## Note: Primary Workflow Doesn't Need This\n\nFor the main auth file swapping workflow:\n\\`\\`\\`bash\ncodex login --device-auth    # Native command - already works!\ncaam backup codex account1   # Existing caam command\n\\`\\`\\`\n\nThis task is only for Profile Isolation mode (\\`caam login\\` / \\`caam exec\\`).\n\n## Implementation\n\nIn internal/provider/codex/codex.go, update Login() to accept options:\n\n\\`\\`\\`go\ntype LoginOptions struct {\n    DeviceCode bool\n}\n\nfunc (p *Provider) Login(ctx context.Context, prof *profile.Profile, opts LoginOptions) error {\n    if opts.DeviceCode {\n        return p.loginWithDeviceCode(ctx, prof)\n    }\n    // ... existing logic\n}\n\nfunc (p *Provider) loginWithDeviceCode(ctx context.Context, prof *profile.Profile) error {\n    cmd := exec.CommandContext(ctx, \"codex\", \"login\", \"--device-auth\")\n    cmd.Env = append(os.Environ(), \"CODEX_HOME=\"+prof.CodexHomePath())\n    cmd.Stdout = os.Stdout\n    cmd.Stderr = os.Stderr\n    cmd.Stdin = os.Stdin\n    return cmd.Run()\n}\n\\`\\`\\`\n\n## Priority: P2\n\nDependency of caam-v89. Only useful for Profile Isolation mode.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T17:36:47.92788581-05:00","updated_at":"2025-12-17T20:51:47.783208279-05:00","closed_at":"2025-12-17T20:51:47.783208279-05:00","close_reason":"Codex provider now supports device code login (codex login --device-auth) for isolated profiles via provider.DeviceCodeProvider.","dependencies":[{"issue_id":"caam-ela","depends_on_id":"caam-hzu","type":"blocks","created_at":"2025-12-17T17:40:02.7817566-05:00","created_by":"ubuntu"}],"comments":[{"id":29,"issue_id":"caam-ela","author":"ubuntu","text":"Working in tandem with caam-v89: implement provider.DeviceCodeProvider for Codex and wire `caam login codex \u003cprofile\u003e --device-code` to run `codex login --device-auth` inside the profile CODEX_HOME.","created_at":"2025-12-18T01:48:34Z"},{"id":31,"issue_id":"caam-ela","author":"ubuntu","text":"Landed in ff48b6d: Codex provider implements DeviceCodeProvider and runs `codex login --device-auth` with CODEX_HOME set to the isolated profile.","created_at":"2025-12-18T01:51:57Z"}]}
{"id":"caam-ewh","title":"Smart profile rotation","description":"Intelligently select profiles to vary usage patterns and reduce detectability.\n\n## The Problem\nIf users always activate profiles in the same order (A ‚Üí B ‚Üí C ‚Üí A...), this creates a detectable pattern. Varying the selection makes usage look more organic.\n\n## Solution\nMulti-factor scoring algorithm for profile selection:\n\n```go\nfunc ScoreProfile(profile, allProfiles, config) float64 {\n    score := 0.0\n    \n    // Factor 1: Health (prefer fresh tokens)\n    if config.PreferHealthy {\n        health := getProfileHealth(profile)\n        if health.TokenExpiresAt.After(time.Now().Add(24*time.Hour)) {\n            score += 100  // Very healthy\n        } else if health.TokenExpiresAt.After(time.Now()) {\n            score += 50   // Healthy but expiring soon\n        }\n        // Expired = score 0\n    }\n    \n    // Factor 2: Cooldown (exclude if in cooldown)\n    if isInCooldown(profile) {\n        score -= 10000  // Effectively excluded\n    }\n    \n    // Factor 3: Recency (penalize recently used)\n    if config.AvoidRecentHours \u003e 0 {\n        lastUsed := getLastActivation(profile)\n        hoursSince := time.Since(lastUsed).Hours()\n        if hoursSince \u003c config.AvoidRecentHours {\n            score -= (config.AvoidRecentHours - hoursSince) * 10\n        }\n    }\n    \n    // Factor 4: Randomness (break ties unpredictably)\n    score += rand.Float64() * config.Randomness * 100\n    \n    return score\n}\n```\n\n## Usage\n```bash\n# Auto-select best profile based on rotation algorithm\ncaam activate claude --next\n# or\ncaam activate claude  # Uses rotation if no default set\n\n# Output:\n# Selected claude/personal-account (score: 142.3)\n#   ‚úì Healthy token (expires in 5 days)\n#   ‚úì Not in cooldown\n#   ‚úì Last used 8 hours ago\n# Activated claude profile 'personal-account'\n\n# See rotation scores for all profiles\ncaam rotate status claude\n# Output:\n# claude profiles (sorted by rotation score):\n#   personal-account: 142.3 ‚úì healthy, last used 8h ago\n#   work-account:     89.1  ‚ö† token expires in 2h, last used 1h ago\n#   backup:          -9900  ‚úó in cooldown (3h remaining)\n```\n\n## When Rotation is Used\n1. `caam activate \u003ctool\u003e --next` - Explicit rotation\n2. `caam activate \u003ctool\u003e` with no profile AND no default set\n3. `caam activate \u003ctool\u003e` when default profile is in cooldown\n\n## Integration with Other Features\n- Uses health data from health subsystem\n- Uses cooldown data from cooldown tracking\n- Uses activation history from activity database\n- Respects stealth config settings\n\n## Files\n- internal/stealth/rotation.go: Scoring algorithm\n- internal/stealth/rotation_test.go: Tests\n- cmd/caam/cmd/activate.go: Integration\n- cmd/caam/cmd/rotate.go: rotate status command","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-17T21:48:08.491084891-05:00","updated_at":"2025-12-17T21:48:08.491084891-05:00","dependencies":[{"issue_id":"caam-ewh","depends_on_id":"caam-5ed","type":"blocks","created_at":"2025-12-17T21:48:20.697708138-05:00","created_by":"ubuntu"},{"issue_id":"caam-ewh","depends_on_id":"caam-bgz","type":"blocks","created_at":"2025-12-17T21:48:25.797932333-05:00","created_by":"ubuntu"}],"comments":[{"id":43,"issue_id":"caam-ewh","author":"ubuntu","text":"Revised description - fix flag naming and score display:\n\n## Purpose\nIntelligently select which profile to activate based on multiple factors,\nreducing predictable patterns that could be detected.\n\n## Flag Naming Fix\nChanged `--next` to `--auto`\n\nRationale: `--next` implies sequential/round-robin which is just ONE algorithm.\n`--auto` better conveys \"let the system choose based on configured algorithm\".\n\n```bash\ncaam activate claude --auto    # System chooses best profile\ncaam activate claude work      # User explicitly chooses 'work' profile\n```\n\n## Score Display Fix\nInstead of confusing numeric scores, show human-readable explanations:\n\nBAD (original):\n```\nProfile     Score\nwork        0.85\npersonal    0.42\nbackup      0.23\n```\n\nGOOD (revised):\n```\nRecommended: work\n  - Last used 2 days ago (good spacing)\n  - No recent limit hits\n  - 45% of total usage (balanced)\n\nAlternatives:\n  personal - Last used 3 hours ago (too recent)\n  backup   - Hit limit 30 mins ago (in cooldown)\n```\n\n## Algorithms\n```yaml\nstealth:\n  rotation:\n    enabled: false\n    algorithm: \"smart\"  # \"smart\" | \"round_robin\" | \"random\"\n```\n\n- **smart**: Multi-factor scoring (time since use, limit history, usage balance)\n- **round_robin**: Simple sequential rotation\n- **random**: Random selection (least predictable but may cluster)\n\n## Files\n- internal/rotation/rotation.go: Scoring algorithms\n- internal/rotation/rotation_test.go: Tests\n- cmd/caam/cmd/activate.go: Add --auto flag, integrate rotation\n\n## Success Criteria\n- `--auto` picks profile based on configured algorithm\n- Human-readable explanations, not raw scores\n- All three algorithms implemented and tested\n","created_at":"2025-12-18T03:06:29Z"}]}
{"id":"caam-f9h","title":"Implement detail/action panel (right)","description":"## Task\nCreate the right panel showing details and available actions for the selected profile.\n\n## Content\n- Profile details (path, created, last used, browser config)\n- Available actions (Enter to run, l to login, etc.)\n- Help text for keybindings\n\n## Visual Example\n```\n‚îå‚îÄ Profile: work-1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Provider:  Codex                  ‚îÇ\n‚îÇ Auth:      oauth                  ‚îÇ\n‚îÇ Status:    Logged in              ‚îÇ\n‚îÇ Path:      ~/.local/share/caam/...‚îÇ\n‚îÇ Created:   2024-01-15             ‚îÇ\n‚îÇ Last used: 2h ago                 ‚îÇ\n‚îÇ Browser:   Chrome (Profile 2)     ‚îÇ\n‚îÇ                                   ‚îÇ\n‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ\n‚îÇ Actions:                          ‚îÇ\n‚îÇ   Enter  Run codex                ‚îÇ\n‚îÇ   l      Login/refresh            ‚îÇ\n‚îÇ   o      Open in browser          ‚îÇ\n‚îÇ   e      Edit profile             ‚îÇ\n‚îÇ   d      Delete                   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Acceptance Criteria\n- Shows selected profile details\n- Updates when selection changes\n- Displays available actions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:52:35.3027184-05:00","updated_at":"2025-12-17T01:39:26.867172596-05:00","closed_at":"2025-12-17T01:39:26.867172596-05:00","close_reason":"Implemented detail/action panel with profile details (name, provider, auth mode, status, path, timestamps, account, browser config) and action keybindings display. Integrated into main TUI layout.","dependencies":[{"issue_id":"caam-f9h","depends_on_id":"caam-by4","type":"parent-child","created_at":"2025-12-17T00:52:35.320508134-05:00","created_by":"ubuntu"},{"issue_id":"caam-f9h","depends_on_id":"caam-qpx","type":"blocks","created_at":"2025-12-17T00:52:35.321914232-05:00","created_by":"ubuntu"}]}
{"id":"caam-fwl","title":"SQLite database setup and migrations","description":"## Purpose\nSet up SQLite database infrastructure for usage analytics and activity tracking.\n\n## Background\nSQLite was chosen over BoltDB (used by codex-pool) for its query flexibility.\nWe need a migration system to handle schema evolution as features are added.\n\n## Technical Requirements\n\n### Database Location\n```\n~/.caam/data/caam.db\n```\n\n### Migration System\n```go\n// internal/db/migrations.go\ntype Migration struct {\n    Version int\n    Name    string\n    Up      string\n    Down    string\n}\n\nvar migrations = []Migration{\n    {\n        Version: 1,\n        Name:    \"initial_schema\",\n        Up: `\n            CREATE TABLE schema_version (\n                version INTEGER PRIMARY KEY,\n                applied_at DATETIME DEFAULT CURRENT_TIMESTAMP\n            );\n            \n            CREATE TABLE activity_log (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                timestamp DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\n                event_type TEXT NOT NULL,\n                provider TEXT NOT NULL,\n                profile_name TEXT NOT NULL,\n                details TEXT,\n                duration_seconds INTEGER\n            );\n            \n            CREATE TABLE profile_stats (\n                provider TEXT NOT NULL,\n                profile_name TEXT NOT NULL,\n                total_activations INTEGER DEFAULT 0,\n                total_errors INTEGER DEFAULT 0,\n                total_active_seconds INTEGER DEFAULT 0,\n                last_activated DATETIME,\n                last_error DATETIME,\n                PRIMARY KEY (provider, profile_name)\n            );\n            \n            CREATE INDEX idx_activity_timestamp ON activity_log(timestamp);\n            CREATE INDEX idx_activity_provider ON activity_log(provider, profile_name);\n        `,\n    },\n}\n\nfunc RunMigrations(db *sql.DB) error {\n    // Apply pending migrations\n}\n```\n\n### Database Manager\n```go\n// internal/db/db.go\ntype DB struct {\n    conn *sql.DB\n}\n\nfunc Open() (*DB, error) {\n    // Ensure directory exists\n    // Open connection with WAL mode\n    // Run migrations\n}\n\nfunc (d *DB) Close() error\n```\n\n## Dependencies\n- Uses modernc.org/sqlite (CGO-free driver)\n- Directory utilities from existing caam code\n\n## Files to Create\n- internal/db/db.go\n- internal/db/migrations.go\n- internal/db/db_test.go\n\n## Acceptance Criteria\n- [ ] Database created automatically on first use\n- [ ] Migrations run idempotently\n- [ ] WAL mode enabled for concurrent reads\n- [ ] Tests verify migration system works\n- [ ] Graceful handling of corrupt database","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:22:11.418686244-05:00","updated_at":"2025-12-17T19:57:08.742627263-05:00","closed_at":"2025-12-17T19:57:08.742627263-05:00","close_reason":"Added SQLite DB infrastructure with migrations, WAL mode, and corruption recovery.","comments":[{"id":17,"issue_id":"caam-fwl","author":"ubuntu","text":"Starting SQLite DB + migrations: add internal/db with Open (WAL mode) + migration runner + tests (including corrupt DB handling). Will use modernc.org/sqlite per spec.","created_at":"2025-12-18T00:52:57Z"},{"id":18,"issue_id":"caam-fwl","author":"ubuntu","text":"Implemented internal/db with modernc.org/sqlite: Open/OpenAt creates ~/.caam/data/caam.db (or CAAM_HOME), enables WAL + foreign_keys, runs idempotent migrations, and auto-renames corrupt DB files before recreating. Added migration + Open tests.","created_at":"2025-12-18T00:56:57Z"}]}
{"id":"caam-fwz","title":"OAuth refresh handler for Claude Code","description":"# OAuth Refresh Handler for Claude Code\n\n## Purpose\nImplement OAuth token refresh for Claude Code to automatically renew tokens before expiry.\n\n## Research Required\n**IMPORTANT**: Claude Code OAuth implementation needs reverse engineering.\n\n### Questions to Answer\n1. Where is the oauth.json file located?\n2. What is the token endpoint URL?\n3. What is the client_id?\n4. Is it JSON body or form-encoded?\n5. What scopes are required?\n\n### Likely Locations to Check\n- `~/.claude/oauth.json`\n- `~/.claude.ai/oauth.json`  \n- `~/.config/claude/oauth.json`\n- Check Claude Code source/docs if available\n\n## Technical Requirements (Template)\n\n### Refresh Function\n```go\nfunc RefreshClaudeToken(ctx context.Context, refreshToken string) (*TokenResponse, error) {\n    // Build request\n    body := map[string]string{\n        \"client_id\":     claudeClientID,\n        \"grant_type\":    \"refresh_token\",\n        \"refresh_token\": refreshToken,\n        // \"scope\":      \"...\",  // if needed\n    }\n    \n    req, err := http.NewRequestWithContext(ctx, \"POST\", claudeTokenURL, ...)\n    req.Header.Set(\"Content-Type\", \"application/json\")  // or form-encoded\n    \n    // Execute\n    resp, err := http.DefaultClient.Do(req)\n    if err != nil {\n        return nil, fmt.Errorf(\"refresh request failed: %w\", err)\n    }\n    defer resp.Body.Close()\n    \n    // Parse response\n    if resp.StatusCode != 200 {\n        // Handle error\n    }\n    \n    var tokenResp TokenResponse\n    json.NewDecoder(resp.Body).Decode(\u0026tokenResp)\n    \n    return \u0026tokenResp, nil\n}\n```\n\n### TokenResponse Structure\n```go\ntype TokenResponse struct {\n    AccessToken  string `json:\"access_token\"`\n    RefreshToken string `json:\"refresh_token,omitempty\"` // May rotate\n    ExpiresIn    int    `json:\"expires_in\"`              // Seconds\n    ExpiresAt    string `json:\"expires_at,omitempty\"`    // ISO8601\n    TokenType    string `json:\"token_type\"`\n}\n```\n\n### File Update\n```go\nfunc UpdateClaudeAuth(path string, resp *TokenResponse) error {\n    // Read existing file\n    existing, _ := os.ReadFile(path)\n    var auth map[string]any\n    json.Unmarshal(existing, \u0026auth)\n    \n    // Update fields\n    auth[\"access_token\"] = resp.AccessToken\n    if resp.RefreshToken != \"\" {\n        auth[\"refresh_token\"] = resp.RefreshToken\n    }\n    auth[\"expires_at\"] = resp.ExpiresAt\n    // ... or calculate from expires_in\n    \n    // Atomic write\n    return atomicWriteJSON(path, auth)\n}\n```\n\n## Safety Requirements\n1. **Never lose refresh token** - if refresh fails, keep original\n2. **Atomic writes** - use temp file + rename\n3. **Backup original** - keep .bak file before overwrite\n4. **Verify new token** - optionally test before committing\n\n## Error Handling\n- Invalid refresh token ‚Üí mark profile as \"needs login\"\n- Network error ‚Üí retry with backoff\n- Rate limited ‚Üí respect Retry-After header\n- Unknown error ‚Üí log and keep original token\n\n## Acceptance Criteria\n- [ ] Research: Document Claude Code OAuth endpoints\n- [ ] RefreshClaudeToken function implemented\n- [ ] UpdateClaudeAuth with atomic writes\n- [ ] Unit tests with mock HTTP server\n- [ ] Integration test with real credentials (optional, manual)\n- [ ] Error handling for all failure modes\n\n## Files to Create/Modify\n- `internal/refresh/claude.go` (new)\n- `internal/refresh/claude_test.go` (new)\n\n## Dependencies\n- Health metadata storage (for updating expiry)\n- Token expiry parsing (for reading current state)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:20:23.871008574-05:00","updated_at":"2025-12-17T17:35:02.534599402-05:00","closed_at":"2025-12-17T17:35:02.534599402-05:00","close_reason":"Implemented OAuth refresh logic for Claude Code. Includes RefreshClaudeToken and UpdateClaudeAuth with atomic writes. Endpoint and Client ID are placeholders needing verification.","dependencies":[{"issue_id":"caam-fwz","depends_on_id":"caam-thb","type":"blocks","created_at":"2025-12-17T16:27:54.952222175-05:00","created_by":"ubuntu"}],"comments":[{"id":46,"issue_id":"caam-fwz","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nFollow-up from caam-dt4: added token endpoint allowlist guard (prevents refresh tokens being posted to non-provider hosts except loopback for tests) and updated CLI to treat refresh unsupported as skipped. Claude endpoint/client_id still best-guess placeholders; needs verification if we want guaranteed Claude refresh support.","created_at":"2025-12-18T03:32:11Z"}]}
{"id":"caam-gir","title":"Runtime Enhancements","description":"# Runtime Enhancements\n\n## Purpose\nImprove runtime behavior with hot reload, file watching, and signal handling for a smoother user experience.\n\n## Background (from codex-pool)\ncodex-pool supports hot reload without restart:\n```go\nPOST /admin/reload ‚Üí h.pool.replace(newAccounts)\n```\n\n## Why This Matters\nUsers often:\n1. Run TUI in one terminal\n2. Add/modify profiles in another terminal\n3. Expect TUI to reflect changes\n\nWithout hot reload, users must restart TUI to see changes.\n\n## What This Epic Delivers\n1. File watching for profiles directory (fsnotify)\n2. Automatic TUI refresh on changes\n3. `caam profiles reload` CLI command\n4. SIGHUP handling for daemon mode\n5. Graceful reload (no state loss)\n\n## Technical Approach\n\n### File Watching\nUse fsnotify to watch:\n- `~/.caam/profiles/` directory\n- Provider-specific auth directories (optional)\n\nEvents to handle:\n- CREATE: New profile added\n- MODIFY: Profile updated\n- DELETE: Profile removed\n- RENAME: Profile renamed\n\n### TUI Integration\n```go\nfunc (m *Model) watchProfiles() {\n    watcher, _ := fsnotify.NewWatcher()\n    watcher.Add(profilesDir)\n    \n    for event := range watcher.Events {\n        m.reloadProfiles()  // async refresh\n    }\n}\n```\n\n### Signal Handling\n```go\nsigChan := make(chan os.Signal, 1)\nsignal.Notify(sigChan, syscall.SIGHUP)\n\ngo func() {\n    for range sigChan {\n        reloadConfiguration()\n    }\n}()\n```\n\n## User Experience\n```\n# Terminal 1: TUI running\n‚îå‚îÄ Claude Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ ‚óè work@company.com   üü¢   ‚îÇ\n‚îÇ   personal@gmail.com üü°   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n# Terminal 2: Add new profile\n$ caam backup claude newproject@corp.com\nProfile saved.\n\n# Terminal 1: Auto-updates!\n‚îå‚îÄ Claude Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ ‚óè work@company.com   üü¢   ‚îÇ\n‚îÇ   personal@gmail.com üü°   ‚îÇ\n‚îÇ   newproject@corp.com üü¢  ‚îÇ  ‚Üê NEW\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Edge Cases\n- Rapid file changes: Debounce (100ms)\n- Corrupted profile: Log warning, skip\n- Permission denied: Log error, continue watching\n- Watch limit exceeded: Fall back to polling\n\n## Dependencies\n- None (independent enhancement)","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-17T16:16:38.029349036-05:00","updated_at":"2025-12-17T20:45:49.816073234-05:00","closed_at":"2025-12-17T20:45:49.816073234-05:00","close_reason":"Fully implemented: watcher package (fsnotify-based with debounce), TUI hot reload integration (automatic refresh on profile changes), profile add/modify/delete detection. All tests pass.","dependencies":[{"issue_id":"caam-gir","depends_on_id":"caam-3am","type":"blocks","created_at":"2025-12-17T16:26:53.664294779-05:00","created_by":"ubuntu"}]}
{"id":"caam-h6a","title":"Implement 'env' command for shell integration","description":"## Task\nAdd 'caam env' command that prints environment variables for shell eval.\n\n## Usage\n```bash\neval \"$(caam env codex work-1)\"\n# Now CODEX_HOME is set, can run codex directly\n\neval \"$(caam env claude personal)\"\n# Now HOME and XDG_CONFIG_HOME are set\n```\n\n## Output Format\n```bash\nexport CODEX_HOME=\"/home/user/.local/share/caam/profiles/codex/work-1/codex_home\"\n```\n\n## Implementation\n- Get provider env vars from Provider.Env()\n- Format as shell export statements\n- Support --unset to print unset commands\n\n## Use Case\nPower users who want to set up environment once and run multiple commands, rather than using 'caam exec' wrapper each time.\n\n## Acceptance Criteria\n- Outputs valid shell syntax\n- Works with bash/zsh\n- Can be eval'd without errors","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T00:54:35.006530391-05:00","updated_at":"2025-12-17T01:37:23.66051241-05:00","closed_at":"2025-12-17T01:37:23.66051241-05:00","close_reason":"Implemented caam env command with --unset and --fish flags for shell integration","dependencies":[{"issue_id":"caam-h6a","depends_on_id":"caam-1ba","type":"parent-child","created_at":"2025-12-17T00:54:35.020449197-05:00","created_by":"ubuntu"}]}
{"id":"caam-hc7","title":"Implement 'use' and 'which' commands for default profiles","description":"## Task\nAdd commands to set and show default profiles per provider.\n\n## `caam use` Command\n```bash\ncaam use codex work-1     # Set work-1 as default for codex\ncaam use claude personal  # Set personal as default for claude\n```\n\nSets the default profile in config. After this, commands that need a profile but don't specify one use the default.\n\n## `caam which` Command\n```bash\ncaam which           # Show defaults for all providers\ncaam which codex     # Show default for codex only\n```\n\nOutput:\n```\ncodex:  work-1\nclaude: personal\ngemini: (none)\n```\n\n## Implementation\n- Add DefaultProfiles map to config (already exists!)\n- use: Update config and save\n- which: Read config and display\n\n## Acceptance Criteria\n- Can set default profile per provider\n- Can view defaults\n- Commands that need profile use default when not specified","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T00:54:29.911282188-05:00","updated_at":"2025-12-17T01:37:04.378795755-05:00","closed_at":"2025-12-17T01:37:04.378795755-05:00","close_reason":"Implemented 'caam use' and 'caam which' commands for setting and viewing default profiles per provider.","dependencies":[{"issue_id":"caam-hc7","depends_on_id":"caam-1ba","type":"parent-child","created_at":"2025-12-17T00:54:29.932504866-05:00","created_by":"ubuntu"}]}
{"id":"caam-hzu","title":"Add AuthModeDeviceCode to provider interface","description":"# Add AuthModeDeviceCode to Provider Interface\n\n## What\n\nExtend the provider.AuthMode enum to include device code flow as a first-class authentication method.\n\n## Why\n\nThe OAuth 2.0 Device Authorization Grant (RFC 8628) is fundamentally different from browser-based OAuth:\n- No localhost redirect needed\n- User authenticates on a separate device\n- CLI polls for token completion\n- Better UX for headless environments\n\nThis deserves its own AuthMode rather than being a flag on OAuth because:\n1. Different flow mechanics (polling vs redirect)\n2. Different timeout characteristics\n3. Different user interaction model\n4. Profiles may be configured specifically for device-code-only scenarios\n\n## Implementation Details\n\n### File: internal/provider/provider.go\n\nAdd new constant:\n\\`\\`\\`go\nconst (\n    AuthModeOAuth      AuthMode = \"oauth\"       // Browser-based OAuth flow\n    AuthModeAPIKey     AuthMode = \"api-key\"     // API key authentication\n    AuthModeDeviceCode AuthMode = \"device-code\" // OAuth device code flow (RFC 8628)\n    AuthModeVertexADC  AuthMode = \"vertex-adc\"  // Vertex AI ADC\n)\n\\`\\`\\`\n\n### Interface Extension\n\nConsider adding optional interface for providers that support device code:\n\\`\\`\\`go\n// DeviceCodeProvider extends Provider with device code flow support\ntype DeviceCodeProvider interface {\n    Provider\n    // SupportsDeviceCode returns true if this provider supports device code flow\n    SupportsDeviceCode() bool\n    // LoginWithDeviceCode initiates device code authentication\n    LoginWithDeviceCode(ctx context.Context, p *profile.Profile) error\n}\n\\`\\`\\`\n\n## Acceptance Criteria\n\n- [ ] AuthModeDeviceCode constant added\n- [ ] DeviceCodeProvider interface defined (optional extension)\n- [ ] Existing code continues to work (no breaking changes)\n- [ ] Documentation comments explain when to use device-code vs oauth\n\n## Testing\n\n- Unit test that AuthModeDeviceCode is distinct from other modes\n- Verify SupportedAuthModes() can include multiple modes\n\n## Notes\n\n- Keep backward compatible - existing profiles with \"oauth\" continue to work\n- Profile.AuthMode field accepts the new value\n- CLI will need to accept --device-code flag separately","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T17:36:22.865093603-05:00","updated_at":"2025-12-17T17:41:58.077570631-05:00","closed_at":"2025-12-17T17:41:58.077570631-05:00","close_reason":"Added AuthModeDeviceCode constant and DeviceCodeProvider interface to provider package."}
{"id":"caam-i4g","title":"Prevent path traversal in vault/profile operations","description":"Fresh-eyes review: user-supplied tool/profile args flow into filepath.Join and then os.RemoveAll in internal/authfile.Vault.Delete and internal/profile.Store.Delete. If a user passes an absolute path (e.g. profile-name '/' or tool '/') filepath.Join can escape the intended base directory and RemoveAll can delete arbitrary paths. Fix by validating tool/profile segments (no separators, no abs/volume, not '.'/'..') inside the authfile/profile packages before any filesystem mutation, and add unit tests.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-17T21:42:04.88163533-05:00","updated_at":"2025-12-17T21:50:04.329067996-05:00","closed_at":"2025-12-17T21:50:04.329067996-05:00","close_reason":"Validated tool/profile segments in authfile vault + isolated profile store to prevent filepath.Join escape and unsafe os.RemoveAll; added unit tests.","comments":[{"id":35,"issue_id":"caam-i4g","author":"ubuntu","text":"Investigating now. Plan: add strict segment validation + safe join in internal/authfile and internal/profile before any file ops (especially Delete/Restore/Create), add unit tests for rejecting '/', '..', and separators. Will run go test + ubs, then bd sync + push.","created_at":"2025-12-18T02:42:24Z"}]}
{"id":"caam-i5j","title":"Signal handler for graceful operations","description":"## Purpose\nImplement signal handling for SIGHUP-triggered reload and graceful shutdown.\n\n## Background\nUnix signals provide a standard way to communicate with running processes.\nSIGHUP traditionally means \"reload configuration\".\nSIGINT/SIGTERM mean \"shutdown gracefully\".\n\n## Signals to Handle\n\n| Signal | Action | Use Case |\n|--------|--------|----------|\n| SIGHUP | Reload profiles | External script triggered refresh |\n| SIGINT | Graceful shutdown | Ctrl+C in terminal |\n| SIGTERM | Graceful shutdown | Process manager (systemd, docker) |\n| SIGUSR1 | Dump stats to log | Debugging/monitoring |\n\n## Technical Implementation\n\n### Signal Handler Package\nCreate internal/signals/signals.go with Handler struct that listens for\nsignals and exposes channels for reload, shutdown, and debug events.\n\n### TUI Integration\nAdd watchSignals() tea.Cmd that listens to the signal handler channels\nand emits appropriate messages (reloadRequestedMsg, tea.Quit, dumpStatsMsg).\n\n### CLI for Sending Signals\nAdd `caam reload` command that finds TUI PID and sends SIGHUP.\n\n### PID File Management\nWrite PID file on TUI start, remove on clean shutdown.\n\n## Files to Create\n- internal/signals/signals.go\n- internal/signals/signals_test.go\n- cmd/caam/reload.go\n\n## Platform Considerations\n- SIGHUP/SIGUSR1 not available on Windows\n- Use build tags for platform-specific implementations\n- Windows alternative: named pipe or file-based signaling\n\n## Acceptance Criteria\n- [ ] SIGHUP triggers profile reload in TUI\n- [ ] SIGINT/SIGTERM cause graceful shutdown\n- [ ] SIGUSR1 dumps stats to log file\n- [ ] PID file created/removed correctly\n- [ ] caam reload command works\n- [ ] Graceful degradation on Windows","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T16:25:08.969830867-05:00","updated_at":"2025-12-17T21:09:59.597288125-05:00","closed_at":"2025-12-17T21:09:59.597288125-05:00","close_reason":"Implemented signal handling + pid file + caam reload: internal/signals handler, TUI integration for SIGHUP reload / SIGINT+SIGTERM quit / SIGUSR1 stats log, and reload CLI command. Tests added.","dependencies":[{"issue_id":"caam-i5j","depends_on_id":"caam-0gx","type":"blocks","created_at":"2025-12-17T16:29:30.518098355-05:00","created_by":"ubuntu"}],"comments":[{"id":32,"issue_id":"caam-i5j","author":"ubuntu","text":"Starting: implement internal/signals handler (SIGHUP reload, SIGINT/SIGTERM shutdown, SIGUSR1 dump), integrate into TUI (reload + quit), manage PID file, and add caam reload command. Agent mail not configured; coordinating via bd comments.","created_at":"2025-12-18T02:00:33Z"},{"id":33,"issue_id":"caam-i5j","author":"ubuntu","text":"Landed in commit 7e59594: added internal/signals (Handler + pid/log helpers), TUI now writes ~/.caam/caam.pid (CAAM_HOME-aware), handles SIGHUP reload, SIGUSR1 dump-to-log, SIGINT/SIGTERM graceful quit, and added caam reload command to send SIGHUP using the pid file. Added unit tests for pid + signals + reload command registration.","created_at":"2025-12-18T02:10:04Z"}]}
{"id":"caam-ii3","title":"Fix PID alive check and TUI alt-screen duplication","description":"Fresh-eyes review: isProcessAlive(pid) treats EPERM as dead on Unix, which can let caam overwrite a pid file that points at a running process owned by another user. Also TUI currently uses tea.WithAltScreen() plus tea.EnterAltScreen in Init(), which is redundant and can cause extra terminal escape sequences.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T21:22:51.507736405-05:00","updated_at":"2025-12-17T21:28:04.067092007-05:00","closed_at":"2025-12-17T21:28:04.067092007-05:00","close_reason":"Fixed EPERM handling in pid process-alive check; removed redundant tea.EnterAltScreen (already using WithAltScreen); added isProcessAlive unit test.","comments":[{"id":34,"issue_id":"caam-ii3","author":"ubuntu","text":"Working on this now: fix Unix isProcessAlive EPERM handling for pid files; remove redundant alt-screen switching in TUI Init (already using WithAltScreen). Will run go test and push.","created_at":"2025-12-18T02:23:17Z"}]}
{"id":"caam-ir7","title":"Project-profile association storage","description":"## Purpose\nCreate storage system for project-profile associations.\n\n## Background\ncodex-pool pins conversations to accounts for context continuity.\nFor caam, we adapt this as \"project-profile associations\" - remembering which\nprofile a user prefers for each project directory.\n\nThis enables workflows like:\n- Freelancers with multiple client accounts\n- Work/personal separation by directory\n- Team projects using team accounts\n\n## Storage Format\n\n### File Location\n~/.caam/projects.json\n\n### Schema\n```json\n{\n  \"version\": 1,\n  \"associations\": {\n    \"/home/user/work/client-a\": {\n      \"claude\": \"client-a@work.com\",\n      \"codex\": \"work-main\"\n    },\n    \"/home/user/personal/blog\": {\n      \"claude\": \"personal@gmail.com\"\n    }\n  },\n  \"defaults\": {\n    \"claude\": \"personal@gmail.com\"\n  }\n}\n```\n\n## Technical Implementation\n\n### Storage Interface\nCreate internal/project/store.go with ProjectStore struct that handles\nloading, saving, and querying project associations.\n\n### Path Matching\nSupport exact paths and glob patterns. Check parent directories if exact\nmatch not found (inheritance).\n\n### Atomic Writes\nUse temp file + rename pattern for thread-safe updates (same pattern as\nexisting profile storage).\n\n## Files to Create\n- internal/project/store.go\n- internal/project/store_test.go\n- internal/project/matcher.go (path matching logic)\n\n## Acceptance Criteria\n- [ ] Load and save project associations\n- [ ] Query by directory path\n- [ ] Parent directory inheritance works\n- [ ] Atomic file writes\n- [ ] Handle missing/corrupt file gracefully\n- [ ] Version field for future migrations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:25:32.022502289-05:00","updated_at":"2025-12-17T17:38:44.186281392-05:00","closed_at":"2025-12-17T17:38:44.186281392-05:00","close_reason":"Implemented project-profile association storage (projects.json) with inheritance + glob matching, atomic writes, and tests.","comments":[{"id":1,"issue_id":"caam-ir7","author":"BlueBear","text":"Claimed by BlueBear. Implementing project association storage in internal/project (store + matcher + tests). No CLI wiring in this bead.","created_at":"2025-12-17T22:28:43Z"},{"id":3,"issue_id":"caam-ir7","author":"ubuntu","text":"Fresh-eyes fix: project association store now canonicalizes provider keys/values on Load/Save (lowercase/trim, deterministic merge) to avoid nondeterministic Resolve and to ensure RemoveAssociation works with legacy/messy stored data. Added regression test.","created_at":"2025-12-17T23:24:46Z"}]}
{"id":"caam-ixy","title":"Detect and capture localhost redirect URLs from CLI output","description":"## Task\nWhen running login commands (codex login, gemini), capture stdout and detect localhost URLs that need to be opened in a browser.\n\n## Background\nCodex CLI and Gemini CLI print a localhost URL during OAuth setup (e.g., http://localhost:1455/callback?code=...). Currently these auto-open in the default browser. We want to intercept and open in the configured browser profile instead.\n\n## Implementation Approach\n1. Wrap exec.Cmd with custom stdout handling\n2. Use io.TeeReader or similar to both display output AND scan for URLs\n3. Regex pattern: `http://localhost:[0-9]+[^ ]*`\n4. When URL detected, suppress default browser open and use our launcher\n\n## Challenges\n- Some CLIs may use stderr for URLs\n- Need to not break interactive features\n- May need PTY for proper terminal handling\n- Timing: URL may appear briefly before auto-open\n\n## Alternative Approach\nSet BROWSER env var to a wrapper script that calls back to caam. This is cleaner but requires a helper script.\n\n## Acceptance Criteria\n- Can detect localhost URLs from codex login output\n- Can detect localhost URLs from gemini output  \n- Normal CLI output still visible to user\n- Works with both stdout and stderr","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:50:31.574510149-05:00","updated_at":"2025-12-17T01:17:41.956736064-05:00","closed_at":"2025-12-17T01:17:41.956736064-05:00","close_reason":"Implemented URL detection for OAuth flows: URLPattern regex, URLDetector io.Writer wrapper, OutputCapture for stdout/stderr, and BROWSER env var helper script generator.","dependencies":[{"issue_id":"caam-ixy","depends_on_id":"caam-4eg","type":"parent-child","created_at":"2025-12-17T00:50:31.58885101-05:00","created_by":"ubuntu"}]}
{"id":"caam-j14","title":"Implement keyboard navigation and actions","description":"## Task\nWire up all keyboard shortcuts to their actions.\n\n## Keybindings\n- q: Quit\n- ‚Üë/‚Üì: Navigate profiles\n- Tab: Switch provider\n- Enter: Run CLI with selected profile\n- l: Login to selected profile\n- o: Open account page in browser (requires browser epic)\n- e: Edit profile\n- d: Delete profile (with confirmation)\n- /: Search/filter mode\n\n## Implementation\n- Handle key events in Update()\n- Dispatch to appropriate actions\n- Show confirmation dialogs for destructive actions\n\n## Dependencies\n- Requires browser epic for 'o' command\n- Edit mode needs separate view state\n\n## Acceptance Criteria\n- All keybindings functional\n- Delete requires confirmation\n- Actions provide visual feedback","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:52:40.395351148-05:00","updated_at":"2025-12-17T01:45:17.918666626-05:00","closed_at":"2025-12-17T01:45:17.918666626-05:00","close_reason":"Implemented all keyboard navigation and actions: fixed 'l' key conflict, added Edit (e), Search/filter mode (/), updated help view and detail panel keybindings display","dependencies":[{"issue_id":"caam-j14","depends_on_id":"caam-by4","type":"parent-child","created_at":"2025-12-17T00:52:40.409454362-05:00","created_by":"ubuntu"},{"issue_id":"caam-j14","depends_on_id":"caam-ta7","type":"blocks","created_at":"2025-12-17T00:52:40.410828349-05:00","created_by":"ubuntu"},{"issue_id":"caam-j14","depends_on_id":"caam-nmm","type":"blocks","created_at":"2025-12-17T00:52:40.411813644-05:00","created_by":"ubuntu"}]}
{"id":"caam-j46","title":"Unit tests for internal/passthrough","description":"## Package: internal/passthrough\n\nSymlink passthrough for isolated profiles.\n\n## What to Test\n- Passthrough directory list\n- Symlink creation\n- Target path resolution\n- Missing target handling\n- Existing symlink handling\n- Symlink verification\n\n## Files to Create\n- internal/passthrough/passthrough_test.go\n\n## Approach\n- Use t.TempDir() for test directories\n- Create real symlinks\n- Verify symlink targets\n- Test edge cases (broken links, missing dirs)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:50:17.581338667-05:00","updated_at":"2025-12-17T02:05:18.386219939-05:00","closed_at":"2025-12-17T02:05:18.386219939-05:00","close_reason":"Implemented comprehensive unit tests for internal/passthrough: DefaultPassthroughs, NewManager, NewManagerWithPaths, AddPassthrough, RemovePassthrough, SetupPassthroughs (symlink creation, nested paths, existing file replacement), VerifyPassthroughs (valid/invalid/broken symlinks), RemovePassthroughs, and full setup-verify-remove cycle. Also fixed os.LookupEnv build error in testutil.","dependencies":[{"issue_id":"caam-j46","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:31.424518709-05:00","created_by":"ubuntu"}]}
{"id":"caam-jig","title":"Headless Authentication Support (Device Code Flow)","description":"# Headless Server Support\n\n## Status: Core Features Complete!\n\nThe primary headless workflows are now fully functional:\n\n### ‚úÖ Completed\n\n| Feature | Status |\n|---------|--------|\n| Device auth setup | Works via native \\`codex login --device-auth\\` + \\`caam backup\\` |\n| Hit-limit ‚Üí switch ‚Üí resume | Works via \\`caam activate\\` + native \\`codex resume\\` |\n| Vault transfer | ‚úÖ \\`caam export/import\\` implemented (caam-zha) |\n| Documentation | ‚úÖ AGENTS.md updated (caam-1r6) |\n| AuthModeDeviceCode constant | ‚úÖ Added (caam-hzu) |\n\n### Remaining (P2/P3 - Profile Isolation Mode Only)\n\nThese are for the **advanced** Profile Isolation mode, not the primary workflow:\n\n| ID | Task | Priority | Purpose |\n|----|------|----------|---------|\n| caam-v89 | --device-code CLI flag | P2 | For \\`caam login\\` in Profile Isolation mode |\n| caam-ela | Codex provider support | P2 | Implementation for above |\n| caam-0gy | Session resume | P3 | For Profile Isolation mode only |\n\n## The Working Workflow\n\n```bash\n# SETUP (on headless server)\ncodex login --device-auth    # Native Codex\ncaam backup codex account1   # Existing caam\n\n# HIT LIMIT ‚Üí SWITCH ‚Üí RESUME\ncaam activate codex account2             # \u003c 1 second!\ncodex resume 019b2e3d-... \"proceed\"      # Native Codex\n```\n\n## Closed Tasks\n\n| ID | Reason |\n|----|--------|\n| caam-1xv | Research complete - Claude lacks good headless option |\n| caam-ai6 | Research complete - vault transfer is best for Gemini |\n| caam-e79 | Removed - headless detection was over-engineering |\n| caam-m5a | Removed - QR code was gold-plating |","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T17:36:00.94446079-05:00","updated_at":"2025-12-17T20:40:21.386555184-05:00","closed_at":"2025-12-17T20:40:21.386555184-05:00","close_reason":"Core headless workflows complete: device auth setup, hit-limit‚Üíswitch‚Üíresume, vault transfer, and documentation. Remaining tasks (caam-v89, caam-ela) are P2 enhancements for Profile Isolation mode."}
{"id":"caam-ljt","title":"Data retention and automatic cleanup","description":"## Purpose\nImplement automatic cleanup of old activity logs to prevent unbounded database growth.\n\n## Background\ncodex-pool uses configurable retention:\n```go\nlogRetention: 7 * 24 * time.Hour, // Keep logs for 7 days\n```\n\ncaam should have similar configurable retention with sensible defaults.\n\n## Configuration\n```yaml\n# ~/.caam/config.yaml\nanalytics:\n  retention_days: 90        # Keep detailed logs for 90 days\n  aggregate_retention: 365  # Keep aggregates for 1 year\n  cleanup_on_startup: true  # Run cleanup when caam starts\n```\n\n## Technical Implementation\n```go\n// internal/db/cleanup.go\n\n// CleanupConfig holds retention settings\ntype CleanupConfig struct {\n    DetailedRetentionDays   int\n    AggregateRetentionDays  int\n}\n\n// DefaultCleanupConfig returns sensible defaults\nfunc DefaultCleanupConfig() CleanupConfig {\n    return CleanupConfig{\n        DetailedRetentionDays:  90,\n        AggregateRetentionDays: 365,\n    }\n}\n\n// Cleanup removes old records\nfunc (d *DB) Cleanup(cfg CleanupConfig) (deleted int, err error) {\n    cutoff := time.Now().AddDate(0, 0, -cfg.DetailedRetentionDays)\n    \n    result, err := d.conn.Exec(`\n        DELETE FROM activity_log \n        WHERE timestamp \u003c ?\n    `, cutoff)\n    \n    if err != nil {\n        return 0, err\n    }\n    \n    deleted, _ = result.RowsAffected()\n    \n    // Optionally VACUUM to reclaim space\n    if deleted \u003e 1000 {\n        _, _ = d.conn.Exec(\"VACUUM\")\n    }\n    \n    return int(deleted), nil\n}\n\n// ScheduledCleanup runs cleanup periodically\nfunc (d *DB) ScheduledCleanup(interval time.Duration, cfg CleanupConfig) {\n    ticker := time.NewTicker(interval)\n    for range ticker.C {\n        d.Cleanup(cfg)\n    }\n}\n```\n\n### CLI Integration\n```bash\n# Manual cleanup\ncaam cleanup --dry-run\ncaam cleanup --older-than 30\n\n# View database stats\ncaam db stats\nDatabase: ~/.caam/data/caam.db\nSize: 2.3 MB\nActivity logs: 15,234 entries\nOldest entry: 2025-09-15\n```\n\n## Files to Create/Modify\n- internal/db/cleanup.go\n- internal/db/cleanup_test.go\n- cmd/caam/cleanup.go (optional CLI command)\n\n## Acceptance Criteria\n- [ ] Old logs are deleted based on retention config\n- [ ] Cleanup is idempotent and safe\n- [ ] VACUUM runs after large deletions\n- [ ] Dry-run mode shows what would be deleted\n- [ ] Cleanup does not block normal operations\n- [ ] Sensible defaults that work for most users","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T16:23:38.014094581-05:00","updated_at":"2025-12-17T21:09:26.283091054-05:00","closed_at":"2025-12-17T21:09:26.283091054-05:00","close_reason":"Implemented data retention and automatic cleanup: added cleanup.go with retention logic, cleanup_test.go with comprehensive tests, cleanup CLI command (caam cleanup with --dry-run/--days/--quiet), and integrated CleanupOnStartup into TUI. All tests pass.","dependencies":[{"issue_id":"caam-ljt","depends_on_id":"caam-fwl","type":"blocks","created_at":"2025-12-17T16:29:12.362276729-05:00","created_by":"ubuntu"},{"issue_id":"caam-ljt","depends_on_id":"caam-0gb","type":"blocks","created_at":"2025-12-17T16:32:09.546260125-05:00","created_by":"ubuntu"}]}
{"id":"caam-m5a","title":"Display QR code for device auth URL (nice-to-have)","description":"# Display QR Code for Device Auth URL\n\n## What\n\nWhen using device code flow, display a QR code that users can scan with their phone to quickly reach the authorization URL.\n\n## Why\n\nQR codes provide faster mobile access:\n- No typing long URLs on phones\n- Works even when URL can't be copy-pasted (some SSH clients)\n- Professional/polished UX\n- Many CLI tools (gh, az) do this successfully\n\n## Implementation\n\n### Dependencies\n\nUse a pure-Go QR code library to avoid external dependencies:\n- github.com/mdp/qrterminal (MIT license, popular)\n- github.com/skip2/go-qrcode (generates image, not terminal)\n\n### File: internal/auth/qrcode.go\n\n\\`\\`\\`go\npackage auth\n\nimport (\n    \"io\"\n    \"os\"\n    \n    \"github.com/mdp/qrterminal/v3\"\n    \"golang.org/x/term\"\n)\n\n// DisplayQRCode prints a QR code to the terminal if stdout is a TTY\nfunc DisplayQRCode(url string, w io.Writer) {\n    // Only show QR if we have a TTY (not piped/redirected)\n    if !term.IsTerminal(int(os.Stdout.Fd())) {\n        return\n    }\n    \n    // Use ASCII mode for compatibility\n    config := qrterminal.Config{\n        Level:     qrterminal.L,\n        Writer:    w,\n        BlackChar: qrterminal.WHITE, // Inverted for dark terminals\n        WhiteChar: qrterminal.BLACK,\n        QuietZone: 1,\n    }\n    qrterminal.GenerateWithConfig(url, config)\n}\n\\`\\`\\`\n\n### Integration in device code flow\n\n\\`\\`\\`go\nfunc (p *Provider) loginWithDeviceCode(ctx context.Context, prof *profile.Profile) error {\n    fmt.Println(\"Starting device code authentication...\")\n    fmt.Println(\"\")\n    \n    // For Codex, we need to capture the output to get the code\n    // Then display our enhanced version\n    \n    // Display QR code pointing to the auth URL\n    authURL := \"https://auth.openai.com/codex/device\"\n    auth.DisplayQRCode(authURL, os.Stdout)\n    \n    fmt.Println(\"\")\n    fmt.Printf(\"Open: %s\\\\n\", authURL)\n    fmt.Println(\"Or scan the QR code above with your phone\")\n    fmt.Println(\"\")\n    \n    // Run the actual codex login --device-auth\n    cmd := exec.CommandContext(ctx, \"codex\", \"login\", \"--device-auth\")\n    // ...\n}\n\\`\\`\\`\n\n## Output Example\n\n\\`\\`\\`\nStarting device code authentication...\n\n  ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñà\n  ‚ñà ‚ñà‚ñà‚ñà ‚ñà ‚ñà‚ñÄ‚ñÑ‚ñà ‚ñÄ ‚ñà ‚ñà‚ñà‚ñà ‚ñà\n  ‚ñà ‚ñÄ‚ñÄ‚ñÄ ‚ñà ‚ñÄ‚ñÑ‚ñÄ ‚ñÑ‚ñà ‚ñà ‚ñÄ‚ñÄ‚ñÄ ‚ñà\n  ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ ‚ñà ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ\n  ‚ñà‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñà‚ñÑ ‚ñÑ‚ñÄ‚ñÑ‚ñÄ‚ñà‚ñÑ‚ñÄ‚ñÑ‚ñà‚ñà\n  ...\n\nOpen: https://auth.openai.com/codex/device\nOr scan the QR code above with your phone\n\nEnter code: ABCD-EFGH\n\\`\\`\\`\n\n## UX Considerations\n\n1. **Terminal compatibility**: QR codes may not render well in all terminals\n   - Detect terminal capabilities if possible\n   - Provide --no-qr flag to disable\n\n2. **Color inversion**: Dark vs light terminals need different rendering\n   - Try to auto-detect (COLORFGBG env var)\n   - Provide --qr-invert flag\n\n3. **Size**: QR code shouldn't overwhelm the terminal\n   - Keep it reasonably sized\n   - Use minimal quiet zone\n\n## Acceptance Criteria\n\n- [ ] QR code displays for device auth URL\n- [ ] Works in common terminals (iTerm2, Terminal.app, GNOME Terminal)\n- [ ] Gracefully skipped if not a TTY\n- [ ] --no-qr flag to disable\n- [ ] URL still printed as text (accessibility)\n\n## Testing\n\n- Visual test in various terminals\n- Test with screen reader (ensure URL is still readable)\n- Test when stdout is piped (QR should not appear)\n\n## Notes\n\nThis is a polish/UX enhancement. Core device code flow should work without this.\nConsider deferring until after core device code is working.\n\n## Dependencies\n\n- caam-ela: Codex device code implementation\n- caam-v89: CLI --device-code flag","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T17:39:18.382441283-05:00","updated_at":"2025-12-17T18:06:45.861881769-05:00","closed_at":"2025-12-17T18:06:45.861881769-05:00","close_reason":"Removed as gold-plating. Codex already displays the URL clearly. QR code adds dependency and complexity for marginal UX gain. Keep caam simple.","dependencies":[{"issue_id":"caam-m5a","depends_on_id":"caam-ela","type":"blocks","created_at":"2025-12-17T17:40:18.087310678-05:00","created_by":"ubuntu"},{"issue_id":"caam-m5a","depends_on_id":"caam-v89","type":"blocks","created_at":"2025-12-17T17:40:23.188174111-05:00","created_by":"ubuntu"}]}
{"id":"caam-nac","title":"Implement browser launcher abstraction","description":"## Task\nCreate internal/browser/browser.go with a Launcher interface and implementations for different browsers.\n\n## Design\n```go\ntype Launcher interface {\n    // Open opens a URL in the configured browser profile\n    Open(url string) error\n    // Name returns the browser name for display\n    Name() string\n}\n\ntype Config struct {\n    Command    string // Browser executable\n    ProfileDir string // Profile directory or name\n}\n```\n\n## Implementations Needed\n1. ChromeLauncher - uses --profile-directory flag\n2. FirefoxLauncher - uses -P flag for profile name\n3. DefaultLauncher - uses OS default (open/xdg-open)\n\n## Platform Considerations\n- macOS: Chrome is at /Applications/Google Chrome.app/Contents/MacOS/Google Chrome\n- Linux: Usually 'google-chrome' or 'chromium-browser'\n- Windows: Complex paths, need registry lookup or common paths\n\n## Rationale\nAbstraction allows us to support multiple browsers and add new ones easily. The interface also makes testing straightforward.\n\n## Acceptance Criteria\n- Launcher interface defined\n- Chrome implementation works on macOS and Linux\n- Firefox implementation works\n- Default fallback works\n- Unit tests for each implementation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T00:50:26.47883372-05:00","updated_at":"2025-12-17T01:16:04.783685539-05:00","closed_at":"2025-12-17T01:16:04.783685539-05:00","close_reason":"Implemented browser launcher abstraction with Launcher interface, ChromeLauncher (--profile-directory), FirefoxLauncher (-P), DefaultLauncher (xdg-open/open), and GenericLauncher. Includes platform-specific browser detection for macOS/Linux/Windows.","dependencies":[{"issue_id":"caam-nac","depends_on_id":"caam-4eg","type":"parent-child","created_at":"2025-12-17T00:50:26.499689437-05:00","created_by":"ubuntu"}]}
{"id":"caam-nh8","title":"Protected profile naming conventions","description":"Implement special handling for system-managed profiles (prefix with underscore).\n\n## Behavior\n- Profiles starting with '_' are 'system profiles' (e.g., _original_claude, _backup_20251217)\n- System profiles are created automatically by safety features\n- Deleting a system profile requires --force flag\n- List command shows system profiles with [system] marker or dimmed\n\n## Profile Types\n- `_original_\u003ctool\u003e`: Pre-caam state, created on first activate\n- `_backup_\u003ctimestamp\u003e`: Auto-backups from smart backup feature\n\n## Implementation\n1. Add IsSystemProfile(name) helper in internal/authfile\n2. Update Vault.Delete() to check for system profile + require force\n3. Update list command to visually distinguish system profiles\n4. Add metadata field to meta.json: {type: 'system'|'user', created_by: 'auto'|'user'}\n\n## Files\n- internal/authfile/authfile.go: Add helpers\n- cmd/caam/cmd/root.go: Update delete command\n- cmd/caam/cmd/root.go: Update list command","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T21:44:01.173048591-05:00","updated_at":"2025-12-17T22:48:12.574768038-05:00","closed_at":"2025-12-17T22:48:12.574768038-05:00","close_reason":"Added system profile convention (_ prefix): ls marks [system], vault delete refuses system profiles unless forced, and backup meta.json now includes type/created_by.","comments":[{"id":50,"issue_id":"caam-nh8","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nClaimed. Implementing system profile conventions (`_`-prefixed): add helper(s) in internal/authfile, prevent delete without --force, and visually mark system profiles in `caam ls`/`caam status` outputs where relevant. Will keep it backward compatible with existing vault meta.json.","created_at":"2025-12-18T03:41:37Z"}]}
{"id":"caam-nmm","title":"Implement profiles table panel (center)","description":"## Task\nCreate the center panel showing profiles for the selected provider as a table.\n\n## Columns\n- Name (profile name)\n- Auth Mode (oauth, api-key)\n- Status (logged in ‚úì/‚úó, locked üîí)\n- Last Used (relative time)\n- Account (label if set)\n\n## Implementation\n- Use bubbles/table component\n- Filter by active provider\n- Up/down navigation\n- Sorting by last used (most recent first)\n\n## Visual Example\n```\n‚îå‚îÄ Codex Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Name          Auth    Status      Last Used   Account  ‚îÇ\n‚îÇ ‚ñ∂ work-1      oauth   ‚úì           2h ago      jeff@... ‚îÇ\n‚îÇ   work-2      oauth   ‚úì           1d ago      bob@...  ‚îÇ\n‚îÇ   personal    api-key ‚úì üîí        now         -        ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Acceptance Criteria\n- Table shows profiles for selected provider\n- Up/down navigation works\n- Status icons accurate\n- Locked profiles show lock icon","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:51:53.73290065-05:00","updated_at":"2025-12-17T01:37:38.990092926-05:00","closed_at":"2025-12-17T01:37:38.990092926-05:00","close_reason":"Implemented profiles table panel with columns for Name, Auth, Status, Last Used. Includes status icons, sort by last used, selection highlighting, and comprehensive tests.","dependencies":[{"issue_id":"caam-nmm","depends_on_id":"caam-by4","type":"parent-child","created_at":"2025-12-17T00:51:53.746797474-05:00","created_by":"ubuntu"},{"issue_id":"caam-nmm","depends_on_id":"caam-qpx","type":"blocks","created_at":"2025-12-17T00:52:10.76287646-05:00","created_by":"ubuntu"}]}
{"id":"caam-pb7","title":"Enhance lock file with PID validation","description":"## Task\nImprove the lock file system to detect stale locks from dead processes.\n\n## Current Lock Format\n```json\n{\"pid\": 12345, \"locked_at\": \"2024-01-15T10:00:00Z\"}\n```\n\n## Enhanced Implementation\n1. Read lock file\n2. Check if PID still exists (os.FindProcess + signal 0)\n3. If process dead, consider lock stale\n4. Optionally auto-clean stale locks\n\n## Platform Considerations\n- Unix: kill(pid, 0) returns error if process doesn't exist\n- Windows: OpenProcess + different error handling\n\n## Code Location\n- internal/profile/profile.go - IsLocked(), Lock(), Unlock()\n- Add: IsLockStale(), CleanStaleLock()\n\n## Acceptance Criteria\n- Can detect if locking process is still running\n- Stale locks reported appropriately\n- Works on Linux and macOS","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:53:08.139140246-05:00","updated_at":"2025-12-17T01:24:04.458474061-05:00","closed_at":"2025-12-17T01:24:04.458474061-05:00","close_reason":"Added LockInfo struct, GetLockInfo(), IsProcessAlive(), IsLockStale(), CleanStaleLock(), and LockWithCleanup() methods. The exec runner now uses LockWithCleanup to automatically clean stale locks from dead processes.","dependencies":[{"issue_id":"caam-pb7","depends_on_id":"caam-pxg","type":"parent-child","created_at":"2025-12-17T00:53:29.6771176-05:00","created_by":"ubuntu"}]}
{"id":"caam-peb","title":"Usage analytics TUI panel","description":"## Purpose\nAdd a usage statistics panel to the TUI showing profile usage patterns visually.\n\n## Background\nThe TUI provides a richer interface than CLI. Usage stats can be displayed in a\ndedicated panel or overlay, accessible via keystroke.\n\n## Design Mockup\n```\n‚îå‚îÄ Usage Statistics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                                                             ‚îÇ\n‚îÇ  Last 7 days                                               ‚îÇ\n‚îÇ                                                             ‚îÇ\n‚îÇ  claude/work         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  42 sess  18.5h  ‚îÇ\n‚îÇ  codex/main          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà      28 sess  12.1h  ‚îÇ\n‚îÇ  claude/personal     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà                12 sess   4.2h  ‚îÇ\n‚îÇ  gemini/default      ‚ñà                      3 sess   0.5h  ‚îÇ\n‚îÇ                                                             ‚îÇ\n‚îÇ  Total: 85 sessions, 35.3 hours                            ‚îÇ\n‚îÇ                                                             ‚îÇ\n‚îÇ  Press [u] to toggle, [1-4] for time range                 ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Keyboard Shortcuts\n- `u` - Toggle usage panel visibility\n- `1` - Last 24 hours\n- `2` - Last 7 days (default)\n- `3` - Last 30 days\n- `4` - All time\n- `esc` - Close panel\n\n## Technical Implementation\n```go\n// internal/tui/usage_panel.go\ntype UsagePanel struct {\n    visible   bool\n    timeRange int // 1=24h, 7=week, 30=month, 0=all\n    stats     []ProfileUsage\n    width     int\n    height    int\n    styles    UsagePanelStyles\n}\n\ntype ProfileUsage struct {\n    Provider     string\n    ProfileName  string\n    SessionCount int\n    TotalHours   float64\n    Percentage   float64 // For bar chart\n}\n\nfunc (u *UsagePanel) SetStats(stats []ProfileUsage)\nfunc (u *UsagePanel) Toggle()\nfunc (u *UsagePanel) SetTimeRange(days int)\nfunc (u *UsagePanel) View() string\n\n// Bar chart rendering\nfunc renderBar(percentage float64, width int) string {\n    filled := int(percentage * float64(width))\n    return strings.Repeat(\"‚ñà\", filled) + strings.Repeat(\" \", width-filled)\n}\n```\n\n### Integration with Main Model\n```go\n// internal/tui/model.go\ntype Model struct {\n    // ... existing fields\n    usagePanel *UsagePanel\n}\n\nfunc (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {\n    switch msg := msg.(type) {\n    case tea.KeyMsg:\n        if key.Matches(msg, m.keys.Usage) {\n            m.usagePanel.Toggle()\n            if m.usagePanel.visible {\n                return m, m.loadUsageStats()\n            }\n        }\n    }\n}\n```\n\n## Files to Create/Modify\n- internal/tui/usage_panel.go\n- internal/tui/usage_panel_test.go\n- internal/tui/model.go (add usagePanel field)\n- internal/tui/keys.go (add Usage keybinding)\n\n## Acceptance Criteria\n- [ ] Panel toggles with u key\n- [ ] Bar chart shows relative usage\n- [ ] Time range switching works\n- [ ] Stats load asynchronously (no UI freeze)\n- [ ] Graceful handling when no data available\n- [ ] Panel respects terminal size","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T16:23:16.833524781-05:00","updated_at":"2025-12-17T20:20:24.669416806-05:00","closed_at":"2025-12-17T20:20:24.669416806-05:00","close_reason":"Added TUI usage stats panel with toggle, time ranges, async loading, and tests.","dependencies":[{"issue_id":"caam-peb","depends_on_id":"caam-r36","type":"blocks","created_at":"2025-12-17T16:29:02.150717061-05:00","created_by":"ubuntu"},{"issue_id":"caam-peb","depends_on_id":"caam-cfb","type":"blocks","created_at":"2025-12-17T16:29:07.256718993-05:00","created_by":"ubuntu"}],"comments":[{"id":24,"issue_id":"caam-peb","author":"ubuntu","text":"Starting TUI usage panel: add internal/tui/usage_panel.go + keybindings (u/1-4/esc), async stats load from internal/db activity_log, and tests for rendering + ranges.","created_at":"2025-12-18T01:13:14Z"},{"id":25,"issue_id":"caam-peb","author":"ubuntu","text":"Implemented Usage Statistics overlay in TUI: new UsagePanel with bar chart + totals, 'u' toggles, '1-4' time ranges, 'esc' closes, and async stats loading from SQLite activity_log. Added unit tests for panel rendering and model key handling.","created_at":"2025-12-18T01:20:13Z"}]}
{"id":"caam-pxg","title":"Session Management","description":"## Overview\nEnhance the existing lock file system to provide robust session tracking and prevent data corruption when multiple processes try to use the same profile.\n\n## Current State\n- Basic lock files exist (profile.Lock(), profile.Unlock())\n- Lock files contain simple JSON with PID and timestamp\n\n## Problems to Solve\n1. Stale locks: If a process crashes, the lock remains\n2. No visibility: Can't see what sessions are running\n3. No protection: Operations don't always check locks\n\n## Goals\n- Detect and clean up stale locks (process no longer running)\n- Show running sessions in CLI and TUI\n- Prevent destructive operations on locked profiles\n- Allow force-unlock for stuck locks\n\n## User Value\n- Prevents accidental data corruption\n- Makes it safe to run multiple caam instances\n- Visibility into what's running","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-17T00:53:03.044026907-05:00","updated_at":"2025-12-17T01:42:02.293200799-05:00","closed_at":"2025-12-17T01:42:02.293200799-05:00","close_reason":"All child tasks completed: sessions list, lock file PID validation, and force-unlock commands."}
{"id":"caam-pyd","title":"Health status display in TUI","description":"# Health Status Display in TUI\n\n## Purpose\nShow profile health status indicators in the TUI profiles panel.\n\n## Design\n\n### Profile Row Layout\n```\n‚îå‚îÄ Claude Profiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Name              Auth   Status        Last Used   Account   ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ ‚óè work@company    oauth  üü¢ 59m left   2h ago      Acme Inc  ‚îÇ\n‚îÇ   personal@gmail  oauth  üü° 12m left   1d ago      -         ‚îÇ\n‚îÇ   test@example    oauth  üî¥ Expired    3d ago      -         ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n### Status Column\nReplace current simple status with health-aware status:\n- Current: ‚úì (logged in) or ‚úó (not logged in)\n- New: üü¢üü°üî¥‚ö™ with time/reason\n\n### Column Width Adjustment\n```go\ncolWidths := struct {\n    name     int\n    auth     int\n    status   int  // Increase for \"üü¢ 59m left\"\n    lastUsed int\n    account  int\n}{\n    name:     16,\n    auth:     8,\n    status:   14,  // Was 10, now needs more for time\n    lastUsed: 12,\n    account:  16,\n}\n```\n\n### Status Bar Enhancement\nShow aggregated health in the status bar:\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ 3 profiles: 2 healthy, 1 warning ‚îÇ Press ? for help        ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Technical Requirements\n\n### ProfileInfo Enhancement\n```go\ntype ProfileInfo struct {\n    Name      string\n    AuthMode  string\n    LoggedIn  bool\n    Locked    bool\n    LastUsed  time.Time\n    Account   string\n    IsActive  bool\n    // New fields:\n    HealthStatus  HealthStatus\n    TokenExpiry   time.Time\n    ErrorCount    int\n    Penalty       float64\n}\n```\n\n### Styles\n```go\nfunc (s ProfilesPanelStyles) StatusStyle(status HealthStatus) lipgloss.Style {\n    switch status {\n    case StatusHealthy:\n        return s.StatusOK  // green\n    case StatusWarning:\n        return lipgloss.NewStyle().Foreground(colorYellow)\n    case StatusCritical:\n        return s.StatusBad  // red\n    default:\n        return lipgloss.NewStyle().Foreground(colorGray)\n    }\n}\n```\n\n### Status Formatting\n```go\nfunc formatTUIStatus(pi *ProfileInfo) string {\n    icon := pi.HealthStatus.Icon()\n    \n    if pi.TokenExpiry.IsZero() {\n        return icon + \" Unknown\"\n    }\n    \n    ttl := time.Until(pi.TokenExpiry)\n    if ttl \u003c= 0 {\n        return icon + \" Expired\"\n    }\n    \n    return icon + \" \" + formatDuration(ttl)\n}\n```\n\n## Detail Panel Enhancement\nShow full health details when profile is selected:\n```\n‚îå‚îÄ Profile Details ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ work@company.com                         ‚îÇ\n‚îÇ                                          ‚îÇ\n‚îÇ Status:    üü¢ Healthy                    ‚îÇ\n‚îÇ Token:     Expires in 59 minutes         ‚îÇ\n‚îÇ Plan:      Pro                           ‚îÇ\n‚îÇ Errors:    0 in last hour                ‚îÇ\n‚îÇ Penalty:   0.0                           ‚îÇ\n‚îÇ                                          ‚îÇ\n‚îÇ [Enter] Activate  [l] Refresh  [d] Delete‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Acceptance Criteria\n- [ ] Health status icons in profile list\n- [ ] Time remaining displayed for each profile\n- [ ] Status bar shows health summary\n- [ ] Detail panel shows full health info\n- [ ] Colors match health status\n- [ ] Updates when health data changes\n\n## Files to Create/Modify\n- `internal/tui/profiles_panel.go` (modify)\n- `internal/tui/detail_panel.go` (modify)\n- `internal/tui/model.go` (modify)\n- `internal/tui/styles.go` (modify)\n\n## Dependencies\n- Health status calculation (caam-3ef)\n- Health metadata storage (caam-6gj)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:18:56.315192859-05:00","updated_at":"2025-12-17T17:24:57.8927832-05:00","closed_at":"2025-12-17T17:24:57.8927832-05:00","close_reason":"Implemented health status display in TUI profiles panel and detail panel. Updated models and styles to support health visualization.","dependencies":[{"issue_id":"caam-pyd","depends_on_id":"caam-3ef","type":"blocks","created_at":"2025-12-17T16:27:42.624440315-05:00","created_by":"ubuntu"}]}
{"id":"caam-qa1","title":"Add --browser flag to profile add command","description":"## Task\nExtend 'caam profile add' to accept browser configuration during profile creation.\n\n## New Flags\n- --browser: Browser type (chrome, firefox, default)\n- --browser-profile: Browser profile name or directory\n\n## Example Usage\n```bash\ncaam profile add codex work --browser chrome --browser-profile 'Profile 2'\ncaam profile add claude personal --browser firefox --browser-profile 'personal-firefox'\n```\n\n## Implementation\n- Add flags to profileAddCmd in cmd/caam/cmd/root.go\n- Pass values to profile.Create()\n- Store in profile.json\n\n## UX Consideration\nCould also support interactive browser selection if flags not provided. List detected Chrome profiles and let user choose.\n\n## Acceptance Criteria\n- Flags accepted and stored in profile\n- Profile loads correctly with browser config\n- Works with existing profiles (backwards compatible)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:50:51.770335947-05:00","updated_at":"2025-12-17T01:21:48.713708067-05:00","closed_at":"2025-12-17T01:21:48.713708067-05:00","close_reason":"Added --browser, --browser-profile, and --browser-name flags to 'profile add' command. Profile status now shows browser config.","dependencies":[{"issue_id":"caam-qa1","depends_on_id":"caam-4eg","type":"parent-child","created_at":"2025-12-17T00:50:51.784339072-05:00","created_by":"ubuntu"},{"issue_id":"caam-qa1","depends_on_id":"caam-ypx","type":"blocks","created_at":"2025-12-17T00:50:51.785523973-05:00","created_by":"ubuntu"}]}
{"id":"caam-qpx","title":"Set up Bubble Tea scaffolding and main model","description":"## Task\nCreate the foundational TUI code structure using Bubble Tea.\n\n## Files to Create\n- internal/ui/model.go - Main application model\n- internal/ui/styles.go - Lipgloss styles\n- internal/ui/keys.go - Keybindings\n\n## Main Model Structure\n```go\ntype Model struct {\n    providers    []string           // codex, claude, gemini\n    activeProvider int              // Currently selected provider\n    profiles     map[string][]*profile.Profile\n    selected     int                // Currently selected profile\n    width, height int               // Terminal dimensions\n    state        viewState          // list, detail, confirm, etc.\n    err          error\n}\n```\n\n## Implementation Notes\n- Implement tea.Model interface (Init, Update, View)\n- Handle window resize events\n- Set up basic layout (will be refined in panel tasks)\n- Add dependency: go get github.com/charmbracelet/bubbletea\n\n## Acceptance Criteria\n- TUI launches with 'caam' (no args)\n- Basic model structure in place\n- Handles resize events\n- Can quit with 'q'","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:51:43.546283097-05:00","updated_at":"2025-12-17T01:26:57.115215337-05:00","closed_at":"2025-12-17T01:26:57.115215337-05:00","close_reason":"TUI scaffolding complete: model.go, styles.go, keys.go implemented. TUI launches with 'caam' (no args), handles resize, quit with 'q'. Build verified.","dependencies":[{"issue_id":"caam-qpx","depends_on_id":"caam-by4","type":"parent-child","created_at":"2025-12-17T00:51:43.566635847-05:00","created_by":"ubuntu"}]}
{"id":"caam-qvq","title":"Unit tests for cmd/caam/cmd","description":"## Package: cmd/caam/cmd\n\nCLI command implementations.\n\n## What to Test\n- Root command setup\n- Subcommand registration\n- Flag parsing\n- Command execution flow\n- Error handling and exit codes\n- JSON output formatting\n- Help text generation\n\n## Commands to Test\n- backup, activate, status, ls, delete, clear, paths\n- profile add/ls/delete/status/unlock\n- login, exec\n- sessions, doctor, init, env, use, which, open\n\n## Files to Create\n- cmd/caam/cmd/root_test.go\n- cmd/caam/cmd/vault_test.go\n- cmd/caam/cmd/profile_test.go\n- cmd/caam/cmd/misc_test.go\n\n## Approach\n- Use Cobra test utilities\n- Capture stdout/stderr\n- Test with t.TempDir() for data\n- Verify command output\n- Check exit codes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:50:49.164096633-05:00","updated_at":"2025-12-17T02:31:07.887724745-05:00","closed_at":"2025-12-17T02:31:07.887724745-05:00","close_reason":"Added 96 unit tests for cmd/caam/cmd package - root, vault, profile, misc commands","dependencies":[{"issue_id":"caam-qvq","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:46.714953612-05:00","created_by":"ubuntu"}]}
{"id":"caam-r36","title":"Activity event logging system","description":"## Purpose\nCreate a system to log all caam events (activations, logins, errors, switches) for analytics.\n\n## Background\ncodex-pool tracks per-request logs. Since caam does not proxy requests, we track what\ncaam controls: profile activations, login events, errors, and profile switches.\n\n## Event Types\n```go\nconst (\n    EventActivate  = \"activate\"   // Profile activated\n    EventLogin     = \"login\"      // User logged in\n    EventRefresh   = \"refresh\"    // Token refreshed\n    EventError     = \"error\"      // Error occurred\n    EventSwitch    = \"switch\"     // Switched from one profile to another\n    EventDeactivate = \"deactivate\" // Profile deactivated\n)\n```\n\n## Technical Implementation\n\n### Event Logger Interface\n```go\n// internal/db/events.go\ntype Event struct {\n    Timestamp   time.Time\n    Type        string\n    Provider    string\n    ProfileName string\n    Details     map[string]interface{}\n    Duration    time.Duration // For session tracking\n}\n\ntype EventLogger interface {\n    Log(event Event) error\n    GetEvents(provider, profile string, since time.Time, limit int) ([]Event, error)\n    GetStats(provider, profile string) (*ProfileStats, error)\n}\n\n// Atomic logging with transaction\nfunc (d *DB) LogEvent(event Event) error {\n    tx, err := d.conn.Begin()\n    if err != nil {\n        return err\n    }\n    defer tx.Rollback()\n    \n    // Insert into activity_log\n    _, err = tx.Exec(`INSERT INTO activity_log (...) VALUES (...)`, ...)\n    if err != nil {\n        return err\n    }\n    \n    // Update profile_stats atomically\n    _, err = tx.Exec(`\n        INSERT INTO profile_stats (provider, profile_name, total_activations)\n        VALUES (?, ?, 1)\n        ON CONFLICT(provider, profile_name) DO UPDATE SET\n            total_activations = total_activations + 1,\n            last_activated = CURRENT_TIMESTAMP\n    `, event.Provider, event.ProfileName)\n    \n    return tx.Commit()\n}\n```\n\n### Session Tracking\nTrack active sessions to calculate duration:\n```go\n// Store session start in memory, write duration on deactivate\ntype SessionTracker struct {\n    mu       sync.Mutex\n    sessions map[string]time.Time // key: \"provider/profile\"\n}\n\nfunc (s *SessionTracker) Start(provider, profile string)\nfunc (s *SessionTracker) End(provider, profile string) time.Duration\n```\n\n## Integration Points\n- Activate command logs EventActivate\n- Login command logs EventLogin\n- Token refresh logs EventRefresh\n- Errors log EventError\n- Profile switch logs EventSwitch + EventActivate\n\n## Files to Create\n- internal/db/events.go\n- internal/db/events_test.go\n- internal/db/session.go\n\n## Acceptance Criteria\n- [ ] All event types are loggable\n- [ ] Profile stats are updated atomically\n- [ ] Session duration is tracked accurately\n- [ ] Events can be queried by provider/profile/time range\n- [ ] Handles concurrent logging safely","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:22:31.646786371-05:00","updated_at":"2025-12-17T20:03:13.605561636-05:00","closed_at":"2025-12-17T20:03:13.605561636-05:00","close_reason":"Added DB-backed activity logging APIs, stats updates, session tracking, and tests.","dependencies":[{"issue_id":"caam-r36","depends_on_id":"caam-fwl","type":"blocks","created_at":"2025-12-17T16:28:51.960082168-05:00","created_by":"ubuntu"}],"comments":[{"id":19,"issue_id":"caam-r36","author":"ubuntu","text":"Starting activity event logging on top of internal/db: add Event types + DB.LogEvent/GetEvents/GetStats and SessionTracker for duration. Will add tests incl concurrent logging.","created_at":"2025-12-18T00:58:51Z"},{"id":20,"issue_id":"caam-r36","author":"ubuntu","text":"Implemented activity logging atop SQLite: internal/db/events.go adds Event types + DB.LogEvent/GetEvents/GetStats with atomic profile_stats updates, plus SessionTracker for durations. Added tests incl concurrent activation logging.","created_at":"2025-12-18T01:03:03Z"}]}
{"id":"caam-rem","title":"Unit tests for internal/exec","description":"## Package: internal/exec\n\nCommand execution runner.\n\n## What to Test\n- Runner creation\n- Environment setup\n- Command building\n- Execution options\n- Lock acquisition during exec\n- Lock release after exec\n- Error handling\n\n## Files to Create\n- internal/exec/runner_test.go\n- internal/exec/env_test.go\n\n## Approach\n- Use simple test commands (echo, true, false)\n- Test environment variable setup\n- Verify lock behavior\n- Test error propagation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:50:32.217539074-05:00","updated_at":"2025-12-17T02:09:01.217993106-05:00","closed_at":"2025-12-17T02:09:01.217993106-05:00","close_reason":"Implemented unit tests for internal/exec: NewRunner (with/without registry), RunOptions struct fields, LoginFlow delegation, Status delegation, RunInteractive alias, environment variable handling. Created mockProvider implementing full provider.Provider interface. Note: actual command execution tested in E2E tests due to os.Exit behavior.","dependencies":[{"issue_id":"caam-rem","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:41.614004184-05:00","created_by":"ubuntu"}]}
{"id":"caam-ta7","title":"Implement provider list panel (left)","description":"## Task\nCreate the left panel showing the list of providers (Codex, Claude, Gemini).\n\n## Design\n- Vertical list of providers\n- Currently selected provider highlighted\n- Show count of profiles per provider\n- Tab key cycles through providers\n\n## Implementation\n- Use bubbles/list or custom component\n- Style with lipgloss (border, colors)\n- Connect to main model's activeProvider\n\n## Visual Example\n```\n‚îå‚îÄ Providers ‚îÄ‚îÄ‚îê\n‚îÇ ‚ñ∂ Codex (3)  ‚îÇ\n‚îÇ   Claude (5) ‚îÇ\n‚îÇ   Gemini (2) ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Acceptance Criteria\n- Shows all three providers\n- Tab key cycles selection\n- Profile counts accurate\n- Visual highlight on selected","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T00:51:48.642239884-05:00","updated_at":"2025-12-17T01:32:43.562092985-05:00","closed_at":"2025-12-17T01:32:43.562092985-05:00","close_reason":"Implemented provider list panel with vertical layout, profile counts, selection highlighting, and integrated into main TUI layout. Added tests.","dependencies":[{"issue_id":"caam-ta7","depends_on_id":"caam-by4","type":"parent-child","created_at":"2025-12-17T00:51:48.656836326-05:00","created_by":"ubuntu"},{"issue_id":"caam-ta7","depends_on_id":"caam-qpx","type":"blocks","created_at":"2025-12-17T00:52:05.677440151-05:00","created_by":"ubuntu"}]}
{"id":"caam-thb","title":"Token expiry parsing for all providers","description":"# Token Expiry Parsing\n\n## Purpose\nParse token expiration timestamps from each provider authentication files to determine how long tokens remain valid.\n\n## Background\nEach provider stores auth differently. We need to extract expiry info from:\n1. Claude Code - oauth.json with expiry field\n2. OpenAI Codex - auth.json with different structure\n3. Google Gemini - gcloud ADC format\n\n## Technical Requirements\n\n### Parser Interface\n```go\ntype ExpiryParser interface {\n    ParseExpiry(authFilePath string) (time.Time, error)\n}\n\nfunc ParseClaudeExpiry(path string) (time.Time, error)\nfunc ParseCodexExpiry(path string) (time.Time, error)\nfunc ParseGeminiExpiry(path string) (time.Time, error)\n```\n\n### Provider-Specific Formats\n\n#### Claude Code\n```json\n// ~/.claude.ai/oauth.json (example, needs verification)\n{\n  \"access_token\": \"...\",\n  \"refresh_token\": \"...\",\n  \"expires_at\": \"2025-12-17T18:00:00Z\",\n  \"token_type\": \"Bearer\"\n}\n```\nAlternative: `expires_in` (seconds) + issued time\n\n#### OpenAI Codex\n```json\n// ~/.codex/auth.json (example, needs verification)\n{\n  \"access_token\": \"...\",\n  \"refresh_token\": \"...\",\n  \"expires_at\": 1734451200,  // Unix timestamp\n  \"token_type\": \"Bearer\"\n}\n```\n\n#### Google Gemini (ADC)\n```json\n// ~/.config/gcloud/application_default_credentials.json\n{\n  \"client_id\": \"...\",\n  \"client_secret\": \"...\",\n  \"refresh_token\": \"...\",\n  \"type\": \"authorized_user\"\n}\n```\nNote: ADC may not store expiry - needs refresh to get expiry.\n\n### Fallback Strategy\nIf expiry cannot be determined:\n1. Check if refresh_token exists ‚Üí assume valid but unknown expiry\n2. No refresh_token ‚Üí mark as \"needs login\"\n3. Return sentinel value for \"unknown expiry\"\n\n## Implementation Notes\n- Study actual auth file formats (may need reverse engineering)\n- Handle missing files gracefully\n- Handle malformed JSON\n- Support both Unix timestamps and ISO8601\n\n## Acceptance Criteria\n- [ ] ParseClaudeExpiry implemented and tested\n- [ ] ParseCodexExpiry implemented and tested  \n- [ ] ParseGeminiExpiry implemented and tested\n- [ ] Handles missing files (returns error)\n- [ ] Handles malformed JSON (returns error)\n- [ ] Unit tests with fixture files\n\n## Files to Create/Modify\n- `internal/health/expiry.go` (new)\n- `internal/health/expiry_test.go` (new)\n- `internal/health/testdata/` (fixtures)\n\n## Research Needed\n- [ ] Verify Claude Code auth file format\n- [ ] Verify Codex auth file format\n- [ ] Determine if Gemini ADC includes expiry\n\n## Dependencies\nNone","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:17:51.23607834-05:00","updated_at":"2025-12-17T16:44:20.264399828-05:00","closed_at":"2025-12-17T16:44:20.264399828-05:00","close_reason":"Implemented token expiry parsing for Claude, Codex, and Gemini providers. Supports ISO8601, RFC3339, Unix timestamps. Includes ExpiryInfo struct with TTL(), IsExpired(), NeedsRefresh() methods. All tests pass.","dependencies":[{"issue_id":"caam-thb","depends_on_id":"caam-6gj","type":"blocks","created_at":"2025-12-17T16:27:17.106895472-05:00","created_by":"ubuntu"}],"comments":[{"id":48,"issue_id":"caam-thb","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nFollow-up from caam-dt4: improved expiry parsers for vault layout ‚Äî Claude now probes flattened `auth.json` in vault dirs, and Gemini no longer returns ErrNoAuthFile when `oauth_credentials.json` exists but lacks expiry/refresh token.","created_at":"2025-12-18T03:32:22Z"}]}
{"id":"caam-u8g","title":"OAuth refresh handler for OpenAI Codex","description":"# OAuth Refresh Handler for OpenAI Codex\n\n## Purpose\nImplement OAuth token refresh for OpenAI Codex based on codex-pool implementation.\n\n## Reference (from codex-pool)\n```go\nfunc (h *proxyHandler) refreshCodexAccount(ctx context.Context, a *Account, \n    refreshTok string) error {\n    body := map[string]string{\n        \"client_id\":     \"app_EMoamEEZ73f0CkXaXp7hrann\",\n        \"grant_type\":    \"refresh_token\",\n        \"refresh_token\": refreshTok,\n        \"scope\":         \"openid profile email\",\n    }\n    // POST to https://auth.openai.com/oauth/token\n}\n```\n\n## Technical Requirements\n\n### Constants\n```go\nconst (\n    CodexTokenURL   = \"https://auth.openai.com/oauth/token\"\n    CodexClientID   = \"app_EMoamEEZ73f0CkXaXp7hrann\"\n    CodexScopes     = \"openid profile email\"\n)\n```\n\n### Refresh Function\n```go\nfunc RefreshCodexToken(ctx context.Context, refreshToken string) (*TokenResponse, error) {\n    body := map[string]string{\n        \"client_id\":     CodexClientID,\n        \"grant_type\":    \"refresh_token\",\n        \"refresh_token\": refreshToken,\n        \"scope\":         CodexScopes,\n    }\n    \n    jsonBody, _ := json.Marshal(body)\n    req, err := http.NewRequestWithContext(ctx, \"POST\", CodexTokenURL, \n        bytes.NewReader(jsonBody))\n    req.Header.Set(\"Content-Type\", \"application/json\")\n    \n    resp, err := http.DefaultClient.Do(req)\n    if err \\!= nil {\n        return nil, fmt.Errorf(\"codex refresh failed: %w\", err)\n    }\n    defer resp.Body.Close()\n    \n    if resp.StatusCode \\!= 200 {\n        body, _ := io.ReadAll(resp.Body)\n        return nil, fmt.Errorf(\"codex refresh error %d: %s\", \n            resp.StatusCode, string(body))\n    }\n    \n    var tokenResp TokenResponse\n    json.NewDecoder(resp.Body).Decode(\u0026tokenResp)\n    \n    return \u0026tokenResp, nil\n}\n```\n\n### Auth File Location\n```\n~/.codex/auth.json\n```\n\n### Auth File Format (expected)\n```json\n{\n  \"access_token\": \"...\",\n  \"refresh_token\": \"...\",\n  \"expires_at\": 1734451200,\n  \"token_type\": \"Bearer\",\n  \"scope\": \"openid profile email\"\n}\n```\n\n### File Update\n```go\nfunc UpdateCodexAuth(path string, resp *TokenResponse) error {\n    existing, _ := os.ReadFile(path)\n    var auth map[string]any\n    json.Unmarshal(existing, \u0026auth)\n    \n    auth[\"access_token\"] = resp.AccessToken\n    if resp.RefreshToken \\!= \"\" {\n        auth[\"refresh_token\"] = resp.RefreshToken\n    }\n    \n    // Calculate expires_at from expires_in\n    if resp.ExpiresIn \u003e 0 {\n        auth[\"expires_at\"] = time.Now().Add(\n            time.Duration(resp.ExpiresIn) * time.Second).Unix()\n    }\n    \n    return atomicWriteJSON(path, auth)\n}\n```\n\n## Verification\nAfter refresh, verify token works:\n```go\nfunc VerifyCodexToken(ctx context.Context, token string) error {\n    req, _ := http.NewRequestWithContext(ctx, \"GET\", \n        \"https://api.openai.com/v1/me\", nil)\n    req.Header.Set(\"Authorization\", \"Bearer \"+token)\n    \n    resp, err := http.DefaultClient.Do(req)\n    if err \\!= nil || resp.StatusCode \\!= 200 {\n        return fmt.Errorf(\"token verification failed\")\n    }\n    return nil\n}\n```\n\n## Acceptance Criteria\n- [ ] RefreshCodexToken implemented per codex-pool reference\n- [ ] UpdateCodexAuth with atomic writes\n- [ ] VerifyCodexToken for optional validation\n- [ ] Unit tests with mock HTTP server\n- [ ] Error handling: invalid token, rate limit, network\n- [ ] Respects Retry-After header on 429\n\n## Files to Create/Modify\n- `internal/refresh/codex.go` (new)\n- `internal/refresh/codex_test.go` (new)\n\n## Dependencies\n- Health metadata storage (for updating expiry)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:20:30.44037626-05:00","updated_at":"2025-12-17T17:37:43.820486153-05:00","closed_at":"2025-12-17T17:37:43.820486153-05:00","close_reason":"Implemented OAuth refresh logic for OpenAI Codex. Includes RefreshCodexToken and UpdateCodexAuth with atomic writes. Uses known Codex endpoints.","dependencies":[{"issue_id":"caam-u8g","depends_on_id":"caam-thb","type":"blocks","created_at":"2025-12-17T16:28:00.053063842-05:00","created_by":"ubuntu"}]}
{"id":"caam-ub6","title":"Refresh-on-activate logic","description":"# Refresh-on-Activate Logic\n\n## Purpose\nImplement the core logic that checks token expiry when activating a profile and triggers refresh if needed.\n\n## Behavior\nWhen user runs `caam activate \u003cprovider\u003e \u003cprofile\u003e`:\n1. Load health data for profile\n2. Check if token expires within threshold (default: 10 minutes)\n3. If expiring soon: trigger refresh\n4. If refresh succeeds: update health, proceed with activation\n5. If refresh fails: warn user, proceed with activation (token might still work)\n\n## Technical Requirements\n\n### Refresh Decision Logic\n```go\nconst (\n    RefreshThreshold = 10 * time.Minute\n)\n\nfunc shouldRefresh(health *ProfileHealth) bool {\n    if health == nil || health.TokenExpiresAt.IsZero() {\n        return false  // Unknown expiry, do not assume refresh needed\n    }\n    \n    ttl := time.Until(health.TokenExpiresAt)\n    return ttl \u003e 0 \u0026\u0026 ttl \u003c RefreshThreshold\n}\n```\n\n### Refresh Orchestration\n```go\nfunc refreshIfNeeded(ctx context.Context, provider, profile string) error {\n    health, err := healthStore.GetProfile(provider, profile)\n    if err != nil || !shouldRefresh(health) {\n        return nil  // No refresh needed\n    }\n    \n    fmt.Printf(\"Refreshing token (expires in %s)... \", \n        formatDuration(time.Until(health.TokenExpiresAt)))\n    \n    var refreshErr error\n    switch provider {\n    case \"claude\":\n        refreshErr = refreshClaudeProfile(ctx, profile)\n    case \"codex\":\n        refreshErr = refreshCodexProfile(ctx, profile)\n    case \"gemini\":\n        refreshErr = refreshGeminiProfile(ctx, profile)\n    }\n    \n    if refreshErr != nil {\n        fmt.Println(\"failed\")\n        log.Printf(\"refresh warning: %v\", refreshErr)\n        // Warn but continue - token might still work\n        return nil\n    }\n    \n    fmt.Println(\"done\")\n    return nil\n}\n```\n\n### Integration with Activate Command\n```go\n// In activate.go\nfunc runActivate(cmd *cobra.Command, args []string) error {\n    provider, profile := parseArgs(args)\n    \n    // Step 1: Refresh if needed\n    ctx := cmd.Context()\n    if err := refreshIfNeeded(ctx, provider, profile); err != nil {\n        // Log but continue\n        log.Printf(\"refresh check failed: %v\", err)\n    }\n    \n    // Step 2: Proceed with activation\n    return activateProfile(provider, profile)\n}\n```\n\n### User Feedback\n```\n$ caam activate claude work\nRefreshing token (expires in 4 minutes)... done\nActivated profile \"work\" for claude\n\n$ caam activate claude work\nActivated profile \"work\" for claude\n(no refresh needed - token valid for 45 minutes)\n```\n\n### Quiet Mode\n```\n$ caam activate claude work --quiet\n(no output, just activates)\n```\n\n## Configuration Options\n```go\ntype RefreshConfig struct {\n    Enabled          bool          // Default: true\n    Threshold        time.Duration // Default: 10 minutes\n    SkipOnError      bool          // Default: true (proceed even if refresh fails)\n    Verbose          bool          // Default: true (show refresh messages)\n}\n```\n\n## Error Handling\n- Refresh fails ‚Üí warn, continue activation\n- Health file unreadable ‚Üí skip refresh, continue\n- Network unavailable ‚Üí skip refresh, continue\n- Unknown provider ‚Üí skip refresh, continue\n\nThe key principle: **never block activation due to refresh issues**.\n\n## Acceptance Criteria\n- [ ] shouldRefresh logic with configurable threshold\n- [ ] refreshIfNeeded orchestrates provider-specific refresh\n- [ ] Integrated into activate command\n- [ ] User feedback shows refresh status\n- [ ] --quiet flag suppresses output\n- [ ] Failures warn but do not block activation\n- [ ] Unit tests for decision logic\n- [ ] Integration tests for full flow\n\n## Files to Create/Modify\n- `internal/refresh/refresh.go` (new)\n- `cmd/caam/cmd/activate.go` (modify)\n\n## Dependencies\n- OAuth refresh handlers (claude, codex, gemini)\n- Health metadata storage","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T16:20:44.570100877-05:00","updated_at":"2025-12-17T17:41:15.618809609-05:00","closed_at":"2025-12-17T17:41:15.618809609-05:00","close_reason":"Implemented Refresh-on-Activate logic. Refactored activate command to activate.go. Added internal/refresh orchestrator and integrated it with health checks and provider-specific refreshers.","dependencies":[{"issue_id":"caam-ub6","depends_on_id":"caam-fwz","type":"blocks","created_at":"2025-12-17T16:28:10.26775758-05:00","created_by":"ubuntu"},{"issue_id":"caam-ub6","depends_on_id":"caam-u8g","type":"blocks","created_at":"2025-12-17T16:28:15.371105866-05:00","created_by":"ubuntu"},{"issue_id":"caam-ub6","depends_on_id":"caam-9os","type":"blocks","created_at":"2025-12-17T16:28:20.471513195-05:00","created_by":"ubuntu"},{"issue_id":"caam-ub6","depends_on_id":"caam-3ef","type":"blocks","created_at":"2025-12-17T16:28:25.570158116-05:00","created_by":"ubuntu"},{"issue_id":"caam-ub6","depends_on_id":"caam-0gb","type":"blocks","created_at":"2025-12-17T16:32:04.445673128-05:00","created_by":"ubuntu"}],"comments":[{"id":2,"issue_id":"caam-ub6","author":"ubuntu","text":"Fresh-eyes fix: activate build was broken (tool var typo/ununsed import + missing health store). Fixed cmd/caam/cmd/activate.go compilation, initialized health store in cmd/caam/cmd/root.go PersistentPreRunE, and adjusted refresh output. go test + race green.","created_at":"2025-12-17T23:24:36Z"}]}
{"id":"caam-v51","title":"Unit tests for internal/provider/claude","description":"## Package: internal/provider/claude\n\nClaude Code provider implementation.\n\n## What to Test\n- Provider name and display name\n- Auth file paths returned correctly\n- Path expansion (~ handling)\n- Multiple auth file handling\n- File existence checking\n\n## Files to Create\n- internal/provider/claude/claude_test.go\n\n## Approach\n- Use t.TempDir() with HOME override\n- Create fake auth file structure\n- Test path resolution\n- No actual Claude auth needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:49:24.421551392-05:00","updated_at":"2025-12-17T02:15:42.336208477-05:00","closed_at":"2025-12-17T02:15:42.336208477-05:00","close_reason":"Created 34 comprehensive unit tests covering provider identity, auth modes, auth files, XDG_CONFIG_HOME handling, PrepareProfile, API key helper setup, Env, Logout, Status, ValidateProfile, and full lifecycle integration tests (OAuth and API key modes). All tests pass.","dependencies":[{"issue_id":"caam-v51","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:54:11.011963528-05:00","created_by":"ubuntu"},{"issue_id":"caam-v51","depends_on_id":"caam-9fd","type":"blocks","created_at":"2025-12-17T01:56:00.389147167-05:00","created_by":"ubuntu"}]}
{"id":"caam-v89","title":"Add --device-code flag to caam login command","description":"# Add --device-code flag to caam login (Profile Isolation Mode)\n\n## IMPORTANT: Primary Workflow Doesn't Need This\n\nFor auth file swapping (the primary use case), users can already do:\n\\`\\`\\`bash\ncodex login --device-auth    # Native Codex command\ncaam backup codex account1   # Existing caam command\n\\`\\`\\`\n\nNo changes to caam needed for the primary workflow!\n\n## When This Is Useful\n\nThis flag is for **Profile Isolation mode** - when users want isolated CODEX_HOME directories for parallel sessions:\n\n\\`\\`\\`bash\n# Create isolated profiles with device-code auth\ncaam login codex work --device-code     # Isolated profile \"work\"\ncaam login codex personal --device-code # Isolated profile \"personal\"\n\n# Run parallel sessions\ncaam exec codex work -- \"task A\"\ncaam exec codex personal -- \"task B\"   # Different account, simultaneous\n\\`\\`\\`\n\n## Implementation (Simple)\n\nJust pass \\`--device-auth\\` to the underlying \\`codex login\\` when flag is set:\n\n\\`\\`\\`go\nif loginDeviceCode {\n    if tool == \"codex\" {\n        args = append(args, \"--device-auth\")\n    } else {\n        return fmt.Errorf(\"%s doesn't support --device-code\\\\n\\\\n\"+\n            \"For headless setup, use native login + caam backup:\\\\n\"+\n            \"  %s login\\\\n\"+\n            \"  caam backup %s \u003cname\u003e\", tool, tool, tool)\n    }\n}\n\\`\\`\\`\n\n## Priority: P2\n\nUseful for advanced Profile Isolation users, but primary workflow already works.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T17:38:13.43380822-05:00","updated_at":"2025-12-17T20:51:42.676486082-05:00","closed_at":"2025-12-17T20:51:42.676486082-05:00","close_reason":"Added --device-code flag to caam login; uses provider DeviceCodeProvider to run device-auth flow for codex isolated profiles.","dependencies":[{"issue_id":"caam-v89","depends_on_id":"caam-hzu","type":"blocks","created_at":"2025-12-17T17:40:07.882564117-05:00","created_by":"ubuntu"}],"comments":[{"id":28,"issue_id":"caam-v89","author":"ubuntu","text":"Starting: add --device-code to `caam login` (isolated profiles) and route to provider.DeviceCodeProvider when supported (Codex =\u003e codex login --device-auth). Will add tests + update codex provider SupportedAuthModes.","created_at":"2025-12-18T01:48:29Z"},{"id":30,"issue_id":"caam-v89","author":"ubuntu","text":"Landed in ff48b6d: `caam login codex \u003cprofile\u003e --device-code` calls DeviceCodeProvider.LoginWithDeviceCode; errors if provider does not support device code. Tests updated for login flag presence.","created_at":"2025-12-18T01:51:52Z"}]}
{"id":"caam-vwo","title":"Unit tests for internal/version","description":"## Package: internal/version\n\nSimple version information package - good starting point.\n\n## What to Test\n- Version() returns non-empty string\n- Commit() returns valid commit hash format\n- Date() returns valid date format\n- Full version string formatting\n\n## Files to Create\n- internal/version/version_test.go\n\n## Approach\n- Simple assertions on return values\n- No external dependencies needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T01:48:36.267048963-05:00","updated_at":"2025-12-17T01:58:22.879662567-05:00","closed_at":"2025-12-17T01:58:22.879662567-05:00","close_reason":"Implemented 8 unit tests covering Info(), Short(), default values, format structure, determinism, and Go version inclusion","dependencies":[{"issue_id":"caam-vwo","depends_on_id":"caam-0dy","type":"blocks","created_at":"2025-12-17T01:53:50.597811251-05:00","created_by":"ubuntu"}]}
{"id":"caam-wuc","title":"Project Context","description":"# Project Context (Directory-Profile Association)\n\n## Purpose\nRemember which profile a user prefers for each project directory, enabling automatic or suggested profile activation based on working directory.\n\n## Background (from codex-pool)\ncodex-pool pins conversations to accounts:\n```go\nif conversationID != \"\" {\n    if id, ok := p.convPin[conversationID]; ok {\n        return p.getLocked(id)\n    }\n}\n```\n\n## Adaptation for caam\nReframed as \"project-profile association\":\n- Associate directories with profiles\n- Suggest or auto-activate based on CWD\n- Support multi-provider associations\n\n## Use Cases\n1. **Multi-client freelancer**: Different clients = different accounts\n2. **Work/personal separation**: Work projects use work account\n3. **Team projects**: Shared projects use team account\n4. **Open source vs enterprise**: Different profiles for different contexts\n\n## What This Epic Delivers\n1. Project-profile association storage\n2. Working directory detection\n3. Association CLI commands\n4. Integration with `caam activate`\n5. TUI project indicator (optional)\n\n## Storage Format\n```json\n// ~/.caam/projects.json\n{\n  \"associations\": {\n    \"/home/user/work/client-a\": {\n      \"claude\": \"client-a@work.com\",\n      \"codex\": \"work-main\"\n    },\n    \"/home/user/personal/blog\": {\n      \"claude\": \"personal@gmail.com\"\n    }\n  },\n  \"settings\": {\n    \"auto_activate\": false,\n    \"suggest_on_mismatch\": true\n  }\n}\n```\n\n## Matching Strategy\n1. Exact match: `/home/user/work/client-a`\n2. Parent directory: If CWD is `/home/user/work/client-a/src`, match parent\n3. Glob patterns (future): `/home/user/work/*` ‚Üí work profile\n\n## User Experience\n```bash\n# Associate current directory with a profile\n$ cd /home/user/work/client-a\n$ caam project set claude client-a@work.com\nAssociated with claude/client-a@work.com\n\n# List associations\n$ caam project list\n/home/user/work/client-a\n  claude: client-a@work.com\n  codex:  work-main\n\n# Activate with suggestion\n$ cd /home/user/work/client-a\n$ caam activate claude\nUsing project association: client-a@work.com\nActivated.\n\n# Mismatch warning\n$ caam activate claude personal@gmail.com\nWarning: Project associated with client-a@work.com\nContinue with personal@gmail.com? [y/N]\n```\n\n## Configuration Options\n- `auto_activate`: Automatically use association (no prompt)\n- `suggest_on_mismatch`: Warn when activating non-associated profile\n- `inherit_parent`: Check parent directories for associations\n\n## Dependencies\n- Profile Health Foundation (for status display)\n\n## Future Enhancements\n- Git remote-based associations\n- Team-shared associations (via git)\n- IDE integrations","status":"closed","priority":3,"issue_type":"epic","created_at":"2025-12-17T16:16:44.984411767-05:00","updated_at":"2025-12-17T20:46:42.732418376-05:00","closed_at":"2025-12-17T20:46:42.732418376-05:00","close_reason":"Fully implemented: project association storage (store.go with Resolve, glob patterns, parent directory inheritance), CLI commands (project set/list/show/remove/clear), activate integration (resolveActivateProfile). All tests pass.","dependencies":[{"issue_id":"caam-wuc","depends_on_id":"caam-3am","type":"blocks","created_at":"2025-12-17T16:26:58.772622139-05:00","created_by":"ubuntu"}]}
{"id":"caam-x0g","title":"Profile Health Foundation","description":"# Profile Health Foundation\n\n## Purpose\nEstablish the infrastructure for tracking and displaying profile health status. This is the foundation that token refresh and health display features build upon.\n\n## Background (from codex-pool)\ncodex-pool uses a sophisticated scoring algorithm:\n```go\nscore = headroom * planBonus * creditBonus - penalty\n```\n\nFor caam v1, we simplify to status tiers (üü¢üü°üî¥) with numeric scores as internal implementation.\n\n## What This Epic Delivers\n1. Health metadata storage format and persistence\n2. Token expiry parsing for all three providers\n3. Health status calculation logic\n4. Penalty tracking with decay\n\n## Design Decisions\n\n### Status Tiers (User-Facing)\n| Status | Icon | Meaning |\n|--------|------|---------|\n| Healthy | üü¢ | Token valid \u003e1hr, no recent errors |\n| Warning | üü° | Token expiring \u003c1hr OR recent errors |\n| Critical | üî¥ | Token expired OR many recent errors |\n| Unknown | ‚ö™ | Cannot determine status |\n\n### Health Factors (Internal Scoring)\n1. Token expiry: +1.0 (\u003e1hr), +0.5 (15-60min), 0 (\u003c15min), -1.0 (expired)\n2. Recent errors: +0.3 (none), 0 (1-2), -0.5 (3+)\n3. Plan type bonus: +0.2 (pro), +0.3 (enterprise)\n\n### Penalty Decay (from codex-pool)\n```go\n// Every 5 minutes:\npenalty *= 0.8\nif penalty \u003c 0.01 { penalty = 0 }\n```\nThis prevents permanent blacklisting while discouraging repeated use of problematic profiles.\n\n## Storage Format\n```json\n// ~/.caam/health.json\n{\n  \"profiles\": {\n    \"claude/work@company.com\": {\n      \"token_expires_at\": \"2025-12-17T18:00:00Z\",\n      \"last_error\": \"2025-12-17T15:30:00Z\",\n      \"error_count_1h\": 2,\n      \"penalty\": 0.3,\n      \"penalty_updated_at\": \"2025-12-17T15:35:00Z\",\n      \"plan_type\": \"pro\",\n      \"last_checked\": \"2025-12-17T16:00:00Z\"\n    }\n  },\n  \"version\": 1\n}\n```\n\n## Dependencies\n- None (foundation layer)\n\n## Blocks\n- Token Refresh (needs expiry info)\n- Health Display (needs status calculation)\n- Penalty Decay (needs penalty storage)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-17T16:16:17.755807834-05:00","updated_at":"2025-12-17T20:43:02.819075085-05:00","closed_at":"2025-12-17T20:43:02.819075085-05:00","close_reason":"Fully implemented by previous agents: health storage (storage.go), token expiry parsing for all providers (expiry.go), health status calculation (status.go), penalty decay (penalty.go), CLI integration (root.go status/ls commands), formatting (format.go). All tests pass.","dependencies":[{"issue_id":"caam-x0g","depends_on_id":"caam-3am","type":"blocks","created_at":"2025-12-17T16:26:38.348841528-05:00","created_by":"ubuntu"}]}
{"id":"caam-y49","title":"Implement 'init' command for guided setup","description":"## Task\nAdd 'caam init' command for first-time setup.\n\n## What it does\n1. Creates data directories (~/.local/share/caam/{vault,profiles})\n2. Creates default config file\n3. Detects installed CLI tools\n4. Optionally walks user through creating first profile\n\n## Interactive Flow\n```\n$ caam init\n\nWelcome to caam - Coding Agent Account Manager!\n\nCreating directories...\n  Created ~/.local/share/caam/vault\n  Created ~/.local/share/caam/profiles\n\nDetecting CLI tools...\n  ‚úì codex found\n  ‚úì claude found\n  ‚úó gemini not found\n\nWould you like to create your first profile? [Y/n]\n\u003e y\n\nWhich tool? (codex/claude/gemini)\n\u003e claude\n\nProfile name (e.g., work, personal, account-1)\n\u003e work\n\nCreated profile claude/work\n\nNext steps:\n  caam login claude work   # Authenticate\n  caam backup claude work  # Save auth to vault\n```\n\n## Flags\n- --quiet: Non-interactive, just create directories\n- --force: Overwrite existing config\n\n## Acceptance Criteria\n- Creates necessary directories\n- Detects installed tools\n- Optional guided profile creation\n- Idempotent (safe to run multiple times)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T00:55:08.611338867-05:00","updated_at":"2025-12-17T01:40:02.199671201-05:00","closed_at":"2025-12-17T01:40:02.199671201-05:00","close_reason":"Implemented 'caam init' command for first-time setup: creates directories, detects CLI tools, shows next steps. Includes --quiet flag.","dependencies":[{"issue_id":"caam-y49","depends_on_id":"caam-1ba","type":"parent-child","created_at":"2025-12-17T00:55:08.625375856-05:00","created_by":"ubuntu"}]}
{"id":"caam-ypx","title":"Add browser profile config to Profile struct","description":"## Task\nAdd fields to the Profile struct (internal/profile/profile.go) to store browser configuration:\n- BrowserCommand: string (e.g., 'google-chrome', 'firefox', or full path)\n- BrowserProfileDir: string (e.g., 'Profile 1' for Chrome, or full path)\n- BrowserProfileName: string (human-friendly name like 'Work Google')\n\n## Rationale\nThese fields allow each caam profile to be associated with a specific browser profile. When OAuth flows need to open a browser, we can launch the correct browser profile that already has the right Google/GitHub account logged in.\n\n## Implementation Notes\n- Add to Profile struct in internal/profile/profile.go\n- Add to JSON serialization\n- Consider making these optional (empty = use system default)\n- Update profile.json schema\n\n## Acceptance Criteria\n- Profile struct has browser config fields\n- Fields serialize/deserialize correctly\n- Existing profiles without these fields still load (backwards compatible)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T00:50:00.728787825-05:00","updated_at":"2025-12-17T01:14:47.055352233-05:00","closed_at":"2025-12-17T01:14:47.055352233-05:00","close_reason":"Added BrowserCommand, BrowserProfileDir, BrowserProfileName fields to Profile struct with omitempty tags for backwards compatibility. Added HasBrowserConfig() and BrowserDisplayName() helper methods.","dependencies":[{"issue_id":"caam-ypx","depends_on_id":"caam-4eg","type":"parent-child","created_at":"2025-12-17T00:50:00.742110459-05:00","created_by":"ubuntu"}]}
{"id":"caam-zha","title":"Profile export/import for cross-machine transfer","description":"# Profile Export/Import for Cross-Machine Transfer\n\n## What\n\nAdd \\`caam export\\` and \\`caam import\\` commands to easily transfer profiles between machines.\n\n## Why - This is the UNIVERSAL headless solution\n\nThe most caam-native way to set up headless servers:\n\n1. Login on machine with browser (laptop, workstation)\n2. \\`caam export codex/work \u003e profile.tar.gz\\`\n3. \\`scp profile.tar.gz user@server:~\\`\n4. On server: \\`caam import profile.tar.gz\\`\n5. \\`caam activate codex work\\` - instant, no login needed!\n\nThis works for **ALL providers** (Codex, Claude, Gemini) because it transfers the auth FILES, not worrying about login mechanisms.\n\n## Commands\n\n### caam export\n\n\\`\\`\\`bash\n# Export single profile\ncaam export codex/work \u003e codex-work.tar.gz\ncaam export codex work -o codex-work.tar.gz\n\n# Export all profiles for a tool\ncaam export codex --all \u003e codex-all.tar.gz\n\n# Export entire vault\ncaam export --all \u003e full-vault.tar.gz\n\\`\\`\\`\n\n### caam import\n\n\\`\\`\\`bash\n# Import from file\ncaam import codex-work.tar.gz\n\n# Import from stdin (for piping)\ncat codex-work.tar.gz | caam import -\n\n# Import with rename\ncaam import codex-work.tar.gz --as codex/server-work\n\\`\\`\\`\n\n## Implementation\n\n### Export format\n\nTar.gz containing:\n- Profile directory structure from vault\n- Metadata file with export timestamp, source machine, caam version\n- Checksum for integrity\n\n### File: cmd/caam/cmd/export.go\n\n\\`\\`\\`go\nvar exportCmd = \u0026cobra.Command{\n    Use:   \"export \u003ctool/profile\u003e\",\n    Short: \"Export profile(s) for transfer to another machine\",\n    Long: \\`Export profile auth files for transfer to another machine.\n\nThis is the recommended way to set up profiles on headless servers:\n1. Login normally on a machine with a browser\n2. Export the profile: caam export codex/work \u003e profile.tar.gz\n3. Transfer to headless server: scp profile.tar.gz server:\n4. Import on server: caam import profile.tar.gz\n5. Activate: caam activate codex work\n\nThe exported file contains only the auth credentials, not session state.\\`,\n    RunE: runExport,\n}\n\\`\\`\\`\n\n## Security Considerations\n\n- Exported files contain sensitive OAuth tokens\n- Recommend encrypting with gpg for transfer: \\`caam export ... | gpg -c \u003e profile.tar.gz.gpg\\`\n- Add --encrypt flag for built-in encryption (nice-to-have)\n- Document that exported tokens should be treated like passwords\n\n## Acceptance Criteria\n\n- [ ] \\`caam export codex/work\\` produces valid tar.gz\n- [ ] \\`caam import profile.tar.gz\\` restores profile correctly\n- [ ] Imported profile can be activated immediately\n- [ ] Works for all providers (codex, claude, gemini)\n- [ ] Handles name conflicts gracefully (--force or --as)\n\n## Why This is Better Than Device Code\n\n| Aspect | Device Code | Export/Import |\n|--------|-------------|---------------|\n| Works for Codex | ‚úÖ | ‚úÖ |\n| Works for Claude | ‚ùå (buggy setup-token) | ‚úÖ |\n| Works for Gemini | ‚ö†Ô∏è (recent, untested) | ‚úÖ |\n| Leverages caam's core strength | ‚ùå | ‚úÖ |\n| One-time setup | Login each server | Login once, transfer |\n| Implementation complexity | Medium | Low |","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-17T18:05:19.598114513-05:00","updated_at":"2025-12-17T18:43:22.039830895-05:00","closed_at":"2025-12-17T18:43:22.039830895-05:00","close_reason":"Implemented `caam export`/`caam import` for vault transfer (tar.gz) with manifest + sha256 checksums, conflict handling (--force, --as), atomic import via temp dir + rename, and unit tests. Added Vault.BasePath() accessor.","comments":[{"id":4,"issue_id":"caam-zha","author":"ubuntu","text":"Starting work on export/import. Plan: add  +  commands (tar.gz), include metadata + checksum, handle stdin/stdout and name conflicts, add tests. Will keep it minimal + safe (tokens treated as secrets).","created_at":"2025-12-17T23:30:39Z"},{"id":5,"issue_id":"caam-zha","author":"ubuntu","text":"Starting work on export/import. Plan: add `caam export` + `caam import` commands (tar.gz), include metadata + checksum, handle stdin/stdout and name conflicts, add tests. Tokens are secrets; docs will recommend encrypting tarballs.","created_at":"2025-12-17T23:30:53Z"},{"id":7,"issue_id":"caam-zha","author":"ubuntu","text":"Implemented export/import and landed to main. Usage: `caam export codex/work \u003e profile.tar.gz` (or `-o file`), `caam export --all \u003e full-vault.tar.gz`, then on target machine `caam import profile.tar.gz` (or `cat ... | caam import -`). Import verifies SHA256 checksums and is atomic per profile; supports `--force` and single-profile rename via `--as codex/server-work`.","created_at":"2025-12-17T23:44:56Z"}]}
{"id":"caam-zti","title":"Smart auto-backup before switch","description":"Prevent accidental data loss when switching profiles.\n\n## The Problem\nUser modifies their auth (e.g., logs into new account in browser), then runs `caam activate foo`. Their unsaved changes are lost because the current state doesn't match any vault profile.\n\n## Solution\nBefore restoring a profile, check if current auth state is 'unsaved':\n1. Hash current auth files\n2. Compare with all vault profiles\n3. If NO MATCH ‚Üí current state would be lost\n4. Auto-backup to `_backup_\u003cYYYYMMDD_HHMMSS\u003e` profile\n5. Continue with normal activate\n\n## Config Option\n```yaml\nsafety:\n  auto_backup_before_switch: smart  # 'always' | 'smart' | 'never'\n  max_auto_backups: 5  # Keep last N auto-backups, delete older\n```\n\n- 'smart': Only backup if state doesn't match any profile (default)\n- 'always': Always backup before switch (creates many profiles)\n- 'never': Skip (for power users who know what they're doing)\n\n## Auto-backup Rotation\nWhen max_auto_backups exceeded:\n1. List all _backup_* profiles for the tool\n2. Sort by timestamp (oldest first)\n3. Delete oldest until count \u003c= max\n\n## Implementation\n1. Add Vault.CurrentStateMatchesAny(fileSet) method\n2. Add Vault.BackupCurrent(fileSet) -\u003e '_backup_\u003ctimestamp\u003e'\n3. Add auto-backup rotation logic\n4. Modify activate command to check config and call BackupCurrent\n5. Print: 'Auto-backed up current state to _backup_20251217_143022'\n\n## Files\n- internal/authfile/authfile.go: New methods\n- cmd/caam/cmd/activate.go: Add smart backup logic\n- internal/config/spm_config.go: Add config options","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T21:44:52.070068986-05:00","updated_at":"2025-12-17T21:44:52.070068986-05:00","dependencies":[{"issue_id":"caam-zti","depends_on_id":"caam-nh8","type":"blocks","created_at":"2025-12-17T21:45:04.238174857-05:00","created_by":"ubuntu"},{"issue_id":"caam-zti","depends_on_id":"caam-3w5","type":"blocks","created_at":"2025-12-17T21:45:09.347228092-05:00","created_by":"ubuntu"}],"comments":[{"id":52,"issue_id":"caam-zti","author":"ubuntu","text":"[ubuntu at 2025-12-18]\nFYI caam-nh8 is now closed: `_` prefix reserved for system vault profiles; delete requires --force; ls shows [system]; meta.json now includes {type, created_by}. Useful for _backup_* rotation work.","created_at":"2025-12-18T03:48:31Z"}]}
